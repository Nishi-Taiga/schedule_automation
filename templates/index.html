<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
<title>ãƒ–ãƒ¼ã‚¹è¡¨è‡ªå‹•ç”Ÿæˆ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&family=Outfit:wght@400;600;700;800&display=swap');
:root{--ink:#1b2838;--ink2:#3d4f63;--ink3:#6b7f95;--bg:#f4f6f9;--card:#fff;--accent:#2563eb;--accent2:#1d4ed8;--green:#059669;--red:#dc2626;--orange:#ea580c;--border:#e2e8f0;--radius:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Zen Kaku Gothic New','Hiragino Kaku Gothic ProN',sans-serif;background:var(--bg);color:var(--ink);line-height:1.5;min-height:100vh}
.header{background:var(--ink);color:#fff;padding:18px 28px}
.header h1{font-family:'Outfit',sans-serif;font-weight:800;font-size:21px}
.header p{font-size:12px;opacity:.6;margin-top:2px}
.container{max-width:1400px;margin:0 auto;padding:20px 16px}
.steps{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.step-btn{padding:7px 20px;border-radius:20px;border:none;cursor:pointer;font-weight:600;font-size:12.5px;font-family:inherit;transition:all .15s}
.step-btn.active{background:var(--accent);color:#fff}
.step-btn:not(.active){background:#dde3ea;color:var(--ink2)}
.card{background:var(--card);border-radius:var(--radius);padding:24px 28px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:16px}
.card h2{font-size:16px;margin-bottom:16px;font-weight:700}
.card h3{font-size:14px;margin:20px 0 10px;font-weight:700;color:var(--ink2)}
.upload-row{display:flex;align-items:center;gap:14px;padding:14px 18px;border:2px dashed var(--border);border-radius:10px;cursor:pointer;margin-bottom:10px;background:#fafbfc;transition:all .15s}
.upload-row:hover{border-color:var(--accent);background:#f0f5ff}
.upload-row.done{border-color:var(--green);background:#f0fdf4}
.upload-row .icon{font-size:26px}.upload-row .label{font-weight:600;font-size:13.5px}
.upload-row .desc{font-size:11.5px;color:var(--ink3)}.upload-row input{display:none}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.si{background:#f7f9fb;padding:10px 12px;border-radius:8px}
.si label{font-weight:600;font-size:13px;display:block;margin-bottom:4px}
.si input,.si select{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit}
.bp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.bp-item{display:flex;align-items:center;gap:8px;background:#f7f9fb;padding:8px 12px;border-radius:8px}
.bp-item select{padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit}
.btn{padding:10px 24px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:13.5px;font-family:inherit;transition:all .15s}
.btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:var(--accent2)}
.btn-g{background:var(--green);color:#fff}.btn-g:hover{background:#047857}
.btn-o{background:#fff;border:1px solid var(--border);color:var(--ink2)}.btn-o:hover{background:#f7f9fb}
.btn-s{background:#7c3aed;color:#fff;font-size:12px;padding:5px 12px}.btn-s:hover{background:#6d28d9}
.btn:disabled{opacity:.4;cursor:default}
.bg{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
.status{margin-top:12px;font-size:12.5px;color:var(--ink2)}.status.err{color:var(--red)}
.summary{display:flex;gap:20px;align-items:center;flex-wrap:wrap;padding:16px 0}
.big-num{font-family:'Outfit',sans-serif;font-size:34px;font-weight:800;color:var(--accent)}
.big-num span{font-size:15px;font-weight:400;color:var(--ink3)}
.rate{font-size:12px;color:var(--ink3)}
.badge-w{background:#fef2f2;color:var(--red);padding:6px 14px;border-radius:8px;font-size:12.5px}
.badge-m{background:#fff7ed;color:var(--orange);padding:6px 14px;border-radius:8px;font-size:12.5px}
.wt{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap}
.wt button{padding:7px 16px;border-radius:7px;border:none;cursor:pointer;font-weight:600;font-size:12px;font-family:inherit}
.wt button.active{background:var(--accent);color:#fff}
.wt button:not(.active){background:#e2e8f0;color:var(--ink2)}
.wt button.warn{background:#fee2e2;color:var(--red)}.wt button.warn.active{background:var(--red);color:#fff}
.wt button.cal{background:#e0f2fe;color:#0369a1}.wt button.cal.active{background:#0284c7;color:#fff}
.tw{overflow-x:auto}
table.sch{width:100%;border-collapse:collapse;font-size:11px;min-width:920px;table-layout:fixed}
table.sch th{padding:7px 5px;border-bottom:2px solid var(--border);text-align:left;font-size:11.5px;font-weight:700;background:#f7f9fb;position:sticky;top:0}
table.sch td{padding:2px 4px;border-bottom:1px solid #eef1f5;vertical-align:top;overflow:hidden}
.tc{font-weight:700;font-size:11.5px;background:#f0f3f7;text-align:center;vertical-align:middle}
.bc{text-align:center;font-size:12px;color:var(--accent2);font-weight:700;width:32px;background:#eef3fb;border-right:2px solid #c5d5e8}
.or td{font-weight:700;background:#ebf1ff;text-align:center;font-size:12px;color:var(--accent)}
.cd{background:#f0f0f0}
tr.er{background:#f5f7fa}
.tn{display:block;font-weight:600;color:var(--accent2);font-size:11px;margin-bottom:2px;cursor:grab;padding:1px 4px;border-radius:3px;border:1px solid transparent;transition:all .12s;user-select:none;width:100%;text-align:center}
.tn:hover{background:#e0e7ff;border-color:#93c5fd}.tn:active{cursor:grabbing}
.tn.drag-over-t{background:#dbeafe;border-color:var(--accent)}
.slot-chip{display:flex;align-items:center;gap:3px;border-radius:5px;padding:1px 6px;margin:1px 0;font-size:10px;cursor:grab;user-select:none;transition:all .12s;width:100%;background:#e8f5e9;border:1px solid #a5d6a7}
.slot-chip:active{cursor:grabbing}.slot-chip:hover{background:#c8e6c9;border-color:#66bb6a}
.slot-chip .g{color:#78909c;font-size:9px}.slot-chip .s{font-weight:600;color:#2e7d32;cursor:pointer;text-decoration:underline dotted transparent;transition:text-decoration .2s}.slot-chip .s:hover{text-decoration-color:#2e7d32}
.slot-chip .j{color:#558b2f;font-size:9px}
.slot-chip.ng{background:#ffebee;border-color:#e57373}.slot-chip.ng .s{color:#c62828}
.booth-cell{min-height:34px;position:relative;transition:background .12s;display:flex;flex-direction:column;align-items:stretch;padding:2px 3px;border-left:1px solid #d8dfe8;border-bottom:1px solid #d8dfe8}
.booth-cell.drag-over{background:#e3f2fd !important;outline:2px dashed var(--accent);outline-offset:-2px}
.booth-cell.full{background:#fff3e0}
.booth-cell.empty-booth{background:#fafbfc}.booth-cell.empty-booth .tn{opacity:.3;font-size:9px;border:1px dashed #ccc}
.unplaced-zone{min-height:60px;border:2px dashed var(--border);border-radius:8px;padding:8px 10px;display:flex;flex-wrap:wrap;gap:4px;transition:all .12s;margin-top:6px}
.unplaced-zone.drag-over{border-color:var(--red);background:#fef2f2}
.unplaced-zone .slot-chip{background:#ffebee;border-color:#ef9a9a}.unplaced-zone .slot-chip .s{color:#c62828}
.unplaced-label{font-size:11px;color:var(--ink3);margin-top:10px;font-weight:600}
table.up{width:100%;border-collapse:collapse;font-size:13px}
table.up th{padding:8px 10px;border-bottom:2px solid var(--border);text-align:left;font-weight:700;background:#f7f9fb}
table.up td{padding:6px 10px;border-bottom:1px solid #eef1f5}
table.up .ct{font-weight:700;color:var(--red)}
.ap{color:var(--green);font-weight:600;font-size:14px}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.note{font-size:11.5px;color:var(--ink3);margin-top:6px;padding:8px 12px;background:#f7f9fb;border-radius:6px;border-left:3px solid var(--accent)}
.file-note{font-size:11px;color:var(--ink3);margin-top:4px;padding-left:54px}
.edit-hint{font-size:11px;color:var(--orange);font-weight:600}
/* Calendar */
.cal-sel{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.cal-sel select{padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit}
.cal-tbl{width:100%;border-collapse:collapse;font-size:12px}
.cal-tbl th{padding:8px 6px;background:#f0f7ff;border:1px solid #d1e3f6;text-align:center;font-weight:700;color:var(--accent2)}
.cal-tbl td{padding:4px 6px;border:1px solid #e2e8f0;vertical-align:top;min-height:40px;min-width:80px}
.cal-tbl .cal-date{font-weight:700;font-size:11px;color:var(--ink2);margin-bottom:2px}
.cal-slot{font-size:10px;padding:2px 6px;background:#e8f5e9;border:1px solid #a5d6a7;border-radius:4px;margin:2px 0;display:flex;align-items:center;gap:3px;cursor:pointer;user-select:none;transition:all .12s}
.cal-slot:hover{background:#c8e6c9;border-color:#66bb6a}
.cal-slot.ng{background:#ffebee;border-color:#e57373}
.cal-drop{min-height:28px;transition:background .12s;border-radius:4px}
.cal-drop.drag-over{background:#e3f2fd;outline:2px dashed var(--accent);outline-offset:-2px}
.cal-empty{color:#ccc;font-size:10px}
/* Modal */
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal{background:#fff;border-radius:12px;padding:24px;min-width:300px;max-width:90vw;box-shadow:0 8px 30px rgba(0,0,0,.2)}
.modal h3{margin-bottom:12px;font-size:15px}
.modal-opts{display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto}
.modal-opt{padding:10px 14px;border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;font-family:inherit;transition:all .1s;display:flex;justify-content:space-between;align-items:center}
.modal-opt:hover{background:#f0f5ff;border-color:var(--accent)}
.modal-opt .t-name{font-weight:600}.modal-opt .t-info{font-size:11px;color:var(--ink3)}
.modal-cancel{margin-top:12px;text-align:right}
/* Progress overlay */
.progress-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center}
.progress-box{background:#fff;border-radius:16px;padding:36px 44px;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,.25);min-width:320px;max-width:400px}
.progress-spinner{width:44px;height:44px;border:4px solid #e2e8f0;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
.progress-title{font-size:16px;font-weight:700;color:var(--ink);margin-bottom:10px}
.progress-bar-wrap{width:100%;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin-bottom:10px}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);border-radius:4px;transition:width .4s ease;width:0%}
.progress-pct{font-family:'Outfit',sans-serif;font-size:28px;font-weight:700;color:var(--accent);margin-bottom:4px}
.progress-msg{font-size:13px;color:var(--ink3);line-height:1.6}
</style>
</head>
<body>
<div class="header"><div><h1>ğŸ“‹ ãƒ–ãƒ¼ã‚¹è¡¨è‡ªå‹•ç”Ÿæˆ</h1><p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è¨­å®š â†’ ç”Ÿæˆ â†’ æ‰‹å‹•èª¿æ•´ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p></div></div>
<div class="container">
<div class="steps">
<button class="step-btn active" id="sb1" onclick="go('upload')">1. ãƒ•ã‚¡ã‚¤ãƒ«</button>
<button class="step-btn" id="sb2" onclick="go('settings')">2. è¨­å®š</button>
<button class="step-btn" id="sb3" onclick="go('result')">3. çµæœ</button>
</div>
<div id="pUpload" class="card">
<h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
<label class="upload-row" id="uSrc"><div class="icon">ğŸ“</div><div><div class="label">ãƒ–ãƒ¼ã‚¹è¡¨å…ƒã‚·ãƒ¼ãƒˆ (.xlsx)</div><div class="desc" id="nSrc">å‡ºå‹¤å¯èƒ½è¬›å¸«ã®ä¸€è¦§</div></div><input type="file" accept=".xlsx" onchange="onF(this,'src')"></label>
<label class="upload-row" id="uBooth"><div class="icon">ğŸ“</div><div><div class="label">ãƒ–ãƒ¼ã‚¹è¡¨ (.xlsx)</div><div class="desc" id="nBooth">ç”Ÿå¾’æƒ…å ±ãƒ»è¬›å¸«æŒ‡å°å¯èƒ½ç§‘ç›®ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div></div><input type="file" accept=".xlsx" onchange="onF(this,'booth')"></label>
<div class="file-note">â€» ãƒ–ãƒ¼ã‚¹è¡¨ã«ã€Œå¿…è¦ã‚³ãƒæ•°ã€ã€Œä¸€è¦§è¡¨ã€ã€Œè¬›å¸«ãƒ–ãƒ¼ã‚¹å¸Œæœ›ã€ã‚·ãƒ¼ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</div>
<div class="bg"><button class="btn btn-p" id="toS" disabled onclick="go('settings')">æ¬¡ã¸: è¨­å®š â†’</button></div>
<div class="status" id="upSt"></div>
</div>
<div id="pSettings" class="card" style="display:none">
<h2>æ•™å®¤æ¥­å‹™ãƒ»ãƒãƒ¥ãƒ¼ã‚¿ãƒ¼æ‹…å½“</h2>
<p style="font-size:12.5px;color:var(--ink3);margin-bottom:14px">å„æ›œæ—¥ã®æ•™å®¤æ¥­å‹™/ãƒãƒ¥ãƒ¼ã‚¿ãƒ¼æ‹…å½“è¬›å¸«</p>
<div class="sg" id="oGrid"></div>
<h3>ğŸª‘ è¬›å¸«ãƒ–ãƒ¼ã‚¹å¸Œæœ›</h3>
<p style="font-size:12.5px;color:var(--ink3);margin-bottom:10px">ãƒ–ãƒ¼ã‚¹è¡¨ã®ã€Œè¬›å¸«ãƒ–ãƒ¼ã‚¹å¸Œæœ›ã€ã‚·ãƒ¼ãƒˆã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿ã€‚ã“ã“ã§å¤‰æ›´ã‚‚å¯èƒ½ã€‚</p>
<div class="bp-grid" id="bpGrid"></div>
<div style="margin-top:8px"><button class="btn btn-s" onclick="addBP()">ï¼‹ è¬›å¸«è¿½åŠ </button></div>
<div class="note">â€» ãƒ–ãƒ¼ã‚¹â‘¥ã¾ã§ã€‚æ•™å®¤æ¥­å‹™æ‹…å½“ã¯ãƒ–ãƒ¼ã‚¹ã‹ã‚‰é™¤å¤–ã€‚NGè¬›å¸«ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§èµ¤ãè¡¨ç¤ºã€‚</div>
<div class="bg">
<button class="btn btn-o" onclick="go('upload')">â† æˆ»ã‚‹</button>
<button class="btn btn-g" id="genBtn" onclick="gen()">ğŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ</button>
</div>
<div class="status" id="stTxt"></div>
</div>
<div id="pResult" style="display:none">
<div class="card">
<div class="summary">
<div><div class="big-num" id="pNum">0<span>/0ã‚³ãƒ</span></div><div class="rate" id="rTxt"></div></div>
<div id="uBadge" class="badge-w" style="display:none"></div>
<div id="mBadge" class="badge-m" style="display:none"></div>
<div style="flex:1"></div>
<button class="btn btn-p" onclick="dlExcel()">ğŸ“¥ ãƒ–ãƒ¼ã‚¹è¡¨DL</button>
<button class="btn btn-o" onclick="go('settings')">â†» å†ç”Ÿæˆ</button>
</div>
<div class="edit-hint">âœ‹ è¬›å¸«åãƒ»ç”Ÿå¾’ãƒãƒƒãƒ—ã‚’D&Dã§ç§»å‹•ã€‚ç”Ÿå¾’åã‚¯ãƒªãƒƒã‚¯â†’å€‹äººã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã®æˆæ¥­ã‚¯ãƒªãƒƒã‚¯â†’è¬›å¸«/æ™‚é–“å¤‰æ›´ã€‚<span style="color:var(--red)">èµ¤ï¼NG</span></div>
</div>
<div class="wt" id="wTabs"></div>
<div class="card"><div class="tw" id="pWrap"></div></div>
</div>
</div>
<div id="modalRoot"></div>
<script>
const D=['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'],WT=['16:00','17:05','18:10','19:15','20:20'],ST=['14:55','16:00','17:05','18:10'];
const TL=['14:55','16:00','17:05','18:10','19:15','20:20'],TS={'14:55':'14','16:00':'16','17:05':'17','18:10':'18','19:15':'19','20:20':'20'},TSR={'14':'14:55','16':'16:00','17':'17:05','18':'18:10','19':'19:15','20':'20:20'},BL=['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥'];
let OR={æœˆ:['çŸ³å·T'],ç«:['çŸ³å·T'],æ°´:['è¥¿T'],æœ¨:['çŸ³å·T'],é‡‘:['çŸ³å·T'],åœŸ:['è¶Šæ™ºT']};
let BP=[],R=null,PW=0,uploaded={},edited=false,dragData=null,calStudent=null,teacherList=[];
let ngMap={},ngStudentMap={};
function buildNgMap(){ngMap={};ngStudentMap={};if(!R||!R.students)return;R.students.forEach(s=>{ngMap[s.name]=new Set(s.ng_teachers||[]);ngStudentMap[s.name]=new Set(s.ng_students||[])});}
function isNg(n,t){return ngMap[n]&&ngMap[n].has(t);}
function isNgStudent(a,b){return(ngStudentMap[a]&&ngStudentMap[a].has(b))||(ngStudentMap[b]&&ngStudentMap[b].has(a));}
function isAdjacentNg(wi,day,ts,bi,sn){const bs=R.schedule[wi]?.[day]?.[ts];if(!bs)return false;for(const a of[bi-1,bi+1]){if(a<0||a>=bs.length)continue;for(const sl of bs[a].slots){if(isNgStudent(sn,sl[1]))return true;}}return false;}

async function onF(inp,key){const f=inp.files[0];if(!f)return;const row=inp.closest('.upload-row');row.querySelector('.desc').textContent='ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';row.classList.remove('done');row.querySelector('.icon').textContent='ğŸ“„';const fd=new FormData();fd.append(key,f);
try{const res=await fetch('/api/upload',{method:'POST',body:fd});const d=await res.json();if(res.ok&&d.ok){row.classList.add('done');row.querySelector('.icon').textContent='âœ…';row.querySelector('.desc').textContent=f.name;uploaded[key]=true;}else{const msg=d.error||'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ (HTTP '+res.status+')';row.querySelector('.icon').textContent='âŒ';row.querySelector('.desc').textContent='å¤±æ•—: '+msg;console.error('[upload]',key,res.status,msg);uploaded[key]=false;}}catch(e){row.querySelector('.icon').textContent='âŒ';row.querySelector('.desc').textContent='é€šä¿¡ã‚¨ãƒ©ãƒ¼: '+e.message;console.error('[upload]',key,e);uploaded[key]=false;}
const ready=uploaded.src&&uploaded.booth;document.getElementById('toS').disabled=!ready;
if(ready){try{const r=await fetch('/api/teachers');const d=await r.json();if(d.teachers)teacherList=d.teachers;if(d.boothPref)BP=Object.entries(d.boothPref).map(([t,b])=>({teacher:t,booth:b}));}catch(e){}}}

function go(step){document.getElementById('pUpload').style.display=step==='upload'?'':'none';document.getElementById('pSettings').style.display=step==='settings'?'':'none';document.getElementById('pResult').style.display=step==='result'?'':'none';
for(const[k,id]of[['upload','sb1'],['settings','sb2'],['result','sb3']])document.getElementById(id).className='step-btn'+(step===k?' active':'');if(step==='settings')buildSettingsUI();}
function buildSettingsUI(){const g=document.getElementById('oGrid');g.innerHTML='';
const opts=teacherList.length?[...teacherList]:['çŸ³å·T','è¥¿T','è¶Šæ™ºT','å¯’æ²³æ±ŸT','è‹¥æ—T','éš†æ–—T','ç‘ ç’ƒT','ç”°æ‘T','ç²‰å·T','å¹³ç•‘T','å¾Œè—¤T','æ¸¡é‚‰T','æ©‹æœ¬T','å°å±±T','äº•ä¸ŠT','è—¤åŸT','é£¯æ‘T'];
const optSet=new Set(opts);for(const d of D){(OR[d]||[]).forEach(c=>{if(c&&!optSet.has(c)){opts.push(c);optSet.add(c);}});}
for(const d of D){const div=document.createElement('div');div.className='si';
if(!Array.isArray(OR[d]))OR[d]=[OR[d]||'çŸ³å·T'];
let html='<label>'+d+'æ›œ</label>';
OR[d].forEach((c,i)=>{
const selHtml=opts.map(t=>'<option value="'+t+'"'+(t===c?' selected':'')+'>'+t+'</option>').join('');
html+='<div style="display:flex;gap:4px;margin-bottom:4px;align-items:center"><span style="font-size:11px;color:var(--ink3);min-width:16px">'+(i+1)+'.</span><select style="flex:1" onchange="OR[\''+d+'\']['+i+']=this.value"><option value="">-- é¸æŠ --</option>'+selHtml+'</select>'+(OR[d].length>1?'<button type="button" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:14px" onclick="OR[\''+d+'\'].splice('+i+',1);buildSettingsUI()">âœ•</button>':'')+'</div>';});
html+='<button type="button" style="background:#7c3aed;color:#fff;font-size:11px;padding:3px 8px;border:none;border-radius:4px;cursor:pointer;margin-top:2px" onclick="OR[\''+d+'\'].push(\'\');buildSettingsUI()">ï¼‹ è¿½åŠ </button>';
div.innerHTML=html;g.appendChild(div);}renderBP();}
function renderBP(){const g=document.getElementById('bpGrid');g.innerHTML='';BP.forEach((bp,i)=>{const div=document.createElement('div');div.className='bp-item';
div.innerHTML='<input style="min-width:80px;max-width:100px;padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit;font-weight:600" value="'+bp.teacher+'" onchange="BP['+i+'].teacher=this.value">'
+'<select onchange="BP['+i+'].booth=parseInt(this.value)||0"><option value="0">ãªã—</option>'+[1,2,3,4,5,6].map(n=>'<option value="'+n+'"'+(bp.booth===n?' selected':'')+'>'+BL[n-1]+'</option>').join('')+'</select>'
+'<button style="background:none;border:none;cursor:pointer;font-size:16px;color:var(--red)" onclick="BP.splice('+i+',1);renderBP()">âœ•</button>';g.appendChild(div);});}
function addBP(){BP.push({teacher:'',booth:0});renderBP();}

let progTimer=null;
function showProgress(pct,msg){const root=document.getElementById('modalRoot');
root.innerHTML='<div class="progress-bg"><div class="progress-box"><div class="progress-spinner"></div><div class="progress-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆä¸­</div><div class="progress-pct" id="progPct">'+pct+'%</div><div class="progress-bar-wrap"><div class="progress-bar-fill" id="progBar" style="width:'+pct+'%"></div></div><div class="progress-msg" id="progMsg">'+msg+'</div></div></div>';}
function updateProgress(pct,msg){
const bar=document.getElementById('progBar');if(bar)bar.style.width=pct+'%';
const p=document.getElementById('progPct');if(p)p.textContent=pct+'%';
const el=document.getElementById('progMsg');if(el)el.innerHTML=msg;}
function hideProgress(){if(progTimer){clearInterval(progTimer);progTimer=null;}document.getElementById('modalRoot').innerHTML='';}
function startProgressAnim(){
let pct=10;
progTimer=setInterval(()=>{
if(pct<30)pct+=3;else if(pct<60)pct+=2;else if(pct<85)pct+=1;else if(pct<95)pct+=0.3;
pct=Math.min(pct,95);
const msg=pct<30?'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™':pct<60?'è¬›å¸«é…ç½®ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™':pct<85?'ç”Ÿå¾’ã‚’é…ç½®ã—ã¦ã„ã¾ã™':'æœ€çµ‚èª¿æ•´ã—ã¦ã„ã¾ã™';
updateProgress(Math.round(pct),msg);
},300);}

async function gen(){const st=document.getElementById('stTxt'),btn=document.getElementById('genBtn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>ç”Ÿæˆä¸­...';st.textContent='';st.className='status';
showProgress(5,'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™');startProgressAnim();
const bpObj={};BP.forEach(bp=>{if(bp.teacher&&bp.booth)bpObj[bp.teacher]=bp.booth;});
try{
const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({officeRule:OR,boothPref:bpObj})});const d=await res.json();
if(d.error){hideProgress();st.textContent='ã‚¨ãƒ©ãƒ¼: '+d.error;st.className='status err';
if(d.error.includes('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰')||d.error.includes('ä¸è¶³')||d.error.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')){st.textContent+=' ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';setTimeout(()=>go('upload'),2000);}return;}
updateProgress(100,'å®Œäº†ï¼ '+d.placed+'/'+d.total+'ã‚³ãƒé…ç½®');
await new Promise(r=>setTimeout(r,600));
R=d;PW=0;edited=false;calStudent=null;buildNgMap();
if(d.boothPref)BP=Object.entries(d.boothPref).map(([t,b])=>({teacher:t,booth:b}));
hideProgress();go('result');rR();
}catch(e){hideProgress();st.textContent='ã‚¨ãƒ©ãƒ¼: '+e.message;st.className='status err';}finally{btn.disabled=false;btn.innerHTML='ğŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ';}}

async function dlExcel(){if(edited){await fetch('/api/update_schedule',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({schedule:R.schedule,unplaced:R.unplaced})});}window.location.href='/api/download';}

function countPlaced(){let c=0;for(const w of R.schedule)for(const d of Object.values(w))for(const bs of Object.values(d))for(const b of bs)c+=b.slots.length;return c;}

// Navigate to student calendar
function goStudent(name){const idx=R.students.findIndex(s=>s.name===name);if(idx<0)return;calStudent=idx;PW=-2;rR();}

function rR(){const p=countPlaced();document.getElementById('pNum').innerHTML=p+'<span>/'+R.total+'ã‚³ãƒ</span>';document.getElementById('rTxt').textContent='é…ç½®ç‡ '+(p/R.total*100).toFixed(1)+'%';
const ub=document.getElementById('uBadge'),uT=R.unplaced.reduce((s,u)=>s+u.count,0);if(uT>0){ub.style.display='';ub.textContent='âš ï¸ æœªé…ç½®: '+uT+'ã‚³ãƒ';}else ub.style.display='none';
const mb=document.getElementById('mBadge');if(edited){mb.style.display='';mb.textContent='âœï¸ æ‰‹å‹•ç·¨é›†ã‚ã‚Š';}else mb.style.display='none';
const tabs=document.getElementById('wTabs');tabs.innerHTML='';
for(let w=0;w<4;w++){const b=document.createElement('button');b.className=PW===w?'active':'';b.textContent='ç¬¬'+(w+1)+'é€±';b.onclick=()=>{PW=w;rR();};tabs.appendChild(b);}
const ub2=document.createElement('button');ub2.className='warn'+(PW===-1?' active':'');ub2.textContent='æœªé…ç½®';ub2.onclick=()=>{PW=-1;rR();};tabs.appendChild(ub2);
const cb=document.createElement('button');cb.className='cal'+(PW===-2?' active':'');cb.textContent='ğŸ“… ç”Ÿå¾’åˆ¥';cb.onclick=()=>{PW=-2;rR();};tabs.appendChild(cb);
const wrap=document.getElementById('pWrap');wrap.innerHTML='';if(PW>=0)rW(wrap,PW);else if(PW===-1)rU(wrap);else rCal(wrap);}

// === Teacher D&D ===
function mkTeacher(t,wi,day,ts,bi){const el=document.createElement('span');el.className='tn';el.textContent=t;el.draggable=true;
el.addEventListener('dragstart',e=>{dragData={type:'teacher',wi,day,ts,bi,teacher:t};el.style.opacity='0.4';e.dataTransfer.effectAllowed='move';});
el.addEventListener('dragend',()=>{el.style.opacity='1';dragData=null;});
el.addEventListener('dragover',e=>{if(dragData&&dragData.type==='teacher'&&dragData.wi===wi&&dragData.day===day&&dragData.ts===ts){e.preventDefault();el.classList.add('drag-over-t');}});
el.addEventListener('dragleave',()=>{el.classList.remove('drag-over-t');});
el.addEventListener('drop',e=>{e.preventDefault();el.classList.remove('drag-over-t');doTeacherSwap(wi,day,ts,bi);});
return el;}
function doTeacherSwap(wi,day,ts,tbi){if(!dragData||dragData.type!=='teacher'||dragData.wi!==wi||dragData.day!==day||dragData.ts!==ts||dragData.bi===tbi)return;
const ws=R.schedule[wi],times=day==='åœŸ'?['14','16','17','18']:['16','17','18','19','20'];
for(const t of times){const bs=ws[day]?.[t];if(!bs)continue;const s=bs[dragData.bi],g=bs[tbi];if(s&&g){const tmp=s.teacher;s.teacher=g.teacher;g.teacher=tmp;}}
edited=true;dragData=null;rR();}

// === Student slot ===
function mkChip(slot,wi,day,ts,bi,si,teacher){
const el=document.createElement('div');const ngT=isNg(slot[1],teacher);const ngS=isAdjacentNg(wi,day,ts,bi,slot[1]);const warn=ngT||ngS;
el.className='slot-chip'+(warn?' ng':'');el.draggable=true;
let wt=ngT?'NGè¬›å¸«:'+teacher:'';if(ngS)wt+=(wt?' / ':'')+'NGç”Ÿå¾’ãŒéš£æ¥';
const gSpan='<span class="g">'+slot[0]+'</span>';
const sSpan='<span class="s" onclick="event.stopPropagation();goStudent(\''+slot[1].replace(/'/g,"\\'")+'\')">'+slot[1]+'</span>';
const jSpan='<span class="j">'+slot[2]+'</span>';
el.innerHTML=gSpan+sSpan+jSpan+(warn?'<span style="color:var(--red);font-size:9px">âš </span>':'');
el.title=wt;
el.addEventListener('dragstart',e=>{dragData={type:'booth',wi,day,ts,bi,si,slot};el.style.opacity='0.4';e.dataTransfer.effectAllowed='move';});
el.addEventListener('dragend',()=>{el.style.opacity='1';dragData=null;});return el;}

function mkUnChip(u,ui){const el=document.createElement('div');el.className='slot-chip';el.draggable=true;
el.innerHTML='<span class="g">'+u.grade+'</span><span class="s" onclick="event.stopPropagation();goStudent(\''+u.name.replace(/'/g,"\\'")+'\')">'+u.name+'</span><span class="j">'+u.subject+'</span>';
el.addEventListener('dragstart',e=>{dragData={type:'unplaced',ui,slot:[u.grade,u.name,u.subject]};el.style.opacity='0.4';e.dataTransfer.effectAllowed='move';});
el.addEventListener('dragend',()=>{el.style.opacity='1';dragData=null;});return el;}

function doBooth(wi,day,ts,bi){if(!dragData)return;const ws=R.schedule[wi],booth=ws[day][ts][bi];
if(booth.slots.length<2){
// ç©ºãã‚ã‚Š: é€šå¸¸ã®ç§»å‹•
if(dragData.type==='booth'){if(dragData.wi!==wi||dragData.ts!==ts)return;if(dragData.day===day&&dragData.bi===bi)return;
ws[dragData.day][dragData.ts][dragData.bi].slots.splice(dragData.si,1);booth.slots.push(dragData.slot);}
else if(dragData.type==='unplaced'){const u=R.unplaced[dragData.ui];if(!u||u.count<=0)return;booth.slots.push(dragData.slot);u.count--;if(u.count<=0)R.unplaced.splice(dragData.ui,1);}
else if(dragData.type==='calSlot'){const src=R.schedule[dragData.wi][dragData.day][dragData.ts][dragData.bi];src.slots.splice(dragData.si,1);booth.slots.push(dragData.slot);}
edited=true;dragData=null;rR();return;}
// æº€å¸­: ã‚¹ãƒ¯ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ï¼ˆbooth/calSlotã®ã¿ï¼‰
if(dragData.type==='booth'||dragData.type==='calSlot'){
if(dragData.type==='booth'&&(dragData.wi!==wi||dragData.ts!==ts))return;
if(dragData.day===day&&dragData.bi===bi)return;
if(booth.slots.length===1){doSwapExec(wi,day,ts,bi,0);}
else{showSwapModal(wi,day,ts,bi,booth);}}}

function doUnplaced(){if(!dragData||(dragData.type!=='booth'&&dragData.type!=='calSlot'))return;
const wi=dragData.wi,ws=R.schedule[wi],slot=ws[dragData.day][dragData.ts][dragData.bi].slots.splice(dragData.si,1)[0];
const ex=R.unplaced.find(u=>u.name===slot[1]&&u.subject===slot[2]);if(ex)ex.count++;else R.unplaced.push({grade:slot[0],name:slot[1],subject:slot[2],count:1});
edited=true;dragData=null;rR();}

function showSwapModal(wi,day,ts,bi,booth){
const saved={...dragData};
const root=document.getElementById('modalRoot');
const bg=document.createElement('div');bg.className='modal-bg';
const modal=document.createElement('div');modal.className='modal';
modal.innerHTML='<h3>ğŸ”„ äº¤æ›ã™ã‚‹ç”Ÿå¾’ã‚’é¸æŠ</h3><p style="font-size:12px;color:var(--ink3);margin-bottom:10px">ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ç”Ÿå¾’ã¨å…¥ã‚Œæ›¿ãˆã¾ã™</p>';
const opts=document.createElement('div');opts.className='modal-opts';
booth.slots.forEach((sl,si)=>{
const btn=document.createElement('div');btn.className='modal-opt';
btn.innerHTML='<span class="t-name">'+sl[0]+' '+sl[1]+'</span><span class="t-info">'+sl[2]+'</span>';
btn.onclick=()=>{root.innerHTML='';dragData=saved;doSwapExec(wi,day,ts,bi,si);};
opts.appendChild(btn);});
modal.appendChild(opts);
const cancel=document.createElement('div');cancel.className='modal-cancel';
cancel.innerHTML='<button class="btn btn-o" style="padding:6px 16px;font-size:12px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
cancel.querySelector('button').onclick=()=>{root.innerHTML='';dragData=null;};
modal.appendChild(cancel);bg.appendChild(modal);root.appendChild(bg);
bg.addEventListener('click',e=>{if(e.target===bg){root.innerHTML='';dragData=null;}});}

function doSwapExec(wi,day,ts,bi,targetSi){
if(!dragData)return;
const ws=R.schedule[wi];
const targetBooth=ws[day][ts][bi];
const swappedOut=targetBooth.slots[targetSi];
if(dragData.type==='booth'||dragData.type==='calSlot'){
const srcBooth=R.schedule[dragData.wi][dragData.day][dragData.ts][dragData.bi];
srcBooth.slots.splice(dragData.si,1);
srcBooth.slots.push(swappedOut);
targetBooth.slots[targetSi]=dragData.slot;}
edited=true;dragData=null;rR();}

function rW(wrap,wi){const ws=R.schedule[wi];const tbl=document.createElement('table');tbl.className='sch';
let hd='<thead><tr><th style="width:50px">æ™‚é–“</th><th style="width:32px">B</th>';for(const d of D)hd+='<th style="width:calc((100% - 82px)/6)'+(d==='åœŸ'?';background:#edf2f7':'')+'">'+d+'</th>';
hd+='</tr><tr class="or"><td colspan="2">æ•™å®¤æ¥­å‹™</td>';for(const d of D)hd+='<td>'+((R.officeTeachers[wi]||{})[d]||'')+'</td>';hd+='</tr></thead>';tbl.innerHTML=hd;
const tbody=document.createElement('tbody');
for(const tl of TL){const ts=TS[tl],mx=Math.max(...D.map(d=>(ws[d]?.[ts]||[]).length),1);if(mx<1)continue;
for(let bi=0;bi<mx;bi++){const tr=document.createElement('tr');if(!(bi%2))tr.className='er';if(!bi)tr.style.borderTop='2px solid #b8c5d4';
if(!bi){const td=document.createElement('td');td.className='tc';td.rowSpan=mx;td.textContent=tl;tr.appendChild(td);}
const btd=document.createElement('td');btd.className='bc';btd.textContent=BL[bi]||'';tr.appendChild(btd);
for(const d of D){const dt=d==='åœŸ'?ST:WT;const td=document.createElement('td');
if(!dt.includes(tl)){td.className='cd';tr.appendChild(td);continue;}
td.className='booth-cell';const bs=ws[d]?.[ts]||[],b=bs[bi];
if(b&&b.teacher){if(b.slots.length===0)td.classList.add('empty-booth');
td.appendChild(mkTeacher(b.teacher,wi,d,ts,bi));
b.slots.forEach((sl,si)=>{td.appendChild(mkChip(sl,wi,d,ts,bi,si,b.teacher));});if(b.slots.length>=2)td.classList.add('full');}
td.addEventListener('dragover',e=>{e.preventDefault();if(!dragData)return;const bth=bs[bi];if(!bth||!bth.teacher)return;
if(dragData.type==='teacher')return;
if(dragData.type==='booth'&&(dragData.wi!==wi||dragData.ts!==ts))return;
if(dragData.type==='unplaced'&&bth.slots.length>=2)return;
td.classList.add('drag-over');});
td.addEventListener('dragleave',()=>{td.classList.remove('drag-over');});
td.addEventListener('drop',e=>{e.preventDefault();td.classList.remove('drag-over');if(dragData&&dragData.type!=='teacher')doBooth(wi,d,ts,bi);});
tr.appendChild(td);}tbody.appendChild(tr);}}
tbl.appendChild(tbody);wrap.appendChild(tbl);
const lbl=document.createElement('div');lbl.className='unplaced-label';lbl.textContent='ğŸ“¦ æœªé…ç½®ã‚³ãƒ';wrap.appendChild(lbl);
const zone=document.createElement('div');zone.className='unplaced-zone';
R.unplaced.forEach((u,ui)=>{for(let i=0;i<u.count;i++)zone.appendChild(mkUnChip(u,ui));});
if(!R.unplaced.length)zone.innerHTML='<span style="color:var(--ink3);font-size:11px">âœ… å…¨ã‚³ãƒé…ç½®æ¸ˆã¿</span>';
zone.addEventListener('dragover',e=>{e.preventDefault();if(dragData&&(dragData.type==='booth'||dragData.type==='calSlot'))zone.classList.add('drag-over');});
zone.addEventListener('dragleave',()=>{zone.classList.remove('drag-over');});
zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag-over');doUnplaced();});
wrap.appendChild(zone);}

function rU(wrap){if(!R.unplaced.length){wrap.innerHTML='<p class="ap">âœ… å…¨ã‚³ãƒé…ç½®æ¸ˆã¿</p>';return;}
let h='<table class="up"><thead><tr><th>å­¦å¹´</th><th>ç”Ÿå¾’</th><th>ç§‘ç›®</th><th>æœªé…ç½®æ•°</th></tr></thead><tbody>';
for(const u of R.unplaced)h+='<tr><td>'+u.grade+'</td><td>'+u.name+'</td><td>'+u.subject+'</td><td class="ct">'+u.count+'</td></tr>';h+='</tbody></table>';wrap.innerHTML=h;}

// === Student Calendar ===
function rCal(wrap){
  if(!R||!R.students||!R.students.length){wrap.innerHTML='<p>ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';return;}
  const sel=document.createElement('div');sel.className='cal-sel';
  const lb=document.createElement('span');lb.textContent='ç”Ÿå¾’:';lb.style.fontWeight='600';sel.appendChild(lb);
  const dd=document.createElement('select');dd.id='calSel';
  R.students.forEach((s,i)=>{const o=document.createElement('option');o.value=i;o.textContent=s.grade+' '+s.name;if(calStudent===i)o.selected=true;dd.appendChild(o);});
  dd.onchange=()=>{calStudent=parseInt(dd.value);renderStudentCal();};
  sel.appendChild(dd);wrap.appendChild(sel);
  const cw=document.createElement('div');cw.id='calWrap';wrap.appendChild(cw);
  if(calStudent===null)calStudent=0;
  renderStudentCal();
}

function getStudentSlots(name){
  const slots=[];
  for(let wi=0;wi<4;wi++){for(const day of D){for(const[ts,booths]of Object.entries(R.schedule[wi][day]||{})){
    for(let bi=0;bi<booths.length;bi++){const b=booths[bi];for(let si=0;si<b.slots.length;si++){
      if(b.slots[si][1]===name)slots.push({wi,day,ts,bi,si,grade:b.slots[si][0],subj:b.slots[si][2],teacher:b.teacher});
    }}}}}
  return slots;
}

function renderStudentCal(){
  const s=R.students[calStudent];if(!s)return;
  const cw=document.getElementById('calWrap');if(!cw)return;
  const slots=getStudentSlots(s.name);
  const grid={};slots.forEach(sl=>{const k=sl.wi+'_'+sl.day;if(!grid[k])grid[k]=[];grid[k].push(sl);});
  const tbl=document.createElement('table');tbl.className='cal-tbl';
  let hd='<thead><tr><th style="width:40px">é€±</th>';for(const d of D)hd+='<th>'+d+'</th>';hd+='</tr></thead>';
  tbl.innerHTML=hd;
  const tbody=document.createElement('tbody');
  for(let wi=0;wi<4;wi++){
    const tr=document.createElement('tr');
    const wTd=document.createElement('td');wTd.style.cssText='text-align:center;font-weight:700';wTd.textContent='W'+(wi+1);tr.appendChild(wTd);
    for(const day of D){
      const td=document.createElement('td');td.className='cal-drop';
      const items=grid[wi+'_'+day]||[];
      items.sort((a,b)=>(TSR[a.ts]||'').localeCompare(TSR[b.ts]||''));
      for(const it of items){
        const chip=document.createElement('div');
        const ng=isNg(s.name,it.teacher);
        chip.className='cal-slot'+(ng?' ng':'');chip.draggable=true;
        chip.innerHTML=(TSR[it.ts]||it.ts).slice(0,5)+' '+it.subj+' <span style="font-size:9px;color:'+(ng?'#c62828':'#666')+'">'+it.teacher+'</span>';
        chip.addEventListener('dragstart',e=>{dragData={type:'calSlot',wi:it.wi,day:it.day,ts:it.ts,bi:it.bi,si:it.si,slot:[it.grade,s.name,it.subj]};chip.style.opacity='0.4';e.dataTransfer.effectAllowed='move';});
        chip.addEventListener('dragend',()=>{chip.style.opacity='1';dragData=null;});
        ((it_)=>{chip.addEventListener('click',e=>{e.stopPropagation();showSlotEditModal(s,it_);});})(it);
        td.appendChild(chip);
      }
      if(!items.length){const em=document.createElement('span');em.className='cal-empty';em.textContent='-';td.appendChild(em);}
      // Drop: move into this day/week with teacher selection
      td.addEventListener('dragover',e=>{e.preventDefault();if(dragData&&(dragData.type==='calSlot'||dragData.type==='booth'))td.classList.add('drag-over');});
      td.addEventListener('dragleave',()=>{td.classList.remove('drag-over');});
      ((wi_,day_)=>{
        td.addEventListener('drop',e=>{e.preventDefault();td.classList.remove('drag-over');
          if(!dragData||(dragData.type!=='calSlot'&&dragData.type!=='booth'))return;
          showTeacherModal(wi_,day_,dragData);
        });
      })(wi,day);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);
  cw.innerHTML='';cw.appendChild(tbl);
  const info=document.createElement('div');info.style.cssText='margin-top:8px;font-size:12px;color:var(--ink2)';
  info.innerHTML='åˆè¨ˆ: <b>'+slots.length+'ã‚³ãƒ</b>ã€€<span style="font-size:11px;color:var(--orange)">âœ‹ ã‚¯ãƒªãƒƒã‚¯ã§è¬›å¸«/æ™‚é–“å¤‰æ›´ã€ãƒ‰ãƒ©ãƒƒã‚°ã§åˆ¥ã®æ—¥ã«ç§»å‹•</span>';
  cw.appendChild(info);
}

// === Teacher selection modal ===
function showTeacherModal(targetWi,targetDay,dd){
  const ws=R.schedule[targetWi];
  const dayData=ws[targetDay]||{};
  // Collect available booths with space
  const times=targetDay==='åœŸ'?['14','16','17','18']:['16','17','18','19','20'];
  const options=[];// {ts, bi, teacher, slots_count}
  for(const ts of times){
    const booths=dayData[ts]||[];
    for(let bi=0;bi<booths.length;bi++){
      if(booths[bi].slots.length<2){
        options.push({ts,bi,teacher:booths[bi].teacher,cnt:booths[bi].slots.length,time:TSR[ts]||ts});
      }
    }
  }
  if(!options.length){alert('ã“ã®æ›œæ—¥ã«ç©ºããƒ–ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  const root=document.getElementById('modalRoot');
  const bg=document.createElement('div');bg.className='modal-bg';
  const modal=document.createElement('div');modal.className='modal';
  modal.innerHTML='<h3>ğŸ“ W'+(targetWi+1)+' '+targetDay+'æ›œ - é…ç½®å…ˆã‚’é¸æŠ</h3>';
  const opts=document.createElement('div');opts.className='modal-opts';
  // Group by teacher
  const byTeacher={};options.forEach(o=>{if(!byTeacher[o.teacher])byTeacher[o.teacher]=[];byTeacher[o.teacher].push(o);});
  for(const[teacher,tOpts]of Object.entries(byTeacher)){
    const timesList=tOpts.map(o=>o.time.slice(0,5)+'('+o.cnt+'/2)').join(', ');
    const btn=document.createElement('div');btn.className='modal-opt';
    const ngMark=dd.slot?isNg(dd.slot[1],teacher):'';
    btn.innerHTML='<span class="t-name" style="'+(ngMark?'color:var(--red)':'')+'">'+(ngMark?'âš  ':'')+teacher+'</span><span class="t-info">'+timesList+'</span>';
    btn.onclick=()=>{
      // Pick the first available time slot for this teacher
      const pick=tOpts[0];
      // Remove from source
      const srcWs=R.schedule[dd.wi];
      srcWs[dd.day][dd.ts][dd.bi].slots.splice(dd.si,1);
      // Add to target
      ws[targetDay][pick.ts][pick.bi].slots.push(dd.slot);
      edited=true;dragData=null;root.innerHTML='';rR();
    };
    opts.appendChild(btn);
    // Show individual time slots if multiple
    if(tOpts.length>1){
      for(const o of tOpts){
        const sub=document.createElement('div');sub.className='modal-opt';sub.style.paddingLeft='28px';
        sub.innerHTML='<span class="t-info">â”” '+o.time+' ('+o.cnt+'/2)</span>';
        sub.onclick=()=>{
          const srcWs=R.schedule[dd.wi];srcWs[dd.day][dd.ts][dd.bi].slots.splice(dd.si,1);
          ws[targetDay][o.ts][o.bi].slots.push(dd.slot);
          edited=true;dragData=null;root.innerHTML='';rR();
        };
        opts.appendChild(sub);
      }
    }
  }
  modal.appendChild(opts);
  const cancel=document.createElement('div');cancel.className='modal-cancel';
  cancel.innerHTML='<button class="btn btn-o" style="padding:6px 16px;font-size:12px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  cancel.querySelector('button').onclick=()=>{root.innerHTML='';dragData=null;};
  modal.appendChild(cancel);bg.appendChild(modal);root.appendChild(bg);
  bg.addEventListener('click',e=>{if(e.target===bg){root.innerHTML='';dragData=null;}});
}

// === Slot Edit Modal (click on calendar slot) ===
function showSlotEditModal(student,it){
  const root=document.getElementById('modalRoot');
  const ws=R.schedule[it.wi];
  const dayData=ws[it.day]||{};
  const sName=student.name;
  const curTime=TSR[it.ts]||it.ts;
  const curTeacher=it.teacher;

  // Collect all available slots for this day (same week)
  const times=it.day==='åœŸ'?['14','16','17','18']:['16','17','18','19','20'];
  const options=[];// {ts,bi,teacher,cnt,time}
  for(const ts of times){
    const booths=dayData[ts]||[];
    for(let bi=0;bi<booths.length;bi++){
      const b=booths[bi];
      if(!b||!b.teacher)continue;
      // Skip current position
      const isCurrent=(ts===it.ts&&bi===it.bi);
      // Available if: current position OR has space (<2) OR can swap (has 1 student)
      const hasSpace=b.slots.length<2||isCurrent;
      if(hasSpace){
        options.push({ts,bi,teacher:b.teacher,cnt:b.slots.length,time:TSR[ts]||ts,isCurrent});
      }
    }
  }

  const bg=document.createElement('div');bg.className='modal-bg';
  const modal=document.createElement('div');modal.className='modal';
  modal.style.minWidth='340px';
  modal.innerHTML='<h3>âœï¸ æˆæ¥­ã‚’å¤‰æ›´</h3>'
    +'<p style="font-size:12px;color:var(--ink3);margin-bottom:6px">'+student.grade+' '+sName+' â€” '+it.subj+'</p>'
    +'<p style="font-size:11px;color:var(--ink3);margin-bottom:12px">ç¾åœ¨: '+curTime.slice(0,5)+' / '+curTeacher+'</p>';

  const opts=document.createElement('div');opts.className='modal-opts';

  // Group by time slot
  for(const ts of times){
    const tsOpts=options.filter(o=>o.ts===ts);
    if(!tsOpts.length)continue;
    for(const o of tsOpts){
      const btn=document.createElement('div');btn.className='modal-opt';
      const ng=isNg(sName,o.teacher);
      const isCur=o.isCurrent;
      btn.style.cssText=isCur?'background:#f0f5ff;border-color:var(--accent)':'';
      btn.innerHTML='<div><span class="t-name" style="'+(ng?'color:var(--red)':'')+'">'
        +(ng?'âš  ':'')+o.teacher+'</span>'
        +'<span style="font-size:10px;color:var(--ink3);margin-left:6px">'+o.time.slice(0,5)+'</span></div>'
        +'<span class="t-info">'+(isCur?'ğŸ“ ç¾åœ¨':'ç©ºã '+o.cnt+'/2')+'</span>';
      if(!isCur){
        ((o_)=>{btn.onclick=()=>{
          // Move student from current booth to new booth
          const srcBooth=ws[it.day][it.ts][it.bi];
          const si=srcBooth.slots.findIndex(sl=>sl[1]===sName&&sl[2]===it.subj);
          if(si<0){root.innerHTML='';return;}
          const slot=srcBooth.slots.splice(si,1)[0];
          const tgtBooth=ws[it.day][o_.ts][o_.bi];
          tgtBooth.slots.push(slot);
          edited=true;root.innerHTML='';rR();
        };})(o);
      }
      opts.appendChild(btn);
    }
  }

  // Option to remove (send to unplaced)
  const rmBtn=document.createElement('div');rmBtn.className='modal-opt';
  rmBtn.style.cssText='border-color:#fca5a5;color:var(--red)';
  rmBtn.innerHTML='<span class="t-name" style="color:var(--red)">ğŸ—‘ æœªé…ç½®ã«æˆ»ã™</span><span class="t-info">ãƒ–ãƒ¼ã‚¹ã‹ã‚‰å¤–ã™</span>';
  rmBtn.onclick=()=>{
    const srcBooth=ws[it.day][it.ts][it.bi];
    const si=srcBooth.slots.findIndex(sl=>sl[1]===sName&&sl[2]===it.subj);
    if(si<0){root.innerHTML='';return;}
    const slot=srcBooth.slots.splice(si,1)[0];
    const ex=R.unplaced.find(u=>u.name===slot[1]&&u.subject===slot[2]);
    if(ex)ex.count++;else R.unplaced.push({grade:slot[0],name:slot[1],subject:slot[2],count:1});
    edited=true;root.innerHTML='';rR();
  };
  opts.appendChild(rmBtn);

  modal.appendChild(opts);
  const cancel=document.createElement('div');cancel.className='modal-cancel';
  cancel.innerHTML='<button class="btn btn-o" style="padding:6px 16px;font-size:12px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  cancel.querySelector('button').onclick=()=>{root.innerHTML='';};
  modal.appendChild(cancel);bg.appendChild(modal);root.appendChild(bg);
  bg.addEventListener('click',e=>{if(e.target===bg)root.innerHTML='';});
}
</script>
</body>
</html>
