# 個別指導塾・時間割作成（ブース表）自動化システム 仕様書
**版:** v1.3
**作成日:** 2025-11-01 (JST)
**最終更新:** 2025-11-07 (JST)
**対象:** ブラウザ実行（ローカル完結）／既存Excelテンプレート（提出シフト＝元シート、ブース表、生徒・講師情報）対応

---

## 目次
- [1. 目的・ゴール](#1-目的ゴール)
- [2. スコープと非スコープ](#2-スコープと非スコープ)
- [3. 用語定義](#3-用語定義)
- [4. 前提・制約](#4-前提制約)
- [5. システム構成（ブラウザ実行）](#5-システム構成ブラウザ実行)
- [6. 入出力仕様](#6-入出力仕様)
  - [6.1 入力ファイル](#61-入力ファイル)
  - [6.2 出力ファイル](#62-出力ファイル)
  - [6.3 ファイルマッピング（可変対応）](#63-ファイルマッピング可変対応)
- [7. データモデル](#7-データモデル)
- [8. 割付アルゴリズム](#8-割付アルゴリズム)
  - [8.1 講師→ブース配置](#81-講師ブース配置)
  - [8.2 生徒→講師（ブース）配置](#82-生徒講師ブース配置)
  - [8.3 最適化オプション](#83-最適化オプション)
- [9. 画面UI仕様](#9-画面ui仕様)
- [10. バリデーション・監査仕様](#10-バリデーション監査仕様)
- [11. エッジケースと例外処理](#11-エッジケースと例外処理)
- [12. 非機能要件](#12-非機能要件)
- [13. セキュリティ・プライバシー](#13-セキュリティプライバシー)
- [14. ログ・差分・再現性](#14-ログ差分再現性)
- [15. 拡張インタフェース](#15-拡張インタフェース)
- [16. 受入基準（UAT）](#16-受入基準uat)
- [17. テストケース一覧（要約）](#17-テストケース一覧要約)
- [18. 実装タスク分解（WBS）](#18-実装タスク分解wbs)
- [19. 運用・保守](#19-運用保守)
- [20. 変更履歴テンプレート](#20-変更履歴テンプレート)

---

## 1. 目的・ゴール
- **目的:** 提出シフト（元シート）と既存のブース表テンプレートを入力とし、**講師配置→生徒配置**までをブラウザ上で半自動化。最終の目視確認・微修正を少工数化。
- **成果物:**  
  1) **講師配置済みブース表.xlsx**  
  2) **生徒配置済みブース表.xlsx**  
  3) **検知レポート（未割当・制約違反等）.csv**  
  4) **実行ログ.json（任意）**
- **品質基準:** 提出シフトとの整合性、未割当最小化、エラーの可観測性、再現性（同条件→同結果）。

## 2. スコープと非スコープ
**スコープ**
- Excel入出力（ローカル／テンプレ互換）
- 講師→ブース自動割付、生徒→講師自動割付
- ルール設定（NG・上限制約）とレポート
- 目視確認UI（D&Dによる微修正）

**非スコープ（初期版）**
- サーバ側DB／アカウント管理
- 外部SaaS保存（Drive/Notion等）※拡張で対応
- 複雑な最適化（厳密MIP）※オプション

## 3. 用語定義
- **元シート（提出シフト）**: 講師の提出可勤務枠を記録したExcel。
- **ブース表**: 日付×時間×ブースのマトリクス（既存運用フォーマット）。
- **スロット**: `日付+時間+ブース` の単位枠。
- **配置**: スロットに講師・生徒を割り当てること。

## 4. 前提・制約
- ブラウザのみで完結（オフライン可）。ファイルは**アップロードせず**メモリ処理。
- **テンプレ互換**: 出力は既存レイアウトを崩さない。
- **時間表現**: Excel数値/文字列/Date混在を正規化（ゼロ詰め・前方埋め）。
- **並び**: 原則 **日付→時間 昇順**、同時刻内はブースID昇順。

## 5. システム構成（ブラウザ実行）
- **対象ブラウザ**: Chrome / Edge / Safari / Firefox（最新版）
- **主要技術**:  
  - Excel入出力: SheetJS (xlsx)  
  - UI: HTML/CSS/JS（Vanilla or React/Vueは実装方針に依存）  
  - パフォーマンス: Web Worker（必要時）
- **アーキテクチャ**: 完全クライアントサイド。ファイル読込→メモリ変換→割付→ダウンロード。

## 6. 入出力仕様
### 6.1 入力ファイル
- **元シート（提出シフト）**: `元シートテンプレート.xlsx`
  - 想定構造例: **A列=時間**, ヘッダ行に**日付**、日付の**右隣列=講師名**列群
  - 必須情報: 日付, 時刻, 講師名（IDは内部で採番可）
- **ブース表テンプレート**: `ブース表テンプレート.xlsx`
  - 想定構造例: **行0=日付**, **行1=曜日**, **B列=時間**, 交点セルに配置
- **生徒コマ数表（オプション）**: `生徒コマ数表テンプレート.xlsx`
  - 想定構造例: 1生徒1行形式、**列1-3=基本情報**（学年/学校名/生徒名）、**列4-19=科目別コマ数**、**列21-26=条件設定**（希望講師/NG講師/NG生徒/希望時間/NG日程/備考）
  - 必須情報: 生徒名, 科目別コマ数
  - オプション情報: 希望講師, NG講師, NG生徒, 希望時間, NG日程
  - 未読み込み時: 講師のみを割り当て

> ※実装前にテンプレ現物から**列・行の最終仕様を確定**。以後は**マッピングUI**で柔軟対応。

### 6.2 出力ファイル
| ファイル名例 | 内容 | 形式 |
|---|---|---|
| `講師配置済みブース表.xlsx` | 講師をスロットに割付済 | Excel |
| `生徒配置済みブース表.xlsx` | 講師・生徒とも割付済 | Excel |
| `検知レポート.csv` | 未割当、重複、NG違反、上限超過等 | CSV |
| `run_log_YYYYMMDD_hhmmss.json` | 設定・要約・再現用情報 | JSON |

### 6.3 ファイルマッピング（可変対応）
- **自動検出**: 日付ヘッダ行／曜日行／時間列の推定
- **手動上書き**: マッピングUIで列・行・タブを指定
- **保持**: 設定はローカル保存（ブラウザStorage/JSON）

---

## 7. データモデル
```json
// Slot: ブース枠
{ "date":"YYYY/MM/DD", "time":"HH:MM:SS", "boothId":"B1" }

// TeacherShift: 提出シフト項目
{
  "date":"YYYY/MM/DD",
  "time":"HH:MM:SS",
  "teacherId":"T001",
  "teacherName":"山田",
  "constraints": {
    "ngStudents": ["S002"],
    "ngDays": ["Sun"],
    "maxContinuous": 4,
    "maxDaily": 6
  }
}

// StudentDemand: 生徒希望
{
  "date":"YYYY/MM/DD",
  "time":"HH:MM:SS",
  "studentId":"S001",
  "subject":"数学",
  "preferredTeacherId":"T001",
  "ngTeachers":["T003"],
  "priority": 10
}

// Booth: ブース定義
{ "boothId":"B1", "capacity":1, "attributes":{"mode":"offline"} }

// Assignment: 割付結果
{
  "date":"YYYY/MM/DD",
  "time":"HH:MM:SS",
  "boothId":"B1",
  "teacherId":"T001",
  "studentId":"S001" // 講師配置段階では null 可
}

// CalendarMeta: テンプレ解析結果
{
  "year":2025, "month":11,
  "days":[{"day":1,"colIdx":3}, {"day":2,"colIdx":4}],
  "timeColIdx":2
}

---

## 追記: Excel直接取り込み対応（v1.1）

本仕様書に対し、スケジューラ画面で「元シート（講師表）」と「ブース表」をExcelのまま取り込める機能を追加しました。

### 1) ブース表（.xlsx）→ Slot JSON 自動生成
- 前提レイアウト（既存テンプレート準拠）
  - 行0: 日（1〜31）、行1: 曜日（例: 月/火/水/木/金/土/日/祝）
  - 列B（インデックス1）: 時刻（空欄は直上の時刻を継承）
  - **各日は5列を使用**（例: 3日→C-G列、4日→H-L列、5日→M-Q列）
  - **各ブースは2行×2列のマージセル構造**
    - 左列: ブース番号（①〜⑳）
    - 右列: 講師名記入欄
  - セルの丸数字（①〜⑳）をブース番号として解釈（①→B1, ②→B2, ...）
  - 年/月の取得は以下の優先順位で判定します
    1. シート名から「年.月.」を検出（例: "ブース表　2025.11.02-08"）
    2. シート内の上部セルから "2025/11"、"2025.11"、"2025年11月" 等を検出
- 生成形式: `[ { "date":"YYYY/MM/DD", "time":"HH:MM:SS", "boothId":"B1" }, ... ]`

### 2) 元シート（講師表 .xlsx）→ TeacherShift JSON 自動生成
- 前提レイアウト（既存テンプレート準拠）
  - ヘッダ行（先頭10行から自動検出）に各日の「日付」セルを含む
  - **各日は5列を使用**（例: 11/3→B-F列、11/4→G-K列）
  - 各日の列構成:
    1. ブース番号列
    2. **講師名列** ← この列から講師の可用性を読み取る
    3. 学年列
    4. 生徒名列
    5. 科目列
  - 列A（インデックス0）: 時刻（空欄は直上の時刻を継承）
  - 各行の講師名セルが空でなければ、その日時に講師が可用と判断
  - teacherId は講師名から安定ハッシュで自動採番（例: T2A3F1B）
  - 日付セルの表記は `YYYY/MM/DD` `YYYY-MM-DD` `MM/DD` `M/D` `MM-DD` 等のExcel日付形式を受理。年が無い形式は年/月の検出結果で補完。
- 生成形式: `[ { "date":"YYYY/MM/DD", "time":"HH:MM:SS", "teacherId":"Txxxxxx", "teacherName":"氏名", "constraints":{} }, ... ]`

### 3) 生徒・講師情報（.xlsx）→ StudentDemand / TeacherSubject JSON 自動生成（v1.2-v1.3）
**ファイル名**: `生徒・講師情報.xlsx`（2シート構成）

#### Sheet 1: 指導可能教科一覧
- **目的**: 各講師がどの科目を教えられるかを管理
- **レイアウト**:
  - 行2: カテゴリ（小学生/中学受験/中学生/高校生）
  - 行3: 科目ヘッダー（国/算/英/理/社/数/現/古/物/化/生/地/政/世/日 など）
  - 行4以降: 各行が1講師
  - 列B: 講師名（苗字+"T"形式、例: 西T）
  - 列C以降: 各科目に対して「◯」または「○」があれば指導可能
- **処理フロー**:
  1. 行3から科目ヘッダーを読み込み
  2. 行4以降の各講師について、◯マークがある列の科目を収集
  3. 科目名を正規化（国→国語、算→算数、数→数学）
  4. teacherId は講師名から安定ハッシュで生成（例: T6B23F8）
- **生成形式**:
  ```json
  {
    "T6B23F8": ["国語", "算数", "理科"],
    "T834836": ["数学", "英語", "物理"],
    ...
  }
  ```

#### Sheet 2: 生徒コマ数表
- **目的**: 生徒の科目別コマ数と希望条件を管理
- **レイアウト**（1生徒1行形式）:
  - ヘッダ行（行0）: 学年, 学校名, 生徒名, 科目列（英/英検/数/算/国/理/社/古/物/化/生/地/政/世/日）, 希望講師, NG講師, NG生徒, 希望時間, NG日程, 備考
  - 各科目列にコマ数を数値で入力（0または空欄でスキップ）
  - 希望講師/NG講師: 苗字+"T"形式（例: 西T）、カンマ区切りで複数指定可
  - NG生徒: 生徒名をカンマ区切り（例: 松橋,深澤）。同じ時間帯に座らせたくない生徒を指定
  - 希望時間: 曜日+時刻形式（例: 月17,水19 = 月曜17時,水曜19時）。カンマ区切りで複数指定可
  - NG日程: 曜日のカンマ区切り（例: 火,土）。部活や他の予定で来られない曜日を指定
  - 学年表記: S4=小4, M1=中1, H2=高2
- **処理フロー**:
  1. 各生徒の各科目について、コマ数分の需要データを生成
  2. 希望時間が指定されている場合、その曜日と時刻に合致するスロットのみに需要を展開
  3. 希望時間が未指定の場合、全スロットに展開（NG日程は除外）
  4. NG講師は講師IDに変換してフィルタリング
  5. NG生徒は生徒名のまま保持（割り当て時にチェック）
  6. 優先度を自動計算（受験生は高優先度、高校生は中優先度）
- **生成形式**:
  ```json
  [
    {
      "date": "2025/11/02",
      "time": "17:00:00",
      "studentId": "T6C8F12",
      "studentName": "松橋",
      "subject": "算数",
      "grade": "S4",
      "preferredTeacherId": "T6B23F8",
      "ngTeachers": [],
      "ngStudents": ["深澤"],
      "priority": 5
    },
    ...
  ]
  ```

### 4) スケジューラ（scheduler.html）
- 上記Excelファイル（ブース表、元シート、生徒コマ数表）をそのままアップロードしてスロット/講師可用/生徒需要を取り込み、割当を実行できます。
- 生徒コマ数表は**オプション**です。未読み込みの場合は講師のみを割り当てます。
- 既存の JSON 貼り付け・読み込みも引き続き利用可能です。

### 5) 割り当てアルゴリズムの拡張
**フェーズ1: 優先ブース設定がある講師を優先配置**
- 講師の優先ブース設定を読み込み、該当ブースに優先的に配置
- 1日内でブース番号が変わらないように固定

**フェーズ2: 残りのブースを通常割り当て**
- 生徒需要データがある場合:
  1. **NG生徒チェック**: 同じ時間帯にNG生徒が既に割り当てられている場合はスキップ
  2. **希望講師マッチング**: 生徒の希望講師を優先してマッチング
     - 希望講師が指定されている場合、その講師が科目を教えられるかをチェック
  3. **通常講師マッチング**: 希望講師がいない、または割り当てできない場合
     - NG講師を除外
     - **科目マッチング**: 講師が生徒の科目を指導可能かをチェック
     - 1日内ブース固定ルールを適用
  4. **割り当て後処理**: 生徒IDを追跡して、NG生徒チェックに使用
- 生徒需要データがない場合: 講師のみを割り当て

**科目マッチング機能（v1.3）**:
- `生徒・講師情報.xlsx` の Sheet 1（指導可能教科一覧）から講師-科目マッピングを読み込み
- 割り当て時に、講師が生徒の科目を教えられるかをチェック
- 科目名の正規化を実施（国→国語、算→算数、数→数学など）
- teacherSubjectMapが空の場合は後方互換性のため常にマッチング成功

**NG生徒処理（v1.3）**:
- 同じ時間帯に既に割り当てられている生徒をSetで追跡
- 各生徒需要について、ngStudentsリストに含まれる生徒が同じ時間帯にいるかチェック
- NG生徒がいる場合、その需要は後回しにする（次の時間帯で再試行）

**ソート優先度**:
1. 出勤開始時刻が早い講師を優先
2. その日の割り当て数が少ない講師を優先

**1日内ブース固定ルール**:
- 講師は1日を通して同じブースを使用
- 既に別のブースに割り当て済みの講師は、他のブースに割り当てない

---

## 変更履歴

### v1.3 (2025-11-07)
**追加機能:**
- **科目マッチング機能**
  - `生徒・講師情報.xlsx` の Sheet 1（指導可能教科一覧）を読み込み
  - 講師が指導可能な科目を管理（16名の講師、各科目に◯マーク）
  - 割り当て時に講師が生徒の科目を教えられるかを自動チェック
  - 科目名の正規化機能（国→国語、算→算数、数→数学など）
  - `canTeachSubject()` ヘルパー関数を実装
  - 後方互換性確保（teacherSubjectMapが空の場合は全てマッチング成功）

- **NG生徒処理機能**
  - 同じ時間帯に既に割り当てられている生徒を追跡
  - NG生徒リストに含まれる生徒が同じ時間帯にいる場合、その需要をスキップ
  - `hasNgStudentConflict()` ヘルパー関数を実装
  - 生徒割り当て後に生徒IDを追跡Setに追加

**改善:**
- 割り当てアルゴリズムの精度向上
  - 希望講師選択時に科目マッチングを適用
  - 通常講師選択時に科目マッチングを適用
  - NG生徒チェックを需要のループ開始時に実施

**テスト:**
- `test_subject_matching.js`: 科目マッチング機能の単体テスト（7種類のテストケース）
- `test_idFromName.js`: ID生成関数のテスト（一貫性、衝突チェック、パフォーマンス）
- `test_expandStudentDemands.js`: 生徒需要展開の統合テスト（7種類のテストケース）
- `test_excel_integration.js`: Excel解析の統合テスト（60名の生徒、16名の講師、152件の科目需要）

### v1.2 (2025-11-07)
**追加機能:**
- 生徒コマ数表（.xlsx）の読み込み機能を追加
  - 1生徒1行形式で科目別コマ数と希望条件を管理
  - 15科目対応（英/英検/数/算/国/理/社/古/物/化/生/地/政/世/日）
  - 希望時間を曜日+時刻形式で指定（例: 月17,水19）
  - NG講師、NG生徒、NG日程の指定
- 生徒需要データの自動展開機能
  - 希望時間を日付・時刻ベースに変換
  - NG条件のフィルタリング
  - 優先度の自動計算（受験生優先）

**改善:**
- 講師割り当てアルゴリズムの強化
  - 出勤開始時刻が早い講師を優先
  - 1日内ブース固定ルールを厳格化
- UIの改善
  - 生徒コマ数表読み込みセクションを追加
  - 実行ボタンのラベルを「講師と生徒を割り当てる」に変更

### v1.1 (2025-11-05)
**追加機能:**
- Excel直接取り込み対応
  - ブース表の自動パース
  - 元シート（講師表）の自動パース
  - 年月の自動検出（シート名/セル内容から）

### v1.0 (2025-11-01)
- 初版リリース
- 基本的な講師割り当て機能
- ブース表・元シートの読み込み
- 優先ブース設定機能
