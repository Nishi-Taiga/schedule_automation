# 個別指導塾・時間割作成（ブース表）自動化システム 仕様書
**版:** v1.0  
**作成日:** 2025-11-01 (JST)  
**対象:** ブラウザ実行（ローカル完結）／既存Excelテンプレート（提出シフト＝元シート、ブース表）対応

---

## 目次
- [1. 目的・ゴール](#1-目的ゴール)
- [2. スコープと非スコープ](#2-スコープと非スコープ)
- [3. 用語定義](#3-用語定義)
- [4. 前提・制約](#4-前提制約)
- [5. システム構成（ブラウザ実行）](#5-システム構成ブラウザ実行)
- [6. 入出力仕様](#6-入出力仕様)
  - [6.1 入力ファイル](#61-入力ファイル)
  - [6.2 出力ファイル](#62-出力ファイル)
  - [6.3 ファイルマッピング（可変対応）](#63-ファイルマッピング可変対応)
- [7. データモデル](#7-データモデル)
- [8. 割付アルゴリズム](#8-割付アルゴリズム)
  - [8.1 講師→ブース配置](#81-講師ブース配置)
  - [8.2 生徒→講師（ブース）配置](#82-生徒講師ブース配置)
  - [8.3 最適化オプション](#83-最適化オプション)
- [9. 画面UI仕様](#9-画面ui仕様)
- [10. バリデーション・監査仕様](#10-バリデーション監査仕様)
- [11. エッジケースと例外処理](#11-エッジケースと例外処理)
- [12. 非機能要件](#12-非機能要件)
- [13. セキュリティ・プライバシー](#13-セキュリティプライバシー)
- [14. ログ・差分・再現性](#14-ログ差分再現性)
- [15. 拡張インタフェース](#15-拡張インタフェース)
- [16. 受入基準（UAT）](#16-受入基準uat)
- [17. テストケース一覧（要約）](#17-テストケース一覧要約)
- [18. 実装タスク分解（WBS）](#18-実装タスク分解wbs)
- [19. 運用・保守](#19-運用保守)
- [20. 変更履歴テンプレート](#20-変更履歴テンプレート)

---

## 1. 目的・ゴール
- **目的:** 提出シフト（元シート）と既存のブース表テンプレートを入力とし、**講師配置→生徒配置**までをブラウザ上で半自動化。最終の目視確認・微修正を少工数化。
- **成果物:**  
  1) **講師配置済みブース表.xlsx**  
  2) **生徒配置済みブース表.xlsx**  
  3) **検知レポート（未割当・制約違反等）.csv**  
  4) **実行ログ.json（任意）**
- **品質基準:** 提出シフトとの整合性、未割当最小化、エラーの可観測性、再現性（同条件→同結果）。

## 2. スコープと非スコープ
**スコープ**
- Excel入出力（ローカル／テンプレ互換）
- 講師→ブース自動割付、生徒→講師自動割付
- ルール設定（NG・上限制約）とレポート
- 目視確認UI（D&Dによる微修正）

**非スコープ（初期版）**
- サーバ側DB／アカウント管理
- 外部SaaS保存（Drive/Notion等）※拡張で対応
- 複雑な最適化（厳密MIP）※オプション

## 3. 用語定義
- **元シート（提出シフト）**: 講師の提出可勤務枠を記録したExcel。
- **ブース表**: 日付×時間×ブースのマトリクス（既存運用フォーマット）。
- **スロット**: `日付+時間+ブース` の単位枠。
- **配置**: スロットに講師・生徒を割り当てること。

## 4. 前提・制約
- ブラウザのみで完結（オフライン可）。ファイルは**アップロードせず**メモリ処理。
- **テンプレ互換**: 出力は既存レイアウトを崩さない。
- **時間表現**: Excel数値/文字列/Date混在を正規化（ゼロ詰め・前方埋め）。
- **並び**: 原則 **日付→時間 昇順**、同時刻内はブースID昇順。

## 5. システム構成（ブラウザ実行）
- **対象ブラウザ**: Chrome / Edge / Safari / Firefox（最新版）
- **主要技術**:  
  - Excel入出力: SheetJS (xlsx)  
  - UI: HTML/CSS/JS（Vanilla or React/Vueは実装方針に依存）  
  - パフォーマンス: Web Worker（必要時）
- **アーキテクチャ**: 完全クライアントサイド。ファイル読込→メモリ変換→割付→ダウンロード。

## 6. 入出力仕様
### 6.1 入力ファイル
- **元シート（提出シフト）**: `元シートテンプレート.xlsx`
  - 想定構造例: **A列=時間**, ヘッダ行に**日付**、日付の**右隣列=講師名**列群
  - 必須情報: 日付, 時刻, 講師名（IDは内部で採番可）
- **ブース表テンプレート**: `ブース表テンプレート.xlsx`
  - 想定構造例: **行0=日付**, **行1=曜日**, **B列=時間**, 交点セルに配置

> ※実装前にテンプレ現物から**列・行の最終仕様を確定**。以後は**マッピングUI**で柔軟対応。

### 6.2 出力ファイル
| ファイル名例 | 内容 | 形式 |
|---|---|---|
| `講師配置済みブース表.xlsx` | 講師をスロットに割付済 | Excel |
| `生徒配置済みブース表.xlsx` | 講師・生徒とも割付済 | Excel |
| `検知レポート.csv` | 未割当、重複、NG違反、上限超過等 | CSV |
| `run_log_YYYYMMDD_hhmmss.json` | 設定・要約・再現用情報 | JSON |

### 6.3 ファイルマッピング（可変対応）
- **自動検出**: 日付ヘッダ行／曜日行／時間列の推定
- **手動上書き**: マッピングUIで列・行・タブを指定
- **保持**: 設定はローカル保存（ブラウザStorage/JSON）

---

## 7. データモデル
```json
// Slot: ブース枠
{ "date":"YYYY/MM/DD", "time":"HH:MM:SS", "boothId":"B1" }

// TeacherShift: 提出シフト項目
{
  "date":"YYYY/MM/DD",
  "time":"HH:MM:SS",
  "teacherId":"T001",
  "teacherName":"山田",
  "constraints": {
    "ngStudents": ["S002"],
    "ngDays": ["Sun"],
    "maxContinuous": 4,
    "maxDaily": 6
  }
}

// StudentDemand: 生徒希望
{
  "date":"YYYY/MM/DD",
  "time":"HH:MM:SS",
  "studentId":"S001",
  "subject":"数学",
  "preferredTeacherId":"T001",
  "ngTeachers":["T003"],
  "priority": 10
}

// Booth: ブース定義
{ "boothId":"B1", "capacity":1, "attributes":{"mode":"offline"} }

// Assignment: 割付結果
{
  "date":"YYYY/MM/DD",
  "time":"HH:MM:SS",
  "boothId":"B1",
  "teacherId":"T001",
  "studentId":"S001" // 講師配置段階では null 可
}

// CalendarMeta: テンプレ解析結果
{
  "year":2025, "month":11,
  "days":[{"day":1,"colIdx":3}, {"day":2,"colIdx":4}],
  "timeColIdx":2
}

---

## 追記: Excel直接取り込み対応（v1.1）

本仕様書に対し、スケジューラ画面で「元シート（講師表）」と「ブース表」をExcelのまま取り込める機能を追加しました。

### 1) ブース表（.xlsx）→ Slot JSON 自動生成
- 前提レイアウト（既存テンプレート準拠）
  - 行0: 日（1〜31）、行1: 曜日（例: 月/火/水/木/金/土/日/祝）
  - 列B（2列目）: 時刻（空欄は直上の時刻を継承）
  - セルの丸数字（①〜⑳）をブース番号として解釈（①→B1, ②→B2, ...）
  - 年/月の取得は以下の優先順位で判定します
    1. 画面の 年/月 入力（任意の上書き）
    2. シート名から「年.月.」を検出（例: "... 2025.11.02-08"）
    3. シート内の上部セルから "2025/11"、"2025.11"、"2025年11月" 等を検出
- 生成形式: `[ { "date":"YYYY/MM/DD", "time":"HH:MM:SS", "boothId":"B1" }, ... ]`

### 2) 元シート（講師表 .xlsx）→ TeacherShift JSON 自動生成
- 前提レイアウト（既存テンプレート準拠）
  - ヘッダ行（先頭10行から自動検出）に各日の「日付」セル（右隣の列を当日の「講師名」列とみなす）
  - 列A（1列目）: 時刻（空欄は直上の時刻を継承）
  - 各行の講師名セルが空でなければ、その日時に講師が可用と判断
  - teacherId は講師名から安定ハッシュで自動採番（例: T2A3F1B）
  - 日付セルの表記は `YYYY/MM/DD` `YYYY-MM-DD` `MM/DD` `M/D` `MM-DD` `11/03(月)` 等を受理。年が無い形式は上記「年/月」の検出結果で補完。
- 生成形式: `[ { "date":"YYYY/MM/DD", "time":"HH:MM:SS", "teacherId":"Txxxxxx", "teacherName":"氏名", "constraints":{} }, ... ]`

### 3) スケジューラ（scheduler.html）
- 上記Excelファイルをそのままアップロードしてスロット/講師可用を取り込み、需要JSON（任意）と合わせて割当を実行できます。
- 既存の JSON 貼り付け・読み込みも引き続き利用可能です。
