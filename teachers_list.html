<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>yyyy/mm/dd_hh:mm:ss_講師名 リスト生成（重複除去）</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body { font-family: system-ui, sans-serif; padding: 24px; line-height: 1.6; }
  h1 { font-size: 1.2rem; margin: 0 0 12px; }
  .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin: 12px 0; }
  .row { margin: 8px 0; }
  textarea { width: 100%; min-height: 280px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 14px; }
  button { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb; }
  button + button { margin-left: 8px; }
  .hint { color: #6b7280; font-size: 12px; }
  .ok { color: #16a34a; font-weight: 600; }
  .warn { color: #b45309; font-weight: 600; }
  .err { color: #dc2626; font-weight: 600; }
  .small { font-size: 12px; }
</style>
</head>
<body>
  <h1>yyyy/mm/dd_hh:mm:ss_講師名 リスト生成（重複除去）</h1>

  <div class="card">
    <div class="row">
      <label><strong>① Excelファイルを選択：</strong></label><br/>
      <input type="file" id="file" accept=".xlsx,.xls" />
    </div>
    <div class="row">
      <button id="generateBtn">② リストを作成する</button>
    </div>
    <div class="row small hint">
      想定（Book2.xlsx）：<br/>
      ・行0に各日の実日付（B=11/03, G=11/04, L=11/05, Q=11/06, V=11/07, AA=11/08）<br/>
      ・A列（0列目）が時間。空欄は直前の時刻で前方埋め。<br/>
      ・各日の講師列は「日付列の1つ右」。（例：C, H, M, R, W, AB）<br/>
      ・出力は日付→時間の昇順。重複は削除。
    </div>
    <div id="status" class="row small"></div>
  </div>

  <div class="card">
    <div class="row"><strong>出力結果（コピー可）</strong></div>
    <div class="row">
      <textarea id="output" placeholder="リストがここに表示されます"></textarea>
    </div>
    <div class="row">
      <button id="copyBtn">全てコピー</button>
      <button id="saveBtn">TXTで保存</button>
    </div>
  </div>

<script>
(() => {
  let workbook = null;

  const $file = document.getElementById('file');
  const $output = document.getElementById('output');
  const $status = document.getElementById('status');
  const $generateBtn = document.getElementById('generateBtn');
  const $copyBtn = document.getElementById('copyBtn');
  const $saveBtn = document.getElementById('saveBtn');

  const timeRegex = /^\s*(\d{1,2}):(\d{2})(?::(\d{2}))?\s*$/; // "14:55" / "14:55:00"
  const pad2 = n => String(n).padStart(2, '0');
  const FULLWIDTH_SPACE = /\u3000/g; // 全角スペース

  // ---- 日付・時間の正規化 ----
  function normalizeTime(v) {
    if (v == null) return null;
    if (typeof v === "string") {
      const m = v.match(timeRegex);
      if (!m) return null;
      return `${pad2(m[1])}:${pad2(m[2])}:${pad2(m[3] ?? "00")}`;
    }
    if (typeof v === "number") { // Excel小数(1日=1.0)
      if (v < 0 || v > 1) return null;
      const total = Math.round(v * 24 * 3600);
      const hh = pad2(Math.floor(total / 3600) % 24);
      const mm = pad2(Math.floor((total % 3600) / 60));
      const ss = pad2(total % 60);
      return `${hh}:${mm}:${ss}`;
    }
    if (Object.prototype.toString.call(v) === "[object Date]" && !isNaN(v)) {
      return `${pad2(v.getHours())}:${pad2(v.getMinutes())}:${pad2(v.getSeconds())}`;
    }
    return null;
  }

  function isDateCell(v) {
    if (v == null) return false;
    if (Object.prototype.toString.call(v) === "[object Date]" && !isNaN(v)) return true;
    // 文字列でも "2025-11-03" / "2025/11/03" / "2025-11-03 00:00:00" 等なら許容
    if (typeof v === "string") {
      const s = v.trim();
      if (/^\d{4}[/-]\d{1,2}[/-]\d{1,2}(?:\s+\d{2}:\d{2}:\d{2})?$/.test(s)) {
        const d = new Date(s.replace(/-/g,'/'));
        return !isNaN(d);
      }
    }
    return false;
  }

  function normalizeDateToYmd(v) {
    let d = null;
    if (Object.prototype.toString.call(v) === "[object Date]" && !isNaN(v)) {
      d = v;
    } else if (typeof v === "string") {
      d = new Date(v.replace(/-/g,'/'));
    }
    if (!d || isNaN(d)) return null;
    return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
  }

  // ---- A列(0)の時間を前方埋め ----
  function buildEffectiveTimes(rows, timeColIdx = 0) {
    const eff = new Array(rows.length).fill(null);
    let last = null;
    for (let r = 0; r < rows.length; r++) {
      const rawVal = rows[r]?.[timeColIdx];
      const norm = normalizeTime(rawVal);
      if (norm) last = norm;
      eff[r] = last;
    }
    return eff;
  }

  // ---- 行0の「日付列」を特定、かつ「講師列」はその右隣 ----
  function collectDateTeacherColumns(rows) {
    const header = rows[0] || [];
    const header4 = rows[4] || []; // 参考: 行4に「講師」等の見出し
    const pairs = []; // {dateCol, teacherCol, ymd}

    for (let c = 0; c < header.length; c++) {
      const v = header[c];
      if (!isDateCell(v)) continue;
      const ymd = normalizeDateToYmd(v);
      if (!ymd) continue;

      const teacherCol = c + 1;
      // 行4が「講師」を含むなら安心。違う場合でも +1 を優先（Book2の構造に合致）
      const ok = (typeof header4[teacherCol] === "string" && header4[teacherCol].includes("講師")) || true;
      if (ok) pairs.push({ dateCol: c, teacherCol, ymd });
    }
    return pairs;
  }

  // ---- 文字列整形：講師名の全角・半角スペースをトリム ----
  function cleanTeacherName(s) {
    if (s == null) return null;
    const t = String(s).replace(FULLWIDTH_SPACE, ' ').trim().replace(/\s+/g, ' ');
    return t.length ? t : null;
  }

  function generateList() {
    if (!workbook) {
      $status.innerHTML = `<span class="warn">⚠ ファイルが選択されていません。</span>`;
      return;
    }

    try {
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true });

      // 1) 日付列＆講師列を取得
      const dateTeacherPairs = collectDateTeacherColumns(rows);
      if (dateTeacherPairs.length === 0) {
        throw new Error('行0に日付（Date型/日付文字列）が見つかりませんでした。');
      }

      // 2) A列=時間を前方埋め
      const effectiveTimes = buildEffectiveTimes(rows, 0);

      // 3) 生成（セルごとの出現を候補に）
      const items = []; // { ymd, time, teacher, keyStr }
      for (let r = 0; r < rows.length; r++) {
        const time = effectiveTimes[r];
        if (!time) continue;
        for (const { dateCol, teacherCol, ymd } of dateTeacherPairs) {
          const teacher = cleanTeacherName(rows[r]?.[teacherCol]);
          if (!teacher) continue;
          const keyStr = `${ymd}_${time}_${teacher}`;
          items.push({ ymd, time, teacher, keyStr });
        }
      }

      // 4) 日時でソート
      items.sort((a, b) => {
        const da = new Date(`${a.ymd.replace(/\//g,'-')} ${a.time}`).getTime();
        const db = new Date(`${b.ymd.replace(/\//g,'-')} ${b.time}`).getTime();
        if (da !== db) return da - db;
        // 同時刻なら講師名で安定ソート
        return a.teacher.localeCompare(b.teacher, 'ja');
      });

      // 5) 重複除去（ymd + time + teacher の完全一致を除去）
      const seen = new Set();
      const deduped = [];
      for (const it of items) {
        if (seen.has(it.keyStr)) continue;
        seen.add(it.keyStr);
        deduped.push(it);
      }

      // 6) 出力
      const lines = deduped.map(it => `${it.ymd}_${it.time}_${it.teacher}`);
      $output.value = lines.join('\n');

      // 7) ステータス
      const usedCols = dateTeacherPairs
        .map(p => `[dateCol:${p.dateCol}, teacherCol:${p.teacherCol}, ${p.ymd}]`)
        .join(', ');
      const msg =
        `<span class="ok">✓ 完了</span> 生成: ${items.length}件 → 重複除去後: ${deduped.length}件` +
        `<br/><span class="small hint">日付/講師列: ${usedCols}</span>`;
      $status.innerHTML = msg;

      if (deduped.length === 0) {
        $status.innerHTML += `<br/><span class="warn">⚠ 講師名セルが見つかりませんでした。</span>`;
      }
    } catch (e) {
      $status.innerHTML = `<span class="err">エラー:</span> ${e.message}`;
      console.error(e);
    }
  }

  // ファイル選択（読み込みのみ）
  document.getElementById('file').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const buf = await file.arrayBuffer();
      // cellDates:true で日付セルを Date として受けやすくする
      workbook = XLSX.read(buf, { cellText: false, cellDates: true });
      $status.innerHTML = `<span class="ok">✓</span> ${file.name} を読み込みました。`;
    } catch (err) {
      console.error(err);
      $status.innerHTML = `<span class="err">エラー:</span> ファイルの読み込みに失敗しました。`;
    }
  });

  document.getElementById('generateBtn').addEventListener('click', generateList);

  document.getElementById('copyBtn').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText($output.value);
      $copyBtn.textContent = 'コピーしました';
      setTimeout(() => ($copyBtn.textContent = '全てコピー'), 1200);
    } catch {}
  });

  document.getElementById('saveBtn').addEventListener('click', () => {
    const blob = new Blob([$output.value], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'teachers_list.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  });
})();
</script>
</body>
</html>
