<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartScheduler v1.6 - æ™‚é–“å‰²è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <style>
    /* ========== åŸºæœ¬è¨­å®š ========== */
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue',
        'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
      padding: 24px;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }

    /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
    h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    h1::before {
      content: 'ğŸ“…';
      font-size: 32px;
    }

    .version {
      font-size: 14px;
      color: #6b7280;
      font-weight: 400;
      margin-bottom: 24px;
    }

    h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 18px 0 12px;
      color: #374151;
    }

    /* ========== ã‚«ãƒ¼ãƒ‰ ========== */
    .card {
      border: none;
      border-radius: 16px;
      padding: 24px;
      margin: 16px 0;
      background: white;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .card:hover {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      transform: translateY(-2px);
    }

    .row { margin: 12px 0; }

    /* ========== ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  ========== */
    input[type="file"] {
      padding: 10px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: border-color 0.3s;
      background: #f9fafb;
    }
    input[type="file"]:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      resize: vertical;
      transition: border-color 0.3s;
    }
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* ========== ãƒœã‚¿ãƒ³ ========== */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      color: #374151;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button + button { margin-left: 12px; }

    /* ä¸»è¦ãƒœã‚¿ãƒ³ */
    #runBtn {
      font-size: 18px;
      padding: 16px 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    #runBtn:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }

    /* æˆåŠŸãƒœã‚¿ãƒ³ */
    #saveTeacherExcelBtn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      font-size: 16px;
      padding: 14px 28px;
      font-weight: 600;
    }
    #saveTeacherExcelBtn:hover {
      background: linear-gradient(135deg, #059669, #047857);
    }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    /* ========== ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« ========== */
    .small {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }
    .ok { color: #10b981; font-weight: 600; }
    .warn { color: #f59e0b; font-weight: 600; }
    .err { color: #ef4444; font-weight: 600; }
    .nowrap { white-space: nowrap; }

    /* ========== ãƒ†ãƒ¼ãƒ–ãƒ« ========== */
    #previewTable {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
    }
    #previewTable th, #previewTable td {
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      text-align: left;
      font-size: 13px;
    }
    #previewTable th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #d1d5db;
    }
    #previewTable tr:hover {
      background: #f9fafb;
    }
    #previewTable .empty { background: #fef3c7; }
    #previewTable .assigned { background: #d1fae5; }

    /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== */
    .main-container {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      width: 100%;
    }

    .sidebar-panel {
      flex: 0 0 400px;
      width: 400px;
      max-width: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      max-height: calc(100vh - 48px);
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®è¦ç´ ã‚’å¹…ã«åã‚ã‚‹ */
    .sidebar-panel .card {
      width: 100%;
      box-sizing: border-box;
    }

    .sidebar-panel input[type="file"],
    .sidebar-panel select,
    .sidebar-panel button,
    .sidebar-panel textarea {
      max-width: 100%;
      box-sizing: border-box;
      word-wrap: break-word;
    }

    .sidebar-panel table {
      width: 100%;
      table-layout: fixed;
    }

    .sidebar-panel .small {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .sidebar-panel h2 {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .preview-panel {
      flex: 1;
      min-width: 0;
      position: sticky;
      top: 24px;
      max-height: calc(100vh - 48px);
      overflow-y: auto;
    }

    /* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ========== */
    @media (max-width: 768px) {
      body { padding: 16px; }
      h1 { font-size: 24px; }
      .card { padding: 16px; }
      .grid { grid-template-columns: 1fr; }
      button { padding: 8px 16px; font-size: 13px; }
      #runBtn { font-size: 16px; padding: 12px 24px; }

      /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å°ç”»é¢ã§ã‚‚ç¶­æŒ */
      .sidebar-panel {
        flex: 0 0 280px;
        width: 280px;
        max-width: 280px;
        font-size: 12px;
      }
    }

    /* ========== ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body>
  <h1>SmartScheduler - æ™‚é–“å‰²è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ </h1>
  <div class="version">v1.6 - å€‹åˆ¥æŒ‡å°å¡¾å‘ã‘ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµå‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©</div>

  <div class="main-container">
    <!-- å·¦å´: æ“ä½œã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ -->
    <div class="sidebar-panel">
      <div class="card">
    <div class="row">
      <div class="small">å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«æå‡ºæ™‚é–“å‰²ï¼‰ã¨ç”Ÿå¾’ãƒ»è¬›å¸«æƒ…å ±ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€è¬›å¸«ã¨ç”Ÿå¾’ã‚’è‡ªå‹•é…ç½®ã—ã¾ã™ã€‚</div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘  ãƒ–ãƒ¼ã‚¹è¡¨ï¼ˆ.xlsxï¼‰ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="small">ãƒ–ãƒ¼ã‚¹ã®æ çµ„ã¿ãŒå®šç¾©ã•ã‚ŒãŸExcelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¤‡æ•°ã‚·ãƒ¼ãƒˆå¯¾å¿œï¼‰</div>
      <div class="row">
        <input type="file" id="boothExcelFile" accept=".xlsx,.xls,.xlsm" />
        <span id="boothExcelStatus" class="small"></span>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘¡ å…ƒã‚·ãƒ¼ãƒˆï¼ˆ.xlsxï¼‰ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="small">è¬›å¸«ã®æå‡ºã—ãŸæ™‚é–“å‰²ï¼ˆè¤‡æ•°ã‚·ãƒ¼ãƒˆå¯¾å¿œï¼‰</div>
      <div class="row">
        <input type="file" id="teacherExcelFile" accept=".xlsx,.xls" />
        <span id="teacherExcelStatus" class="small"></span>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘¢ ç”Ÿå¾’ãƒ»è¬›å¸«æƒ…å ±ï¼ˆ.xlsxï¼‰ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="small">ã€ŒæŒ‡å°å¯èƒ½æ•™ç§‘ä¸€è¦§ã€ã‚·ãƒ¼ãƒˆã¨ã€Œç”Ÿå¾’ã‚³ãƒæ•°è¡¨ã€ã‚·ãƒ¼ãƒˆã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«</div>
      <div class="row">
        <input type="file" id="studentExcelFile" accept=".xlsx,.xls" />
        <span id="studentExcelStatus" class="small"></span>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘£ è¬›å¸«ã®å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
      <div class="small">èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€è¬›å¸«ã”ã¨ã«å„ªå…ˆçš„ã«é…ç½®ã™ã‚‹ãƒ–ãƒ¼ã‚¹ã‚’è¨­å®šã§ãã¾ã™</div>
      <div class="row" style="margin-top:8px;">
        <button id="loadPreferenceBtn">è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
        <button id="savePreferenceBtn">è¨­å®šã‚’ä¿å­˜</button>
        <button id="hidePreferenceBtn">è¨­å®šã‚’éè¡¨ç¤º</button>
      </div>
      <div id="preferenceContainer" style="display:block; margin-top:12px; max-height:300px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px; padding:12px;">
        <table id="preferenceTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:4px 8px; border-bottom:1px solid #e5e7eb;">è¬›å¸«å</th>
              <th style="text-align:left; padding:4px 8px; border-bottom:1px solid #e5e7eb;">å„ªå…ˆãƒ–ãƒ¼ã‚¹</th>
            </tr>
          </thead>
          <tbody id="preferenceTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="row" style="margin-top:24px;">
      <button id="runBtn" style="font-size:16px; padding:12px 24px; font-weight:600;">â‘¤ è¬›å¸«ã‚’å‰²ã‚Šå½“ã¦ã‚‹</button>
      <span id="status" class="small"></span>
    </div>

    <!-- é€²è¡ŒçŠ¶æ³ãƒãƒ¼ -->
    <div id="progressContainer" style="display:none; margin-top:16px;">
      <div style="margin-bottom:8px;">
        <span id="progressText" style="font-size:14px; font-weight:600;"></span>
      </div>
      <div style="width:100%; background:#e5e7eb; border-radius:8px; height:24px; overflow:hidden;">
        <div id="progressBar" style="width:0%; background:linear-gradient(90deg, #3b82f6, #2563eb); height:100%; transition:width 0.3s; display:flex; align-items:center; justify-content:center; color:white; font-size:12px; font-weight:600;"></div>
      </div>
    </div>
  </div>

  <!-- ç”Ÿå¾’é¸æŠãƒ»å‰²ã‚Šå½“ã¦UI -->
  <div class="card" style="display:none;" id="studentSelectionCard">
    <h3 style="margin:0 0 16px 0; color:#1f2937;">â‘¥ ç”Ÿå¾’ã®å‰²ã‚Šå½“ã¦</h3>

    <div style="background:#f3f4f6; padding:12px; border-radius:6px; margin-bottom:16px;">
      <p style="margin:0; font-size:14px; color:#4b5563;">
        <strong>è¬›å¸«ã®å‰²ã‚Šå½“ã¦ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</strong><br>
        ç”Ÿå¾’ã‚’1äººé¸æŠã—ã¦ã€Œå‰²ã‚Šå½“ã¦ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®ç”Ÿå¾’ã®ã™ã¹ã¦ã®æˆæ¥­ãŒè‡ªå‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚
      </p>
    </div>

    <div class="row" style="gap:12px; align-items:center;">
      <label for="studentSelect" style="font-weight:600; color:#374151;">ç”Ÿå¾’ã‚’é¸æŠ:</label>
      <select id="studentSelect" style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; min-width:200px;">
        <option value="">-- ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>
      <button id="assignStudentBtn" style="padding:8px 24px; background:#3b82f6; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;" onclick="assignSelectedStudent()">
        é¸æŠã—ãŸç”Ÿå¾’ã‚’å‰²ã‚Šå½“ã¦
      </button>
    </div>

    <div id="studentAssignmentStatus" style="margin-top:16px; padding:12px; background:#f9fafb; border-radius:6px; display:none;">
      <h4 style="margin:0 0 8px 0; font-size:14px; color:#374151;">å‰²ã‚Šå½“ã¦çŠ¶æ³</h4>
      <div id="studentStatusList" style="font-size:13px; color:#6b7280;"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h2>â‘¦ çµæœã‚’ä¿å­˜</h2>
      <div class="small">è¬›å¸«ãŒé…ç½®ã•ã‚ŒãŸãƒ–ãƒ¼ã‚¹è¡¨ã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜ã—ã¾ã™</div>
    </div>
    <div class="row">
      <button id="saveTeacherExcelBtn" style="font-size:16px; padding:12px 24px; font-weight:600; background:#10b981; color:white; border:none;">è¬›å¸«é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsxã‚’ä¿å­˜</button>
      <span id="excelStatus" class="small"></span>
    </div>
  </div>

  <div class="card">
    <div class="row nowrap"><strong>å¿…è¦ã‚³ãƒæ•°ç¢ºèªè¡¨</strong></div>
    <div class="small">ç”Ÿå¾’ã”ã¨ã®å¿…è¦ã‚³ãƒæ•°ã¨å‰²ã‚Šå½“ã¦æ¸ˆã¿ã‚³ãƒæ•°ã‚’ç¢ºèªã§ãã¾ã™</div>
    <div class="row">
      <button id="toggleRequiredClassBtn">ç¢ºèªè¡¨ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
    </div>
    <div id="requiredClassContainer" style="display:none; margin-top:12px; overflow-x:auto;">
      <table id="requiredClassTable" style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr>
            <th style="border:1px solid #d1d5db; padding:8px; background:#f3f4f6;">ç”Ÿå¾’å</th>
            <th style="border:1px solid #d1d5db; padding:8px; background:#f3f4f6;">ç§‘ç›®</th>
            <th style="border:1px solid #d1d5db; padding:8px; background:#f3f4f6;">å¿…è¦ã‚³ãƒæ•°</th>
            <th style="border:1px solid #d1d5db; padding:8px; background:#f3f4f6;">å‰²å½“æ¸ˆã¿</th>
            <th style="border:1px solid #d1d5db; padding:8px; background:#f3f4f6;">é”æˆç‡</th>
          </tr>
        </thead>
        <tbody id="requiredClassTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" style="display:none;" id="advancedCard">
    <div class="row">
      <button id="toggleAdvancedBtn">è©³ç´°è¨­å®šãƒ»ãã®ä»–ã®å‡ºåŠ›ã‚’è¡¨ç¤º</button>
    </div>
    <div id="advancedContent" style="display:none; margin-top:12px;">
      <div class="row">
        <strong>æ¤œçŸ¥ãƒ¬ãƒãƒ¼ãƒˆ</strong>
        <div class="small">æœªå‰²å½“ã‚„è­¦å‘Šã®ä¸€è¦§</div>
      </div>
      <textarea id="reportOut" placeholder="è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»æœªå‰²å½“ãªã©ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™" style="min-height:100px;"></textarea>
      <div class="row">
        <button id="copyReportBtn">ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="saveReportBtn">ãƒ¬ãƒãƒ¼ãƒˆ(CSV)ä¿å­˜</button>
      </div>

      <div class="row" style="margin-top:16px;">
        <strong>CSVå‡ºåŠ›</strong>
        <div class="small">è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆdate,time,boothId,teacherId,teacherName,studentId,subjectï¼‰</div>
      </div>
      <textarea id="assignmentsOut" placeholder="å®Ÿè¡Œå¾Œã«ã“ã“ã¸å‡ºåŠ›" style="min-height:100px;"></textarea>
      <div class="row">
        <button id="copyCsvBtn">CSVã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="saveCsvBtn">CSVã§ä¿å­˜</button>
      </div>

      <div class="row" style="margin-top:16px;">
        <button id="saveLogBtn">å®Ÿè¡Œãƒ­ã‚°(JSON)ä¿å­˜</button>
        <button id="saveTextLogBtn">å®Ÿè¡Œãƒ­ã‚°(ãƒ†ã‚­ã‚¹ãƒˆ)ä¿å­˜</button>
      </div>
    </div>
  </div>

    </div> <!-- sidebar-panel -->

    <!-- å³å´: å‰²ã‚Šå½“ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
    <div class="preview-panel">
      <div class="card">
        <div class="row nowrap"><strong>å‰²å½“çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong></div>
        <div id="previewContainer" style="margin-top:12px; overflow-x:auto;">
          <table id="previewTable" style="border-collapse:collapse; font-size:12px; min-width:100%;">
            <tr><td style="padding:20px; text-align:center; color:#9ca3af;">å‰²ã‚Šå½“ã¦ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</td></tr>
          </table>
        </div>
      </div>
    </div>

  </div> <!-- main-container -->

  <script>
  (() => {
    const $ = id => document.getElementById(id);

    const assignmentsOut = $('assignmentsOut');
    const reportOut = $('reportOut');
    const status = $('status');
    const excelStatus = $('excelStatus');

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¿
    $('boothExcelFile').onchange = () => parseBoothExcel($('boothExcelFile'));
    $('teacherExcelFile').onchange = () => parseTeacherExcel($('teacherExcelFile'));
    $('studentExcelFile').onchange = () => parseStudentDemandExcel($('studentExcelFile'));

    $('runBtn').onclick = run;
    $('saveTeacherExcelBtn').onclick = () => saveAsExcel('teacher');
    $('toggleRequiredClassBtn').onclick = toggleRequiredClass;
    $('toggleAdvancedBtn').onclick = toggleAdvanced;

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã«ã‚ˆã‚‹å‰²ã‚Šå½“ã¦æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
    document.addEventListener('updateAssignment', (e) => {
      const { fromDate, fromTime, fromBooth, toDate, toTime, toBooth } = e.detail;

      // ãƒ‰ãƒ©ãƒƒã‚°å…ƒã®assignmentã‚’è¦‹ã¤ã‘ã‚‹
      const fromIndex = lastAssignments.findIndex(a =>
        a.date === fromDate && a.time === fromTime && a.boothId === fromBooth
      );

      // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®assignmentã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã‚‚ã‚ã‚‹ï¼‰
      const toIndex = lastAssignments.findIndex(a =>
        a.date === toDate && a.time === toTime && a.boothId === toBooth
      );

      if(fromIndex === -1){
        console.warn('ãƒ‰ãƒ©ãƒƒã‚°å…ƒã®assignmentãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      const fromAssignment = lastAssignments[fromIndex];

      if(toIndex !== -1){
        // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã«æ—¢ã«assignmentãŒã‚ã‚‹å ´åˆã¯å…¥ã‚Œæ›¿ãˆ
        const toAssignment = lastAssignments[toIndex];

        // fromAssignmentã®ä½ç½®æƒ…å ±ã‚’æ›´æ–°
        fromAssignment.date = toDate;
        fromAssignment.time = toTime;
        fromAssignment.boothId = toBooth;

        // toAssignmentã®ä½ç½®æƒ…å ±ã‚’æ›´æ–°
        toAssignment.date = fromDate;
        toAssignment.time = fromTime;
        toAssignment.boothId = fromBooth;

        console.log('âœ“ å‰²ã‚Šå½“ã¦ã‚’å…¥ã‚Œæ›¿ãˆã¾ã—ãŸ');
      } else {
        // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆãŒç©ºã®å ´åˆã¯ç§»å‹•ã®ã¿
        fromAssignment.date = toDate;
        fromAssignment.time = toTime;
        fromAssignment.boothId = toBooth;

        console.log('âœ“ å‰²ã‚Šå½“ã¦ã‚’ç§»å‹•ã—ã¾ã—ãŸ');
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»
      renderPreview();
      // å¿…è¦ã‚³ãƒæ•°ç¢ºèªè¡¨ã‚‚æ›´æ–°
      if($('requiredClassContainer').style.display !== 'none'){
        renderRequiredClassTable();
      }
      toast('å‰²ã‚Šå½“ã¦ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'ok');
    });

    // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š
    $('hidePreferenceBtn').onclick = togglePreferenceSettings;
    $('savePreferenceBtn').onclick = savePreferenceSettings;
    $('loadPreferenceBtn').onclick = loadPreferenceSettings;

    // è©³ç´°è¨­å®š
    $('copyCsvBtn').onclick = () => copyToClipboard(assignmentsOut.value);
    $('saveCsvBtn').onclick = () => downloadText(assignmentsOut.value, makeTsPrefix() + '_assignments.csv', 'text/csv');
    $('saveLogBtn').onclick = () => downloadText(JSON.stringify(lastLog, null, 2), makeTsPrefix() + '_run_log.json', 'application/json');
    $('saveTextLogBtn').onclick = () => downloadText(executionLog.join('\n'), makeTsPrefix() + '_execution_log.txt', 'text/plain');
    $('copyReportBtn').onclick = () => copyToClipboard(reportOut.value);
    $('saveReportBtn').onclick = () => downloadText(reportOut.value, makeTsPrefix() + '_report.csv', 'text/csv');

    function toggleAdvanced(){
      const content = $('advancedContent');
      if(content.style.display === 'none'){
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        toast('CSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'ok');
      }).catch(() => toast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'err'));
    }

    function downloadText(content, filename, mime) {
      const blob = new Blob([content], { type: mime || 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function toast(msg, cls) { status.textContent = msg; status.className = 'small ' + (cls || ''); }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function makeTsPrefix(){ const d=new Date(); return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`; }

    // é€²è¡ŒçŠ¶æ³ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateProgress(percent, text) {
      const container = document.getElementById('progressContainer');
      const bar = document.getElementById('progressBar');
      const textEl = document.getElementById('progressText');

      container.style.display = 'block';
      bar.style.width = percent + '%';
      bar.textContent = Math.round(percent) + '%';
      textEl.textContent = text;
    }

    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
    }

    // ---- Core ----
    let lastLog = { startedAt: null, warnings: [], decisions: [] };
    let lastAssignments = []; // å‰²å½“çµæœã‚’ä¿å­˜
    let boothData = []; // å…ƒã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ï¼ˆè¬›å¸«æå‡ºæ™‚é–“å‰²ï¼‰
    let teacherData = []; // ï¼ˆæœªä½¿ç”¨ - äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
    let studentDemandData = []; // ç”Ÿå¾’ã‚³ãƒæ•°è¡¨ã‹ã‚‰èª­ã¿è¾¼ã‚“ã éœ€è¦ãƒ‡ãƒ¼ã‚¿
    let teacherSubjectMap = {}; // è¬›å¸«ã®æŒ‡å°å¯èƒ½ç§‘ç›®ãƒãƒƒãƒ— { teacherId: ['ç®—æ•°', 'å›½èª', ...] }
    let teacherNameMap = {}; // è¬›å¸«IDã‹ã‚‰è¬›å¸«åã¸ã®ãƒãƒƒãƒ— { teacherId: teacherName }
    let originalBoothWorkbook = null; // å…ƒã®ãƒ–ãƒ¼ã‚¹è¡¨ExcelJSãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ï¼ˆæ›¸å¼å®Œå…¨ä¿æŒï¼‰
    let boothSheetInfo = {}; // ãƒ–ãƒ¼ã‚¹è¡¨ã®ã‚·ãƒ¼ãƒˆæƒ…å ±ï¼ˆè¡Œãƒ»åˆ—ã®ä½ç½®ï¼‰
    let teacherPreferences = {}; // è¬›å¸«ã®å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š { teacherId: 'B1' }
    let studentAssignmentHistory = {}; // ç”Ÿå¾’ã®å‰²ã‚Šå½“ã¦å±¥æ­´ { studentId_subject: [{dayOfWeek, time, teacherId}] }
    let studentAssignedCount = {}; // ç”Ÿå¾’ã®ç§‘ç›®åˆ¥å‰²ã‚Šå½“ã¦æ¸ˆã¿ã‚³ãƒæ•° { studentId_subject: count }
    let studentDailyBooth = {}; // ç”Ÿå¾’ã®æ—¥åˆ¥ãƒ–ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦ { studentId_subject_date: boothId }
    let executionLog = []; // å®Ÿè¡Œãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹é…åˆ—

    // ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
    function logMessage(message) {
      const timestamp = new Date().toISOString().substring(11, 19); // HH:MM:SS
      const logEntry = `[${timestamp}] ${message}`;
      executionLog.push(logEntry);
      console.log(message); // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
    }

    function key(dt){ return dt.date + ' ' + dt.time; }
    function sameTime(a,b){ return a.date===b.date && a.time===b.time; }

    function groupBy(arr, f){
      const m = new Map();
      for(const x of arr){
        const k = f(x);
        const g = m.get(k); if(g) g.push(x); else m.set(k, [x]);
      }
      return m;
    }

    // ç”Ÿå¾’éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜ãƒ»æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã«å±•é–‹
    function expandStudentDemands(studentDemands, slots){
      if (!studentDemands || studentDemands.length === 0) return [];

      const expanded = [];
      const dayMap = { 'æœˆ': 1, 'ç«': 2, 'æ°´': 3, 'æœ¨': 4, 'é‡‘': 5, 'åœŸ': 6, 'æ—¥': 0 };

      // ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã¨æ™‚åˆ»ã®çµ„ã¿åˆã‚ã›ã‚’å–å¾—
      const availableSlots = new Set();
      for (const slot of slots) {
        availableSlots.add(`${slot.date}|${slot.time}`);
      }

      for (const demand of studentDemands) {
        // å¸Œæœ›æ™‚é–“ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (demand.preferredTimes && demand.preferredTimes.length > 0) {
          // å¸Œæœ›æ™‚é–“ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆä¾‹: "æœˆ17" -> æ›œæ—¥: æœˆ, æ™‚åˆ»: 17:00:00ï¼‰
          for (const timeSpec of demand.preferredTimes) {
            const dayChar = timeSpec.charAt(0);
            const hourStr = timeSpec.substring(1);
            const hour = parseInt(hourStr);

            if (!dayMap.hasOwnProperty(dayChar) || isNaN(hour)) {
              console.warn(`ç„¡åŠ¹ãªå¸Œæœ›æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${timeSpec}`);
              continue;
            }

            const targetDayOfWeek = dayMap[dayChar];
            const timeStr = `${pad2(hour)}:00:00`;

            // ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰è©²å½“ã™ã‚‹æ—¥ä»˜ã‚’æ¢ã™
            for (const slot of slots) {
              const dateObj = new Date(slot.date);
              const dayOfWeek = dateObj.getDay();

              if (dayOfWeek === targetDayOfWeek && slot.time === timeStr) {
                // NGæ—¥ç¨‹ã®ãƒã‚§ãƒƒã‚¯
                if (demand.ngDays && demand.ngDays.includes(dayChar)) {
                  continue; // NGæ—¥ç¨‹ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
                }

                // NGTeachersã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆè¬›å¸«åã‹ã‚‰IDå½¢å¼ã«å¤‰æ›ï¼‰
                const ngTeachersSet = new Set();
                if (demand.ngTeachers) {
                  for (const teacherName of demand.ngTeachers) {
                    // "è¥¿T" -> "nishiT" ã®ã‚ˆã†ãªå½¢å¼ã«å¤‰æ›
                    ngTeachersSet.add(idFromName(teacherName));
                  }
                }

                expanded.push({
                  date: slot.date,
                  time: slot.time,
                  studentId: demand.studentId,
                  studentName: demand.studentName,
                  subject: demand.subject,
                  grade: demand.grade,
                  preferredTeacherId: demand.preferredTeachers && demand.preferredTeachers.length > 0
                    ? idFromName(demand.preferredTeachers[0])
                    : null,
                  ngTeachers: Array.from(ngTeachersSet),
                  ngStudents: demand.ngStudents || [],
                  priority: demand.priority || 5
                });
              }
            }
          }
        } else {
          // å¸Œæœ›æ™‚é–“ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ã‚¹ãƒ­ãƒƒãƒˆã«å±•é–‹
          for (const slot of slots) {
            const dateObj = new Date(slot.date);
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayChar = dayNames[dateObj.getDay()];

            // NGæ—¥ç¨‹ã®ãƒã‚§ãƒƒã‚¯
            if (demand.ngDays && demand.ngDays.includes(dayChar)) {
              continue;
            }

            const ngTeachersSet = new Set();
            if (demand.ngTeachers) {
              for (const teacherName of demand.ngTeachers) {
                ngTeachersSet.add(idFromName(teacherName));
              }
            }

            expanded.push({
              date: slot.date,
              time: slot.time,
              studentId: demand.studentId,
              studentName: demand.studentName,
              subject: demand.subject,
              grade: demand.grade,
              preferredTeacherId: demand.preferredTeachers && demand.preferredTeachers.length > 0
                ? idFromName(demand.preferredTeachers[0])
                : null,
              ngTeachers: Array.from(ngTeachersSet),
              ngStudents: demand.ngStudents || [],
              priority: demand.priority || 5
            });
          }
        }
      }

      return expanded;
    }

    async function run(){
      lastLog = { startedAt: new Date().toISOString(), warnings: [], decisions: [] };
      lastAssignments = [];
      studentAssignmentHistory = {}; // ãƒªã‚»ãƒƒãƒˆ
      studentAssignedCount = {}; // ãƒªã‚»ãƒƒãƒˆ
      studentDailyBooth = {}; // ãƒªã‚»ãƒƒãƒˆ
      assignmentsOut.value = '';
      reportOut.value = '';
      executionLog = []; // ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

      // é€²è¡ŒçŠ¶æ³ãƒãƒ¼ã‚’åˆæœŸåŒ–
      updateProgress(0, 'åˆæœŸåŒ–ä¸­...');

      try{
        if(boothData.length === 0){
          hideProgress();
          throw new Error('ãƒ–ãƒ¼ã‚¹è¡¨ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        }

        // è¬›å¸«-ç§‘ç›®ãƒãƒƒãƒ—ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
        if(!teacherSubjectMap || Object.keys(teacherSubjectMap).length === 0){
          hideProgress();
          throw new Error('è¬›å¸«ã®æŒ‡å°å¯èƒ½ç§‘ç›®æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼ˆç”Ÿå¾’ãƒ»è¬›å¸«æƒ…å ±.xlsxã®ã€ŒæŒ‡å°å¯èƒ½æ•™ç§‘ä¸€è¦§ã€ã‚·ãƒ¼ãƒˆï¼‰');
        }

        updateProgress(5, 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        await new Promise(resolve => setTimeout(resolve, 10)); // UIæ›´æ–°ã®ãŸã‚ã®å¾…æ©Ÿ

        logMessage('=== å‰²ã‚Šå½“ã¦é–‹å§‹ ===');
        logMessage('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š: ' + JSON.stringify(teacherPreferences));
        logMessage('ç”Ÿå¾’éœ€è¦ãƒ‡ãƒ¼ã‚¿: ' + studentDemandData.length + 'ä»¶');
        logMessage('è¬›å¸«-ç§‘ç›®ãƒãƒƒãƒ—: ' + JSON.stringify(teacherSubjectMap));
        logMessage('ãƒ–ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ' + boothData.length);

        const slots = boothData;

        // è¬›å¸«ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã‚·ãƒ¼ãƒˆï¼ˆteacherDataï¼‰ã‹ã‚‰å–å¾—
        // teacherDataãŒç©ºã®å ´åˆã¯ã€å…¨è¬›å¸«ã‚’å…¨ã‚¹ãƒ­ãƒƒãƒˆã«å‰²ã‚Šå½“ã¦å¯èƒ½ã¨ã—ã¦è¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        let teachers = [];
        if(teacherData && teacherData.length > 0){
          logMessage('å…ƒã‚·ãƒ¼ãƒˆã‹ã‚‰è¬›å¸«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨: ' + teacherData.length + 'ä»¶');
          teachers = teacherData;
        } else {
          logMessage('âš ï¸ å…ƒã‚·ãƒ¼ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…¨è¬›å¸«ã‚’å…¨ã‚¹ãƒ­ãƒƒãƒˆã«å‰²ã‚Šå½“ã¦å¯èƒ½ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚');
          const allTeacherIds = Object.keys(teacherSubjectMap);
          logMessage('åˆ©ç”¨å¯èƒ½ãªè¬›å¸«: ' + allTeacherIds.join(', '));

          // boothDataã®å„ã‚¹ãƒ­ãƒƒãƒˆã«å¯¾ã—ã¦ã€å…¨è¬›å¸«ã‚’å€™è£œã¨ã—ã¦è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          for(const slot of boothData){
            for(const teacherId of allTeacherIds){
              teachers.push({
                date: slot.date,
                time: slot.time,
                teacherId: teacherId,
                teacherName: teacherNameMap[teacherId] || teacherId,
                constraints: {}
              });
            }
          }
        }
        console.log('è¬›å¸«å‰²ã‚Šå½“ã¦å€™è£œæ•°:', teachers.length);

        // ç”Ÿå¾’éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜ãƒ»æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã«å±•é–‹
        const demands = expandStudentDemands(studentDemandData, slots);
        console.log('å±•é–‹å¾Œã®éœ€è¦ãƒ‡ãƒ¼ã‚¿:', demands.length, 'ä»¶');
        if(demands.length > 0) {
          console.log('éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ« (æœ€åˆã®3ä»¶):');
          demands.slice(0, 3).forEach(d => {
            console.log('  -', d.studentName, d.subject, d.date, d.time, 'NGè¬›å¸«:', d.ngTeachers);
          });
        }

        // index by time
        const slotsByTime = groupBy(slots, s => key(s));
        const teachersByTime = groupBy(teachers, t => key(t));
        const demandByTime = groupBy(demands, d => key(d));

        // track usage
        const usedTeacherAt = new Set(); // key(time + teacherId)
        const teacherDailyCount = new Map(); // key(date + teacherId) -> count
        const teacherDailyBooth = new Map(); // key(date + teacherId) -> boothId (1æ—¥å†…ã§ãƒ–ãƒ¼ã‚¹å›ºå®š)

        // å„è¬›å¸«ã®æ—¥ä»˜ã”ã¨ã®æœ€æ—©å‡ºå‹¤æ™‚åˆ»ã‚’è¨ˆç®—
        const teacherEarliestTime = new Map(); // key(date + ' ' + teacherId) -> earliest time string
        for(const t of teachers){
          const dailyKey = t.date + ' ' + t.teacherId;
          const currentEarliest = teacherEarliestTime.get(dailyKey);
          if(!currentEarliest || t.time < currentEarliest){
            teacherEarliestTime.set(dailyKey, t.time);
          }
        }
        logMessage('è¬›å¸«ã®æœ€æ—©å‡ºå‹¤æ™‚åˆ»ã‚’è¨ˆç®—å®Œäº†: ' + teacherEarliestTime.size + 'ä»¶');
        // ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼ˆæœ€åˆã®5ä»¶ï¼‰
        let count = 0;
        for(const [key, time] of teacherEarliestTime.entries()){
          if(count >= 5) break;
          const [date, teacherId] = key.split(' ');
          const teacherName = teacherNameMap[teacherId] || teacherId;
          logMessage(`  ${teacherName} (${date}): ${time}`);
          count++;
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: è¬›å¸«ãŒæŒ‡å®šãƒ–ãƒ¼ã‚¹ã«å‰²ã‚Šå½“ã¦å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®šãƒ«ãƒ¼ãƒ«ï¼‰
        const canAssignTeacherToBooth = (teacher, boothId) => {
          const dailyKey = teacher.date + ' ' + teacher.teacherId;
          const assignedBooth = teacherDailyBooth.get(dailyKey);
          // æœªå‰²ã‚Šå½“ã¦ã‹ã€åŒã˜ãƒ–ãƒ¼ã‚¹ã®å ´åˆã®ã¿OK
          return !assignedBooth || assignedBooth === boothId;
        };

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å‚ç…§
        const canTeachSubject = window.canTeachSubject;

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: NGç”Ÿå¾’ãŒåŒã˜æ™‚é–“å¸¯ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        const hasNgStudentConflict = (demand, assignedStudentsInTime) => {
          // NGç”Ÿå¾’ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã¯å¸¸ã«OK
          if (!demand.ngStudents || demand.ngStudents.length === 0) return false;

          // åŒã˜æ™‚é–“å¸¯ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ç”Ÿå¾’ãƒªã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          for (const ngStudent of demand.ngStudents) {
            if (assignedStudentsInTime.has(ngStudent)) {
              console.log(`  âš ï¸ NGç”Ÿå¾’æ¤œå‡º: ${demand.studentName} ã®NGç”Ÿå¾’ ${ngStudent} ãŒåŒã˜æ™‚é–“å¸¯ã«å­˜åœ¨`);
              return true; // NGç”Ÿå¾’ãŒè¦‹ã¤ã‹ã£ãŸ
            }
          }
          return false; // NGç”Ÿå¾’ãªã—
        };

        const lines = [ 'date,time,boothId,teacherId,teacherName,studentId,subject' ];

        updateProgress(10, 'è¬›å¸«ã®å‰²ã‚Šå½“ã¦ã‚’æº–å‚™ä¸­...');
        await new Promise(resolve => setTimeout(resolve, 10));

        // Iterate over time slots in chronological order
        const times = Array.from(new Set([...slots.map(slot => key(slot))])).sort();
        const totalTimes = times.length;
        let processedTimes = 0;

        for(const tkey of times){
          // é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–° (10-60%ã®ç¯„å›²ã§)
          processedTimes++;
          const progressPercent = 10 + (processedTimes / totalTimes) * 50;
          if(processedTimes % Math.max(1, Math.floor(totalTimes / 20)) === 0){
            updateProgress(progressPercent, `è¬›å¸«ã‚’å‰²ã‚Šå½“ã¦ä¸­... (${processedTimes}/${totalTimes} æ™‚é–“å¸¯)`);
            await new Promise(resolve => setTimeout(resolve, 1));
          }
          const sList = slotsByTime.get(tkey) || [];
          const thList = (teachersByTime.get(tkey) || []).slice();
          const ddList = (demandByTime.get(tkey) || []).slice();

          // Sort teachers by: 1) earliest start time, 2) fewer assigned today
          thList.sort((a,b) => {
            const aKey = a.date + ' ' + a.teacherId;
            const bKey = b.date + ' ' + b.teacherId;
            // å„ªå…ˆåº¦1: å‡ºå‹¤é–‹å§‹æ™‚åˆ»ãŒæ—©ã„è¬›å¸«ã‚’å„ªå…ˆ
            const aEarliest = teacherEarliestTime.get(aKey) || '99:99:99';
            const bEarliest = teacherEarliestTime.get(bKey) || '99:99:99';
            if(aEarliest !== bEarliest) return aEarliest.localeCompare(bEarliest);
            // å„ªå…ˆåº¦2: ãã®æ—¥ã®å‰²ã‚Šå½“ã¦æ•°ãŒå°‘ãªã„è¬›å¸«ã‚’å„ªå…ˆ
            return (teacherDailyCount.get(aKey)||0) - (teacherDailyCount.get(bKey)||0);
          });

          // Sort demands by priority desc
          ddList.sort((a,b) => (b.priority||0) - (a.priority||0));

          // Build NG map for quick check
          const ngTeachersMap = new Map();
          for(const d of ddList){
            const ng = new Set(d.ngTeachers || []);
            ngTeachersMap.set(d.studentId, ng);
          }

          // å‰²ã‚Šå½“ã¦æ¸ˆã¿ãƒ–ãƒ¼ã‚¹ã‚’è¿½è·¡
          const assignedSlotsInTime = new Set(); // 'boothId'
          // åŒã˜æ™‚é–“å¸¯ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã®ç”Ÿå¾’ã‚’è¿½è·¡ï¼ˆNGç”Ÿå¾’ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
          const assignedStudentsInTime = new Set(); // 'studentId'

          // === ãƒ•ã‚§ãƒ¼ã‚º1: å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒã‚ã‚‹è¬›å¸«ã‚’å„ªå…ˆçš„ã«é…ç½® ===
          logMessage(`\nğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º1: å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒã‚ã‚‹è¬›å¸«ã‚’å„ªå…ˆé…ç½® (${tkey})`);
          for(const teacher of thList){
            const prefBooth = teacherPreferences[teacher.teacherId];
            if(!prefBooth) continue; // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒãªã„è¬›å¸«ã¯ã‚¹ã‚­ãƒƒãƒ—
            if(prefBooth === 'EXCLUDE') {
              logMessage(`  â›” ${teacher.teacherName}: é™¤å¤–è¨­å®šã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—`);
              continue; // é™¤å¤–è¨­å®šã®è¬›å¸«ã¯ã‚¹ã‚­ãƒƒãƒ—
            }

            const isTeacherAvailable = !usedTeacherAt.has(tkey+' '+teacher.teacherId);
            if(!isTeacherAvailable) continue; // æ—¢ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿

            // ã“ã®è¬›å¸«ã®å„ªå…ˆãƒ–ãƒ¼ã‚¹ã‚’æ¢ã™
            const targetSlot = sList.find(s => s.boothId === prefBooth && !assignedSlotsInTime.has(s.boothId));
            if(!targetSlot) continue; // å„ªå…ˆãƒ–ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„oræ—¢ã«åŸ‹ã¾ã£ã¦ã„ã‚‹

            // 1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®šãƒã‚§ãƒƒã‚¯
            const dailyKey = teacher.date + ' ' + teacher.teacherId;
            const existingBooth = teacherDailyBooth.get(dailyKey);
            if(existingBooth && existingBooth !== prefBooth){
              logMessage(`  âš ï¸ ${teacher.teacherName}: å„ªå…ˆãƒ–ãƒ¼ã‚¹${prefBooth}ã ãŒã€æ—¢ã«${existingBooth}ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ â†’ ã‚¹ã‚­ãƒƒãƒ—`);
              continue;
            }

            // å‰²ã‚Šå½“ã¦å®Ÿè¡Œ
            usedTeacherAt.add(tkey+' '+teacher.teacherId);
            teacherDailyCount.set(dailyKey, (teacherDailyCount.get(dailyKey)||0) + 1);
            assignedSlotsInTime.add(targetSlot.boothId);

            if (!teacherDailyBooth.has(dailyKey)) {
              teacherDailyBooth.set(dailyKey, targetSlot.boothId);
              logMessage(`  âœ“ å„ªå…ˆãƒ–ãƒ¼ã‚¹åˆå›å‰²ã‚Šå½“ã¦: ${teacher.teacherName} -> ${targetSlot.boothId}`);
            } else {
              logMessage(`  âœ“ å„ªå…ˆãƒ–ãƒ¼ã‚¹ç¶™ç¶š: ${teacher.teacherName} -> ${targetSlot.boothId}`);
            }

            const assignmentRecord = {
              date: targetSlot.date,
              time: targetSlot.time,
              boothId: targetSlot.boothId,
              teacherId: teacher.teacherId,
              teacherName: teacher.teacherName||'',
              students: [] // æœ€å¤§2äººã¾ã§å¾Œã§è¿½åŠ 
            };
            lastAssignments.push(assignmentRecord);
            lines.push([targetSlot.date, targetSlot.time, targetSlot.boothId, teacher.teacherId, (teacher.teacherName||''), '', ''].join(','));
            lastLog.decisions.push({ tkey, boothId: targetSlot.boothId, teacherId: teacher.teacherId, studentId: null });
          }

          logMessage(`\nğŸ“‹ ãƒ•ã‚§ãƒ¼ã‚º2: æ®‹ã‚Šã®ãƒ–ãƒ¼ã‚¹ã‚’é€šå¸¸å‰²ã‚Šå½“ã¦ (${tkey})`);
          // === ãƒ•ã‚§ãƒ¼ã‚º2: æ®‹ã‚Šã®ãƒ–ãƒ¼ã‚¹ã‚’é€šå¸¸é€šã‚ŠåŸ‹ã‚ã‚‹ ===
          // ãƒ–ãƒ¼ã‚¹ç•ªå·ãŒå°ã•ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆä¾‹: B1, B2, ..., B10ï¼‰
          const sortedSlots = [...sList].sort((a, b) => {
            const aNum = parseInt(a.boothId.replace(/[^\d]/g, '')) || 0;
            const bNum = parseInt(b.boothId.replace(/[^\d]/g, '')) || 0;
            return aNum - bNum;
          });

          // Try to satisfy demands first per booth
          for(const slot of sortedSlots){
            // æ—¢ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã®ãƒ–ãƒ¼ã‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—
            if(assignedSlotsInTime.has(slot.boothId)) continue;
            let assignedTeacher = null;
            let assignedDemand = null;

            // find demand preferring preferredTeacher first
            let candidates = ddList;
            for(const demand of candidates){
              // NGç”Ÿå¾’ãƒã‚§ãƒƒã‚¯: åŒã˜æ™‚é–“å¸¯ã«NGç”Ÿå¾’ãŒã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
              if (hasNgStudentConflict(demand, assignedStudentsInTime)) {
                continue; // ã“ã®éœ€è¦ã¯å¾Œå›ã—ã«ã™ã‚‹
              }

              // skip if NG teacher list prohibits preferred teacher and we will try others
              const preferred = demand.preferredTeacherId || null;
              const ngSet = ngTeachersMap.get(demand.studentId) || new Set();

              // Attempt preferred first
              if (preferred && !ngSet.has(preferred)){
                const th = thList.find(x =>
                  x.teacherId === preferred &&
                  !usedTeacherAt.has(tkey+' '+x.teacherId) &&
                  teacherPreferences[x.teacherId] !== 'EXCLUDE' &&
                  canAssignTeacherToBooth(x, slot.boothId) &&  // 1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®šãƒã‚§ãƒƒã‚¯
                  canTeachSubject(x.teacherId, demand.subject)  // ç§‘ç›®æŒ‡å°å¯èƒ½ãƒã‚§ãƒƒã‚¯
                );
                if (th){ assignedTeacher = th; assignedDemand = demand; }
              }

              if (!assignedTeacher){
                // pick any available teacher not in NG
                const th2 = thList.find(x =>
                  !usedTeacherAt.has(tkey+' '+x.teacherId) &&
                  !ngSet.has(x.teacherId) &&
                  teacherPreferences[x.teacherId] !== 'EXCLUDE' &&
                  canAssignTeacherToBooth(x, slot.boothId) &&  // 1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®šãƒã‚§ãƒƒã‚¯
                  canTeachSubject(x.teacherId, demand.subject)  // ç§‘ç›®æŒ‡å°å¯èƒ½ãƒã‚§ãƒƒã‚¯
                );
                if (th2){ assignedTeacher = th2; assignedDemand = demand; }
              }

              if (assignedTeacher) break;
            }

            // ç”Ÿå¾’éœ€è¦ãŒãªã„å ´åˆã§ã‚‚ã€å…ƒã‚·ãƒ¼ãƒˆã§æå‡ºã•ã‚ŒãŸæ™‚é–“ã«ã¯è¬›å¸«ã‚’é…ç½®
            if (!assignedTeacher){
              // å„ªå…ˆåº¦1: ãã®æ—¥æ—¢ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãƒ–ãƒ¼ã‚¹ãŒã‚ã‚Œã°ã€ãã®ãƒ–ãƒ¼ã‚¹ã‚’ä½¿ã†ï¼ˆ1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®šï¼‰
              const existingBoothTeacher = thList.find(x => {
                const dailyKey = slot.date + ' ' + x.teacherId;
                const assignedBooth = teacherDailyBooth.get(dailyKey);
                return !usedTeacherAt.has(tkey+' '+x.teacherId) &&
                       assignedBooth === slot.boothId &&
                       teacherPreferences[x.teacherId] !== 'EXCLUDE';
              });

              if (existingBoothTeacher) {
                assignedTeacher = existingBoothTeacher;
                console.log(`  âœ“ 1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®š: ${existingBoothTeacher.teacherName} -> ${slot.boothId}`);
              }

              // å„ªå…ˆåº¦2: ç©ºã„ã¦ã„ã‚‹è¬›å¸«ï¼ˆé€šå¸¸å‰²ã‚Šå½“ã¦ï¼‰
              // ãŸã ã—ã€1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®šãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆï¼ˆæ—¢ã«åˆ¥ã®ãƒ–ãƒ¼ã‚¹ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã®è¬›å¸«ã¯é™¤å¤–ï¼‰
              // thListã¯æ—¢ã«å‡ºå‹¤æ™‚åˆ»ãŒæ—©ã„é †ã«ã‚½ãƒ¼ãƒˆæ¸ˆã¿
              if (!assignedTeacher) {
                // åˆå›å‰²ã‚Šå½“ã¦ã®å ´åˆã€ã“ã®è¬›å¸«ãŒä»Šå¾Œã‚‚åŒã˜ãƒ–ãƒ¼ã‚¹ã‚’ä½¿ãˆã‚‹ã‹äº‹å‰ãƒã‚§ãƒƒã‚¯
                for(const candidateTeacher of thList){
                  if(usedTeacherAt.has(tkey+' '+candidateTeacher.teacherId)) continue;
                  if(teacherPreferences[candidateTeacher.teacherId] === 'EXCLUDE') continue;
                  if(!canAssignTeacherToBooth(candidateTeacher, slot.boothId)) continue;

                  const dailyKey = candidateTeacher.date + ' ' + candidateTeacher.teacherId;
                  const existingBooth = teacherDailyBooth.get(dailyKey);

                  // æ—¢ã«ãƒ–ãƒ¼ã‚¹ãŒæ±ºã¾ã£ã¦ã„ã‚‹å ´åˆ: ãã®ãƒ–ãƒ¼ã‚¹ã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                  if(existingBooth){
                    if(existingBooth === slot.boothId){
                      assignedTeacher = candidateTeacher;
                      const earliestTime = teacherEarliestTime.get(dailyKey) || 'ä¸æ˜';
                      console.log(`  â†’ é€šå¸¸å‰²ã‚Šå½“ã¦: ${candidateTeacher.teacherName} (æœ€æ—©å‡ºå‹¤: ${earliestTime}, æ—¢å­˜ãƒ–ãƒ¼ã‚¹: ${existingBooth}) -> ${slot.boothId}`);
                      break;
                    }
                  } else {
                    // åˆå›å‰²ã‚Šå½“ã¦: ã“ã®è¬›å¸«ãŒä»Šå¾Œã‚‚åŒã˜ãƒ–ãƒ¼ã‚¹ã‚’ä½¿ã„ç¶šã‘ã‚‰ã‚Œã‚‹ã‹ç¢ºèª
                    // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒã‚ã‚‹è¬›å¸«ãŒå®Ÿéš›ã«å‡ºå‹¤ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€ãã®ãƒ–ãƒ¼ã‚¹ã‚’å æœ‰
                    const futureTimeKeys = times.filter(t => t > tkey);
                    const teacherFutureSlots = futureTimeKeys
                      .map(ftkey => (teachersByTime.get(ftkey) || []).find(t => t.teacherId === candidateTeacher.teacherId))
                      .filter(t => t !== undefined);

                    let boothAvailableForAll = true;
                    for(const futureSlot of teacherFutureSlots){
                      const ftkey = key(futureSlot);
                      const futureThList = teachersByTime.get(ftkey) || [];

                      // ã“ã®æ™‚é–“å¸¯ã§ã€ä»–ã®è¬›å¸«ãŒå„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’æŒã¡ã€ã‹ã¤å®Ÿéš›ã«å‡ºå‹¤ã—ã¦ã„ã‚‹å ´åˆã®ã¿ãƒ–ãƒ¼ã‚¹ã‚’å æœ‰
                      const conflictingTeacher = futureThList.find(t =>
                        t.teacherId !== candidateTeacher.teacherId &&
                        teacherPreferences[t.teacherId] === slot.boothId &&
                        !usedTeacherAt.has(ftkey+' '+t.teacherId) // ã¾ã å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„ï¼å‡ºå‹¤å¯èƒ½
                      );

                      if(conflictingTeacher){
                        boothAvailableForAll = false;
                        console.log(`  âš ï¸ ${candidateTeacher.teacherName}ã®åˆå›ãƒ–ãƒ¼ã‚¹å€™è£œ${slot.boothId}ã¯ã€${ftkey}ã§${conflictingTeacher.teacherName}ï¼ˆå„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãƒ»å‡ºå‹¤äºˆå®šï¼‰ã«ã‚ˆã‚Šä½¿ç”¨ä¸å¯`);
                        break;
                      }
                    }

                    if(boothAvailableForAll){
                      assignedTeacher = candidateTeacher;
                      const earliestTime = teacherEarliestTime.get(dailyKey) || 'ä¸æ˜';
                      console.log(`  â†’ é€šå¸¸å‰²ã‚Šå½“ã¦ï¼ˆåˆå›ãƒ»äº‹å‰æ¤œè¨¼æ¸ˆï¼‰: ${candidateTeacher.teacherName} (æœ€æ—©å‡ºå‹¤: ${earliestTime}) -> ${slot.boothId}`);
                      break;
                    }
                  }
                }
              }
            }

            if (assignedTeacher){
              usedTeacherAt.add(tkey+' '+assignedTeacher.teacherId);
              const dailyKey = assignedTeacher.date + ' ' + assignedTeacher.teacherId;
              teacherDailyCount.set(dailyKey, (teacherDailyCount.get(dailyKey)||0) + 1);
              assignedSlotsInTime.add(slot.boothId); // ãƒ–ãƒ¼ã‚¹è¿½è·¡

              // 1æ—¥å†…ã®ãƒ–ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦ã‚’è¨˜éŒ²
              if (!teacherDailyBooth.has(dailyKey)) {
                teacherDailyBooth.set(dailyKey, slot.boothId);
                console.log(`  ğŸ“Œ åˆå›ãƒ–ãƒ¼ã‚¹æ±ºå®š: ${assignedTeacher.teacherName} -> ${slot.boothId} (${assignedTeacher.date})`);
              }

              if (assignedDemand){
                // remove selected demand from pool
                const i = ddList.indexOf(assignedDemand);
                if (i >= 0) ddList.splice(i,1);

                // å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç”Ÿå¾’ã‚’è¿½è·¡ï¼ˆNGç”Ÿå¾’ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
                if (assignedDemand.studentId) {
                  assignedStudentsInTime.add(assignedDemand.studentId);
                  console.log(`  ğŸ‘¤ ç”Ÿå¾’å‰²ã‚Šå½“ã¦è¿½è·¡: ${assignedDemand.studentName || assignedDemand.studentId}`);
                }
              }

              const assignmentRecord = {
                date: slot.date,
                time: slot.time,
                boothId: slot.boothId,
                teacherId: assignedTeacher.teacherId,
                teacherName: assignedTeacher.teacherName||'',
                students: [] // æœ€å¤§2äººã¾ã§å¾Œã§è¿½åŠ ï¼ˆassignedDemandã¯å¾Œã®ãƒ•ã‚§ãƒ¼ã‚ºã§å‡¦ç†ï¼‰
              };
              lastAssignments.push(assignmentRecord);
              lines.push([slot.date, slot.time, slot.boothId, assignedTeacher.teacherId, (assignedTeacher.teacherName||''), (assignedDemand?.studentId||''), (assignedDemand?.subject||'')].join(','));
              lastLog.decisions.push({ tkey, boothId: slot.boothId, teacherId: assignedTeacher.teacherId, studentId: assignedDemand?.studentId || null });
            } else {
              // No teacher available - è¬›å¸«ãŒã„ãªã„ãƒ–ãƒ¼ã‚¹ã«ã¯ç”Ÿå¾’ã‚’é…ç½®ã—ãªã„
              const assignmentRecord = {
                date: slot.date,
                time: slot.time,
                boothId: slot.boothId,
                teacherId: '',
                teacherName: '',
                students: [] // è¬›å¸«ãŒã„ãªã„ã®ã§ç”Ÿå¾’ã‚‚é…ç½®ã—ãªã„
              };
              lastAssignments.push(assignmentRecord);
              lines.push([slot.date, slot.time, slot.boothId, '', '', '', ''].join(','));
              lastLog.warnings.push({ tkey, boothId: slot.boothId, reason: 'è¬›å¸«ä¸è¶³' });
            }
          }
        }

        // === è¬›å¸«å‰²ã‚Šå½“ã¦å®Œäº† ===
        logMessage('\n=== è¬›å¸«å‰²ã‚Šå½“ã¦å®Œäº† ===');
        logMessage('è¬›å¸«å‰²ã‚Šå½“ã¦çŠ¶æ³:');
        logMessage('  ç·ãƒ–ãƒ¼ã‚¹æ•°: ' + lastAssignments.length);
        logMessage('  è¬›å¸«ãŒã„ã‚‹ãƒ–ãƒ¼ã‚¹: ' + lastAssignments.filter(a => a.teacherId).length);
        logMessage('  è¬›å¸«ãŒã„ãªã„ãƒ–ãƒ¼ã‚¹: ' + lastAssignments.filter(a => !a.teacherId).length);

        // ç”Ÿå¾’é¸æŠUIã‚’æº–å‚™ã™ã‚‹ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        window.currentAssignments = lastAssignments;
        window.currentDemands = studentDemandData; // å±•é–‹å‰ã®å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆå¿…è¦ã‚³ãƒæ•°åˆ†ã®ã¿ï¼‰
        window.currentSlots = slots;

        logMessage('\n=== å‰²ã‚Šå½“ã¦å®Œäº† ===');
        logMessage('1æ—¥å†…ãƒ–ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦: ' + JSON.stringify(Array.from(teacherDailyBooth.entries())));

        updateProgress(95, 'çµæœã‚’é›†è¨ˆä¸­...');
        await new Promise(resolve => setTimeout(resolve, 10));

        assignmentsOut.value = lines.join('\n');

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆè¬›å¸«ã®ã¿ï¼‰
        generateReport(slots, lastAssignments, demands, null);

        // è©³ç´°è¨­å®šã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        $('advancedCard').style.display = 'block';

        // ç”Ÿå¾’é¸æŠUIã‚’è¡¨ç¤º
        if(studentDemandData.length > 0){
          showStudentSelectionUI();
        }

        updateProgress(100, 'è¬›å¸«å‰²ã‚Šå½“ã¦å®Œäº†!');
        await new Promise(resolve => setTimeout(resolve, 1000));
        hideProgress();

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        renderPreview();

        toast('è¬›å¸«å‰²ã‚Šå½“ã¦ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç”Ÿå¾’ã‚’é¸æŠã—ã¦å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ã€‚', 'ok');
      }catch(e){
        console.error(e);
        hideProgress();
        toast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'err');
      }
    }

    function generateReport(slots, assignments, demands, demandAssigned){
      const reportLines = ['type,date,time,boothId,teacherId,teacherName,studentId,subject,reason'];

      // æœªå‰²å½“ã®è¬›å¸«ã‚’ãƒã‚§ãƒƒã‚¯
      const assignedSlots = new Set(assignments.filter(a=>a.teacherId).map(a=>`${a.date}_${a.time}_${a.boothId}`));
      for(const slot of slots){
        const sk = `${slot.date}_${slot.time}_${slot.boothId}`;
        if(!assignedSlots.has(sk)){
          reportLines.push(['æœªå‰²å½“è¬›å¸«',slot.date,slot.time,slot.boothId,'','','','','è¬›å¸«ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“'].join(','));
        }
      }

      // æœªå‰²å½“ã®ç”Ÿå¾’éœ€è¦ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°ã—ã„æ§‹é€ ã«å¯¾å¿œï¼‰
      if(demandAssigned){
        for(let i = 0; i < demands.length; i++){
          if(!demandAssigned[i]){
            const demand = demands[i];
            const classIndex = demand.classIndex !== undefined ? demand.classIndex : 0;
            const totalClasses = demand.totalClasses !== undefined ? demand.totalClasses : 1;
            reportLines.push(['æœªå‰²å½“ç”Ÿå¾’','','','','','',demand.studentId,demand.subject||'',`ç”Ÿå¾’ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“ (${classIndex + 1}/${totalClasses}å›ç›®)`].join(','));
          }
        }
      }

      // è­¦å‘Šãƒ­ã‚°ã‚’ãƒ¬ãƒãƒ¼ãƒˆã«è¿½åŠ 
      for(const warn of lastLog.warnings){
        const parts = warn.tkey.split(' ');
        reportLines.push(['è­¦å‘Š',parts[0],parts[1],warn.boothId,'','','','',warn.reason].join(','));
      }

      reportOut.value = reportLines.join('\n');
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: è¬›å¸«ãŒæŒ‡å®šç§‘ç›®ã‚’æŒ‡å°å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    window.canTeachSubject = function(teacherIdOrName, subject) {
      // ç§‘ç›®ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å¸¸ã«OK
      if (!subject) return true;
      // teacherSubjectMapãŒç©ºã®å ´åˆã¯å¸¸ã«OKï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
      if (!teacherSubjectMap || Object.keys(teacherSubjectMap).length === 0) return true;

      // è¬›å¸«ã®æŒ‡å°å¯èƒ½ç§‘ç›®ãƒªã‚¹ãƒˆã‚’å–å¾— - ã¾ãšãã®ã¾ã¾æ¤œç´¢
      let teachableSubjects = teacherSubjectMap[teacherIdOrName];

      // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ•ãƒ«ãƒãƒ¼ãƒ ã‹ã‚‰å§“ã‚’æŠ½å‡ºã—ã¦æ¤œç´¢
      if (!teachableSubjects && teacherIdOrName && teacherIdOrName.includes(' ')) {
        // ãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼ˆä¾‹: "æ¸¡é‚‰ æ¨¹å¸Œ"ï¼‰ã‹ã‚‰å§“ã®ã¿ã‚’æŠ½å‡ºï¼ˆä¾‹: "æ¸¡é‚‰"ï¼‰
        const surname = teacherIdOrName.split(' ')[0];
        teachableSubjects = teacherSubjectMap[surname];

        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã€Œå§“Tã€å½¢å¼ã§æ¤œç´¢ï¼ˆä¾‹: "æ¸¡é‚‰T"ï¼‰
        if (!teachableSubjects) {
          teachableSubjects = teacherSubjectMap[surname + 'T'];
        }
      }

      if (!teachableSubjects) return false; // è¬›å¸«æƒ…å ±ãŒãªã„å ´åˆã¯NG

      // ç§‘ç›®åã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
      const normalizedSubject = normalizeSubjectName(subject);
      return teachableSubjects.includes(normalizedSubject);
    };

    // ç”Ÿå¾’é¸æŠUIã‚’è¡¨ç¤º
    function showStudentSelectionUI(){
      const card = $('studentSelectionCard');
      const select = $('studentSelect');
      const statusDiv = $('studentAssignmentStatus');
      const statusList = $('studentStatusList');

      // ç”Ÿå¾’ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡ã‚’é™¤ãï¼‰
      const studentSet = new Set();
      window.currentDemands.forEach(d => studentSet.add(d.studentId));
      const students = Array.from(studentSet).sort();

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ç”Ÿå¾’ã‚’è¿½åŠ 
      select.innerHTML = '<option value="">-- ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      students.forEach(studentId => {
        const option = document.createElement('option');
        option.value = studentId;
        option.textContent = studentId;
        select.appendChild(option);
      });

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸåŒ–
      if(!window.studentAssignmentData){
        window.studentAssignmentData = {
          demandAssigned: new Array(window.currentDemands.length).fill(false),
          studentAssignmentHistory: {},
          studentDailyBooth: {},
          assignedStudents: []
        };
      }

      // ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
      card.style.display = 'block';

      console.log(`\nğŸ“‹ ç”Ÿå¾’é¸æŠUIã‚’è¡¨ç¤º: ${students.length}äºº`);
    }

    // é¸æŠã—ãŸç”Ÿå¾’ã‚’å‰²ã‚Šå½“ã¦ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
    window.assignSelectedStudent = async function(){
      console.log('ğŸš€ assignSelectedStudent() ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
      const select = $('studentSelect');
      const selectedStudent = select.value;
      console.log(`  é¸æŠã•ã‚ŒãŸç”Ÿå¾’: ${selectedStudent || '(æœªé¸æŠ)'}`);

      if(!selectedStudent){
        console.log('  âŒ ç”Ÿå¾’ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        toast('ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„', 'err');
        return;
      }

      // æ—¢ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      if(window.studentAssignmentData.assignedStudents.includes(selectedStudent)){
        toast(`${selectedStudent}ã¯æ—¢ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ã™`, 'err');
        return;
      }

      try{
        console.log(`\n${'='.repeat(60)}`);
        console.log(`ğŸ“ ã€${selectedStudent}ã€‘ã®å‰²ã‚Šå½“ã¦ã‚’é–‹å§‹`);
        console.log(`${'='.repeat(60)}`);

        // ã“ã®ç”Ÿå¾’ã®éœ€è¦ã‚’å–å¾—
        const studentDemands = [];
        window.currentDemands.forEach((demand, idx) => {
          if(demand.studentId === selectedStudent){
            studentDemands.push({ demand, index: idx });
          }
        });

        // ç§‘ç›®ãƒ»classIndexã§ã‚½ãƒ¼ãƒˆ
        studentDemands.sort((a, b) => {
          if(a.demand.subject !== b.demand.subject){
            return a.demand.subject.localeCompare(b.demand.subject);
          }
          return (a.demand.classIndex || 0) - (b.demand.classIndex || 0);
        });

        console.log(`  åˆè¨ˆ: ${studentDemands.length}ã‚³ãƒ`);

        // å„éœ€è¦ã‚’å‰²ã‚Šå½“ã¦
        let assignedCount = 0;
        for(const { demand, index } of studentDemands){
          // æ—¢ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if(window.studentAssignmentData.demandAssigned[index]){
            console.log(`  â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: ${demand.subject} - æ—¢ã«å‰²ã‚Šå½“ã¦æ¸ˆã¿`);
            continue;
          }

          const result = assignSingleDemand(demand, index);
          if(result){
            assignedCount++;
          }
        }

        // å‰²ã‚Šå½“ã¦æ¸ˆã¿ãƒªã‚¹ãƒˆã«è¿½åŠ 
        window.studentAssignmentData.assignedStudents.push(selectedStudent);

        // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        select.value = '';

        // çŠ¶æ³ã‚’æ›´æ–°
        updateStudentAssignmentStatus();

        // çµæœã‚’è¡¨ç¤º
        renderPreview();
        renderRequiredClassTable();

        toast(`${selectedStudent}ã®å‰²ã‚Šå½“ã¦ãŒå®Œäº†ã—ã¾ã—ãŸ (${assignedCount}/${studentDemands.length}ã‚³ãƒ)`, 'ok');

        console.log(`âœ“ ${selectedStudent}ã®å‰²ã‚Šå½“ã¦å®Œäº†: ${assignedCount}/${studentDemands.length}ã‚³ãƒ`);

      }catch(e){
        console.error(e);
        toast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'err');
      }
    }

    // 1ã¤ã®éœ€è¦ã‚’å‰²ã‚Šå½“ã¦
    function assignSingleDemand(demand, demandIndex){
      const studentKey = `${demand.studentId}_${demand.subject}`;
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

      console.log(`\nğŸ” å‰²ã‚Šå½“ã¦è©¦è¡Œ: ${demand.studentId} - ${demand.subject}`);
      console.log(`  window.currentAssignments: ${window.currentAssignments ? window.currentAssignments.length : 'undefined'}ä»¶`);

      // NGã®æ›œæ—¥ãƒ»æ—¥ç¨‹ãƒ»æ™‚é–“ã‚’Setã«å¤‰æ›ï¼ˆé«˜é€ŸåŒ–ï¼‰
      const ngDaysSet = demand.ngDays && demand.ngDays.length > 0 ? new Set(demand.ngDays) : null;
      const ngTeachersSet = demand.ngTeachers && demand.ngTeachers.length > 0 ? new Set(demand.ngTeachers) : null;
      const ngDatesSet = demand.ngDates && demand.ngDates.length > 0 ? new Set(demand.ngDates) : null;
      const ngTimesSet = demand.ngTimes && demand.ngTimes.length > 0 ? new Set(demand.ngTimes) : null;

      // å…¨ã¦ã®åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰å€™è£œã‚’æ¢ã™
      const candidateAssignments = [];
      let skippedReasons = { noTeacher: 0, full: 0, cannotTeach: 0, ngTeacher: 0, ngDay: 0, ngDate: 0, ngTime: 0, sameTimeConflict: 0 };

      for(let i = 0; i < window.currentAssignments.length; i++){
        const a = window.currentAssignments[i];
        if(!a.teacherId){
          skippedReasons.noTeacher++;
          continue;
        }
        if(!a.students){
          console.warn(`âš ï¸  ã‚¹ãƒ­ãƒƒãƒˆ ${i} ã« students é…åˆ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚åˆæœŸåŒ–ã—ã¾ã™ã€‚`);
          a.students = [];
        }
        // åŒã˜ç”Ÿå¾’ãŒæ—¢ã«ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã«é…ç½®ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if(a.students && a.students.some(s => s.studentId === demand.studentId)){
          continue; // åŒã˜ç”Ÿå¾’ã‚’2åé…ç½®ã—ãªã„
        }
        if(a.students.length >= 2){
          skippedReasons.full++;
          continue;
        }
        // è¬›å¸«åã‚’ä½¿ç”¨ã—ã¦ç§‘ç›®æŒ‡å°å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè¬›å¸«IDã§ã¯ãªãï¼‰
        const canTeach = canTeachSubject(a.teacherName, demand.subject);
        if(!canTeach){
          if(i < 3){ // æœ€åˆã®3ä»¶ã®ã¿ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
            console.log(`  âŒ æŒ‡å°ä¸å¯: è¬›å¸«=${a.teacherName}, ç§‘ç›®=${demand.subject}, teacherId=${a.teacherId}`);
          }
          skippedReasons.cannotTeach++;
          continue;
        }
        if(ngTeachersSet && ngTeachersSet.has(a.teacherId)){
          skippedReasons.ngTeacher++;
          continue;
        }
        if(ngDaysSet){
          const dateObj = new Date(a.date);
          const dayName = dayNames[dateObj.getDay()];
          if(ngDaysSet.has(dayName)){
            skippedReasons.ngDay++;
            continue;
          }
        }
        // NGæ—¥ä»˜ãƒã‚§ãƒƒã‚¯
        if(ngDatesSet && ngDatesSet.has(a.date)){
          skippedReasons.ngDate++;
          continue;
        }
        // NGæ™‚é–“ãƒã‚§ãƒƒã‚¯
        if(ngTimesSet && ngTimesSet.has(a.time)){
          skippedReasons.ngTime++;
          continue;
        }
        // åŒã˜ç”Ÿå¾’ãŒåŒã˜æ™‚é–“ï¼ˆdate+timeï¼‰ã«æ—¢ã«ä»–ã®ãƒ–ãƒ¼ã‚¹ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        const hasTimeConflict = window.currentAssignments.some(otherSlot =>
          otherSlot !== a &&
          otherSlot.date === a.date &&
          otherSlot.time === a.time &&
          otherSlot.students &&
          otherSlot.students.some(s => s.studentId === demand.studentId)
        );
        if(hasTimeConflict){
          skippedReasons.sameTimeConflict++;
          continue;
        }
        candidateAssignments.push(a);
      }

      console.log(`  å€™è£œã‚¹ãƒ­ãƒƒãƒˆ: ${candidateAssignments.length}ä»¶`);
      console.log(`  ã‚¹ã‚­ãƒƒãƒ—ç†ç”±: è¬›å¸«ãªã—=${skippedReasons.noTeacher}, æº€å¸­=${skippedReasons.full}, æŒ‡å°ä¸å¯=${skippedReasons.cannotTeach}, NGè¬›å¸«=${skippedReasons.ngTeacher}, NGæ›œæ—¥=${skippedReasons.ngDay}, åŒæ™‚åˆ»é‡è¤‡=${skippedReasons.sameTimeConflict}`);

      if(candidateAssignments.length === 0){
        return false;
      }

      // å±¥æ­´ã‚’å–å¾—
      const history = window.studentAssignmentData.studentAssignmentHistory[studentKey] || [];
      const assignedDatesSet = new Set(history.map(h => h.date));
      const assignedTimesMap = {}; // time -> count
      for(const h of history){
        assignedTimesMap[h.time] = (assignedTimesMap[h.time] || 0) + 1;
      }

      // æœ€é©ãªã‚¹ãƒ­ãƒƒãƒˆã‚’é¸æŠ
      let bestAssignment = null;
      let bestScore = -Infinity;

      for(const assignment of candidateAssignments){
        let score = 0;
        const dailyBoothKey = `${studentKey}_${assignment.date}`;
        const sameDayBooth = window.studentAssignmentData.studentDailyBooth[dailyBoothKey];

        // åŒã˜æ—¥ã®æ—¢å­˜ãƒ–ãƒ¼ã‚¹ã‚’æœ€å„ªå…ˆ
        if(sameDayBooth && assignment.boothId === sameDayBooth){
          score += 10000;
        }

        // æ¯é€±åŒã˜æ›œæ—¥ã«åŒã˜ç§‘ç›®ã®æˆæ¥­ãŒã§ãã‚‹ã‚ˆã†ã«æœ€å„ªå…ˆï¼ˆé€£ç¶šæ—¥ã‚ˆã‚Šå„ªå…ˆï¼‰
        if(history.length > 0){
          const assignmentDate = new Date(assignment.date);
          const assignmentDayOfWeek = assignmentDate.getDay();
          for(const h of history){
            if(h.dayOfWeek === assignmentDayOfWeek){
              score += 5000; // åŒã˜æ›œæ—¥ã«é…ç½®ã™ã‚‹å ´åˆã¯å¤§å¹…ã«ãƒœãƒ¼ãƒŠã‚¹
              break;
            }
          }
        }

        // åŒã˜æ™‚é–“å¸¯ã‚’å„ªå…ˆ
        const sameTimeCount = assignedTimesMap[assignment.time] || 0;
        if(sameTimeCount > 0){
          score += 500 * sameTimeCount;
        }

        // æ—¢ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸæ—¥ä»˜ã‚’é¿ã‘ã‚‹
        if(assignedDatesSet.has(assignment.date)){
          score -= 1000;
        } else if(history.length > 0){
          // åŒã˜ç§‘ç›®ã‚’é€±ã«2åº¦è¡Œã†å ´åˆã¯ã€é€£ç¶šæ—¥ã‚’å„ªå…ˆ
          // ï¼ˆé€£ç¶šæ—¥ã®ã»ã†ãŒã‚¹ã‚³ã‚¢ãŒé«˜ããªã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
          const assignmentDate = new Date(assignment.date);
          let minDiff = Infinity;
          for(const h of history){
            const diff = Math.abs(assignmentDate - new Date(h.date)) / (1000 * 60 * 60 * 24);
            if(diff < minDiff) minDiff = diff;
          }
          // é€£ç¶šæ—¥ï¼ˆ1æ—¥å·®ï¼‰ã‚’æœ€å„ªå…ˆ: å·®ãŒå°ã•ã„ã»ã©ã‚¹ã‚³ã‚¢ãŒé«˜ããªã‚‹
          // 1æ—¥å·®=+300ç‚¹ã€2æ—¥å·®=+150ç‚¹ã€3æ—¥å·®=+100ç‚¹...
          if(minDiff === 1){
            score += 300; // é€£ç¶šæ—¥ã‚’å¼·ãå„ªå…ˆ
          } else if(minDiff === 2){
            score += 150;
          } else if(minDiff <= 7){
            // åŒã˜é€±å†…ãªã‚‰å°‘ã—ãƒœãƒ¼ãƒŠã‚¹ï¼ˆãŸã ã—é€£ç¶šæ—¥ã‚ˆã‚Šä½ã„ï¼‰
            score += 100 / minDiff;
          } else {
            // é€±ã‚’ã¾ãŸãå ´åˆã¯ãƒšãƒŠãƒ«ãƒ†ã‚£
            score -= minDiff * 5;
          }
        }

        // å°‚é–€æ€§ã®é«˜ã„è¬›å¸«ã‚’å„ªå…ˆï¼ˆæŒ‡å°å¯èƒ½ç§‘ç›®æ•°ãŒå°‘ãªã„è¬›å¸«ã‚’å„ªå…ˆï¼‰
        // ä¾‹: ç¤¾ä¼šã‚’é…ç½®ã™ã‚‹å ´åˆã€å›½æ•°è‹±ç†ç¤¾ãŒã§ãã‚‹è¬›å¸«ã‚ˆã‚Šå›½ç¤¾ã®ã¿ã®è¬›å¸«ã‚’å„ªå…ˆ
        const teacherSubjects = teacherSubjectMap[assignment.teacherName] ||
                                 teacherSubjectMap[assignment.teacherName?.split(' ')[0]] ||
                                 teacherSubjectMap[assignment.teacherName?.split(' ')[0] + 'T'] || [];
        if(teacherSubjects.length > 0){
          // ç§‘ç›®æ•°ãŒå°‘ãªã„ã»ã©ãƒœãƒ¼ãƒŠã‚¹ãŒé«˜ã„ï¼ˆæœ€å¤§200ç‚¹ã€æœ€å°20ç‚¹ï¼‰
          const specialtyBonus = Math.max(20, 200 - (teacherSubjects.length * 10));
          score += specialtyBonus;
        }

        // åŒã˜è¬›å¸«ã‚’å„ªå…ˆ
        for(const h of history){
          if(h.teacherId === assignment.teacherId){
            score += 100;
            break;
          }
        }

        if(score > bestScore){
          bestScore = score;
          bestAssignment = assignment;
        }
      }

      if(!bestAssignment){
        bestAssignment = candidateAssignments[0];
      }

      // ç”Ÿå¾’ã‚’å‰²ã‚Šå½“ã¦
      bestAssignment.students.push({
        studentId: demand.studentId,
        studentName: demand.studentName,
        subject: demand.subject
      });

      console.log(`  âœ… å‰²ã‚Šå½“ã¦æˆåŠŸ: ${demand.studentId} -> ${bestAssignment.date} ${bestAssignment.time} ${bestAssignment.boothId} (è¬›å¸«: ${bestAssignment.teacherId})`);
      console.log(`     ç¾åœ¨ã®ç”Ÿå¾’æ•°: ${bestAssignment.students.length}/2`);

      // å‰²ã‚Šå½“ã¦æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
      window.studentAssignmentData.demandAssigned[demandIndex] = true;

      // å±¥æ­´ã‚’æ›´æ–°
      const dateObj = new Date(bestAssignment.date);
      const dayOfWeek = dateObj.getDay();
      if(!window.studentAssignmentData.studentAssignmentHistory[studentKey]){
        window.studentAssignmentData.studentAssignmentHistory[studentKey] = [];
      }
      window.studentAssignmentData.studentAssignmentHistory[studentKey].push({
        date: bestAssignment.date,
        dayOfWeek: dayOfWeek,
        time: bestAssignment.time,
        teacherId: bestAssignment.teacherId
      });

      // åŒã˜æ—¥ã®ãƒ–ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦ã‚’è¨˜éŒ²
      const dailyBoothKey = `${studentKey}_${bestAssignment.date}`;
      if(!window.studentAssignmentData.studentDailyBooth[dailyBoothKey]){
        window.studentAssignmentData.studentDailyBooth[dailyBoothKey] = bestAssignment.boothId;
      }

      return true;
    }

    // ç”Ÿå¾’å‰²ã‚Šå½“ã¦çŠ¶æ³ã‚’æ›´æ–°
    function updateStudentAssignmentStatus(){
      const statusDiv = $('studentAssignmentStatus');
      const statusList = $('studentStatusList');

      if(window.studentAssignmentData.assignedStudents.length === 0){
        statusDiv.style.display = 'none';
        return;
      }

      statusDiv.style.display = 'block';

      let html = '<ul style="margin:0; padding-left:20px;">';
      window.studentAssignmentData.assignedStudents.forEach(studentId => {
        html += `<li style="margin:4px 0;">âœ“ ${studentId}</li>`;
      });
      html += '</ul>';

      statusList.innerHTML = html;
    }

    function toggleRequiredClass(){
      const container = $('requiredClassContainer');
      if(container.style.display === 'none'){
        container.style.display = 'block';
        renderRequiredClassTable();
      } else {
        container.style.display = 'none';
      }
    }

    function renderRequiredClassTable(){
      const tbody = $('requiredClassTableBody');

      if(studentDemandData.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#6b7280;">ç”Ÿå¾’ã‚³ãƒæ•°è¡¨ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
        return;
      }

      // ç”Ÿå¾’ã”ã¨ãƒ»ç§‘ç›®ã”ã¨ã®å¿…è¦ã‚³ãƒæ•°ã‚’é›†è¨ˆ
      const requiredByStu = {}; // { ç”Ÿå¾’å: { ç§‘ç›®: å¿…è¦ã‚³ãƒæ•° } }
      for(const demand of studentDemandData){
        if(!requiredByStu[demand.studentName]){
          requiredByStu[demand.studentName] = {};
        }
        if(!requiredByStu[demand.studentName][demand.subject]){
          requiredByStu[demand.studentName][demand.subject] = 0;
        }
        requiredByStu[demand.studentName][demand.subject]++;
      }

      // å‰²ã‚Šå½“ã¦æ¸ˆã¿ã‚³ãƒæ•°ã‚’é›†è¨ˆï¼ˆæ–°ã—ã„æ§‹é€ ã«å¯¾å¿œï¼‰
      const assignedByStu = {}; // { ç”Ÿå¾’å: { ç§‘ç›®: å‰²ã‚Šå½“ã¦æ¸ˆã¿ã‚³ãƒæ•° } }
      for(const assignment of lastAssignments){
        if(assignment.students && assignment.students.length > 0){
          for(const student of assignment.students){
            if(!assignedByStu[student.studentName]){
              assignedByStu[student.studentName] = {};
            }
            if(!assignedByStu[student.studentName][student.subject]){
              assignedByStu[student.studentName][student.subject] = 0;
            }
            assignedByStu[student.studentName][student.subject]++;
          }
        }
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ï¼ˆç”Ÿå¾’ä¸€äººã«ã¤ã1è¡Œï¼‰
      let html = '';
      let allComplete = true;

      for(const [studentName, subjects] of Object.entries(requiredByStu)){
        let totalRequired = 0;
        let totalAssigned = 0;
        let subjectDetails = [];

        for(const [subject, required] of Object.entries(subjects)){
          const assigned = assignedByStu[studentName]?.[subject] || 0;
          totalRequired += required;
          totalAssigned += assigned;
          subjectDetails.push(`${subject}:${assigned}/${required}`);
        }

        const rate = totalRequired > 0 ? Math.round((totalAssigned / totalRequired) * 100) : 0;
        const isComplete = totalAssigned >= totalRequired;

        if(!isComplete) allComplete = false;

        const bgColor = isComplete ? '#d1fae5' : (totalAssigned > 0 ? '#fef3c7' : '#fee2e2');
        const rateColor = isComplete ? '#10b981' : (totalAssigned > 0 ? '#f59e0b' : '#ef4444');

        html += `<tr style="background:${bgColor};">`;
        html += `<td style="border:1px solid #d1d5db; padding:6px;">${studentName}</td>`;
        html += `<td style="border:1px solid #d1d5db; padding:6px;"><small>${subjectDetails.join(', ')}</small></td>`;
        html += `<td style="border:1px solid #d1d5db; padding:6px; text-align:center;">${totalRequired}</td>`;
        html += `<td style="border:1px solid #d1d5db; padding:6px; text-align:center;">${totalAssigned}</td>`;
        html += `<td style="border:1px solid #d1d5db; padding:6px; text-align:center; color:${rateColor}; font-weight:600;">${rate}%</td>`;
        html += '</tr>';
      }

      tbody.innerHTML = html;

      // ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      const totalStudents = Object.keys(requiredByStu).length;
      const completedStudents = Object.entries(requiredByStu).filter(([studentName, subjects]) => {
        let totalRequired = 0;
        let totalAssigned = 0;
        for(const [subject, required] of Object.entries(subjects)){
          totalRequired += required;
          totalAssigned += (assignedByStu[studentName]?.[subject] || 0);
        }
        return totalAssigned >= totalRequired;
      }).length;
      const summaryMsg = allComplete
        ? `<span class="ok">âœ“ ã™ã¹ã¦ã®ç”Ÿå¾’ã®å¿…è¦ã‚³ãƒæ•°ãŒé”æˆã•ã‚Œã¦ã„ã¾ã™ï¼ˆ${completedStudents}/${totalStudents}äººï¼‰</span>`
        : `<span class="warn">âš  æœªé”æˆã®ç”Ÿå¾’ãŒã„ã¾ã™ï¼ˆ${completedStudents}/${totalStudents}äººé”æˆï¼‰</span>`;

      // ã‚µãƒãƒªãƒ¼è¡Œã‚’è¿½åŠ 
      tbody.innerHTML += `<tr style="background:#f9fafb; font-weight:600;"><td colspan="5" style="border:1px solid #d1d5db; padding:8px; text-align:center;">${summaryMsg}</td></tr>`;
    }

    function renderPreview(){
      // window.currentAssignmentsãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆç”Ÿå¾’å‰²ã‚Šå½“ã¦å¾Œï¼‰
      const assignments = window.currentAssignments || lastAssignments;

      if(assignments.length === 0){
        $('previewTable').innerHTML = '<tr><td>å‰²å½“çµæœãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      const dates = [...new Set(assignments.map(a=>a.date))].sort();
      // ä¸¸ä»˜ãæ•°å­—ã¯Unicodeã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆé †ã«ã‚½ãƒ¼ãƒˆï¼ˆâ‘ â‘¡â‘¢...ã®é †ï¼‰
      const booths = [...new Set(assignments.map(a=>a.boothId))].sort();
      const times = [...new Set(assignments.map(a=>a.time))].sort();

      // æ™‚é–“ã‹ã‚‰ç§’ã‚’å‰Šé™¤
      const formatTime = (time) => {
        const parts = time.split(':');
        return parts.length >= 2 ? `${parts[0]}:${parts[1]}` : time;
      };

      // æ—¥ä»˜ã‚’é€±ã”ã¨ã«åˆ†å‰²ï¼ˆæœˆæ›œå§‹ã¾ã‚Šï¼‰
      const weekGroups = [];
      let currentWeek = [];
      for(const date of dates){
        const d = new Date(date);
        const dayOfWeek = d.getDay(); // 0=æ—¥, 1=æœˆ, ..., 6=åœŸ

        // æœˆæ›œæ—¥ï¼ˆdayOfWeek=1ï¼‰ã¾ãŸã¯é€±ã®é–‹å§‹ã§æ–°ã—ã„é€±ã‚’ä½œæˆ
        if(dayOfWeek === 1 && currentWeek.length > 0){
          weekGroups.push(currentWeek);
          currentWeek = [];
        }

        currentWeek.push(date);
      }
      if(currentWeek.length > 0){
        weekGroups.push(currentWeek);
      }

      // ãƒ–ãƒ¼ã‚¹è¡¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æƒãˆã‚‹: æ›œæ—¥ã‚’ç¸¦åˆ—ã«ã€é€±ã”ã¨ã«åˆ†å‰²ã—ã¦è¡¨ç¤º
      let html = '';
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

      // æ›œæ—¥ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ï¼ˆæœˆã€œåœŸã®6åˆ—æ§‹é€ ã€æ—¥æ›œæ—¥ã¯é™¤å¤–ï¼‰
      const dayOfWeekCols = [1, 2, 3, 4, 5, 6]; // æœˆç«æ°´æœ¨é‡‘åœŸã®é †ï¼ˆæ—¥æ›œæ—¥ã‚’é™¤å¤–ï¼‰

      // ã‚»ãƒ«å¹…ã‚’è¨ˆç®—ï¼ˆæ–‡å­—åˆ—ã®æœ€å¤§é•·ã«åˆã‚ã›ã‚‹ï¼‰
      let maxTeacherNameLength = 0;
      let maxStudentTextLength = 0;
      for(const a of assignments){
        if(a.teacherName){
          const cleanName = a.teacherName.replace(/T$/, '');
          const parts = cleanName.split(/\s+/);
          const nameLength = Math.max(parts[0]?.length || 0, parts[1]?.length || 0) + 1; // +1ã¯"T"
          maxTeacherNameLength = Math.max(maxTeacherNameLength, nameLength);
        }
        if(a.students && a.students.length > 0){
          for(const student of a.students){
            const studentText = (student.studentName || student.studentId) + (student.subject ? `(${student.subject})` : '');
            maxStudentTextLength = Math.max(maxStudentTextLength, studentText.length);
          }
        }
      }
      // 1æ–‡å­—ã‚ãŸã‚Šç´„12px + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã€æœ€å¤§å¹…ã‚’åˆ¶é™ï¼ˆç¸¦æ›¸ãé˜²æ­¢ï¼‰
      const teacherCellWidth = Math.min(150, Math.max(80, maxTeacherNameLength * 12 + 16));
      const studentCellWidth = Math.min(200, Math.max(120, maxStudentTextLength * 12 + 16));

      // é€±ã”ã¨ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
      for(let weekIndex = 0; weekIndex < weekGroups.length; weekIndex++){
        const weekDates = weekGroups[weekIndex];

        // æ›œæ—¥ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
        const dateByDayOfWeek = {};
        for(const date of weekDates){
          const d = new Date(date);
          const dow = d.getDay();
          dateByDayOfWeek[dow] = date;
        }

        // é€±ã®åŒºåˆ‡ã‚Š
        if(weekIndex > 0){
          html += '<tr><td colspan="100%" style="height:20px; background:#f3f4f6;"></td></tr>';
        }

        html += '<thead>';

        // è¡Œ0: æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœˆã€œæ—¥ã®é †ï¼‰
        html += '<tr><th style="border:1px solid #d1d5db; background:#f3f4f6; width:80px;">æ™‚é–“</th>';
        for(const dow of dayOfWeekCols){
          const date = dateByDayOfWeek[dow];
          const dayLabel = weekdays[dow];
          const dayNum = date ? new Date(date).getDate() : '-';
          html += `<th colspan="${booths.length * 3}" style="border:1px solid #d1d5db; background:#f3f4f6; text-align:center;">${dayLabel} (${dayNum})</th>`;
        }
        html += '</tr>';
        html += '</thead><tbody>';

        // æ™‚é–“è¡Œ
        for(const time of times){
          html += `<tr><td style="font-weight:600; border:1px solid #d1d5db; padding:6px 8px; background:#f9fafb; position:sticky; left:0; z-index:10;">${formatTime(time)}</td>`;

          for(const dow of dayOfWeekCols){
            const date = dateByDayOfWeek[dow];

            for(const booth of booths){
              const a = date ? assignments.find(x=>x.date===date && x.time===time && x.boothId===booth) : null;
            const cls = (a && a.teacherId) ? 'assigned' : 'empty';
            const isClosedDay = !date; // ä¼‘å¡¾æ—¥åˆ¤å®š

            // ãƒ–ãƒ¼ã‚¹ç•ªå·ã‚»ãƒ«ï¼ˆB1å½¢å¼ã‚’ä¸¸ä»˜ãæ•°å­—ã«å¤‰æ›ã—ã¦è¡¨ç¤ºï¼‰
            html += `<td style="border:1px solid #d1d5db; padding:4px; text-align:center; font-weight:600; width:40px; background:${isClosedDay ? '#e5e7eb' : '#f9fafb'};">${boothIdToCircled(booth)}</td>`;

            // è¬›å¸«åã‚»ãƒ«
            let teacherText = '';
            if(a && a.teacherId){
              // è¬›å¸«åã‚’è¡¨ç¤º: è‹—å­—ãŒé‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã¯ã€Œåå‰+Tã€ã€ãã‚Œä»¥å¤–ã¯ã€Œè‹—å­—+Tã€
              const teacherName = a.teacherName || a.teacherId;
              const cleanName = teacherName.replace(/T$/, ''); // æœ«å°¾ã®Tã‚’å‰Šé™¤
              const parts = cleanName.split(/\s+/); // ç©ºç™½ã§åˆ†å‰²
              const surname = parts[0] || cleanName; // è‹—å­—
              const givenName = parts[1] || ''; // åå‰

              // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¬›å¸«ã®ã¿ã‚’å–å¾—ã—ã¦è‹—å­—é‡è¤‡ãƒã‚§ãƒƒã‚¯
              const uniqueTeachers = [...new Set(assignments.filter(x => x.teacherId).map(x => x.teacherId))];
              const allSurnames = uniqueTeachers.map(tid => {
                const assignment = assignments.find(x => x.teacherId === tid);
                const tName = (assignment.teacherName || tid).replace(/T$/, '');
                return { teacherId: tid, surname: tName.split(/\s+/)[0] };
              });

              // ã“ã®è¬›å¸«ã¨åŒã˜è‹—å­—ã‚’æŒã¤è¬›å¸«ãŒä»–ã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              const sameSurnameTeachers = allSurnames.filter(t => t.surname === surname);
              const hasDuplicateSurname = sameSurnameTeachers.length > 1;

              // è‹—å­—ãŒé‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã¯åå‰+Tã€ãã‚Œä»¥å¤–ã¯è‹—å­—+T
              if(hasDuplicateSurname && givenName){
                teacherText = givenName + 'T';
              } else {
                teacherText = surname + 'T';
              }

              // è¬›å¸«åã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚¹ãƒ‘ãƒ³ã§å›²ã‚€
              const teacherDisplayId = `teacher_${date}_${time}_${booth}`;
              teacherText = `<span id="${teacherDisplayId}" class="teacher-name-clickable"
                        style="cursor:pointer; text-decoration:underline; color:#2563eb;"
                        onclick="showTeacherDropdown('${date}', '${time}', '${booth}', '${a.teacherId}')">${teacherText}</span>`;
            }

            const teacherCellId = `cell_teacher_${date}_${time}_${booth}`;
            const teacherBgColor = isClosedDay ? 'e5e7eb' : (a && a.teacherId ? 'e0f2fe' : 'fef3c7');
            html += `<td class="${cls}" id="${teacherCellId}"
                      style="border:1px solid #d1d5db; padding:4px; width:${teacherCellWidth}px; background:#${teacherBgColor};"
                      data-date="${date}" data-time="${time}" data-booth="${booth}">${teacherText}</td>`;

            // ç”Ÿå¾’ã‚»ãƒ«ï¼ˆæœ€å¤§2äººï¼‰
            let studentText = '';
            if(a && a.students && a.students.length > 0){
              for(const student of a.students){
                if(studentText) studentText += '<br/>';
                studentText += '<small style="font-weight:600;">' + (student.studentName || student.studentId);
                if(student.subject) studentText += '<span style="font-weight:normal;">(' + student.subject + ')</span>';
                studentText += '</small>';
              }
            }

            const studentCellId = `cell_student_${date}_${time}_${booth}`;
            const studentBgColor = isClosedDay ? 'e5e7eb' : (a && a.students && a.students.length > 0 ? 'd1fae5' : 'fff');
            html += `<td class="${a && a.students && a.students.length > 0 ? 'assigned' : 'empty'}" id="${studentCellId}"
                      style="border:1px solid #d1d5db; padding:4px; width:${studentCellWidth}px; background:#${studentBgColor};"
                      data-date="${date}" data-time="${time}" data-booth="${booth}">${studentText}</td>`;
            }
          }
          html += '</tr>';
        }
        html += '</tbody>';
      }

      $('previewTable').innerHTML = html;
    }

    // ================= è¬›å¸«å¤‰æ›´ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ =================
    let currentDropdown = null; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆHTMLã®onclickã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ï¼‰
    window.showTeacherDropdown = function(date, time, booth, currentTeacherId){
      // æ—¢å­˜ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å‰Šé™¤
      if(currentDropdown){
        currentDropdown.remove();
        currentDropdown = null;
      }

      // ãã®æ™‚é–“å¸¯ã«å‡ºå‹¤å¯èƒ½ãªè¬›å¸«ã‚’å–å¾—
      const tkey = `${date}|${time}`;
      const availableTeachers = teacherData.filter(t => t.date === date && t.time === time);

      if(availableTeachers.length === 0){
        toast('ã“ã®æ™‚é–“å¸¯ã«å‡ºå‹¤å¯èƒ½ãªè¬›å¸«ãŒã„ã¾ã›ã‚“', 'warn');
        return;
      }

      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆ
      const dropdown = document.createElement('div');
      dropdown.id = 'teacherDropdown';
      dropdown.style.cssText = `
        position: absolute;
        background: white;
        border: 2px solid #2563eb;
        border-radius: 4px;
        padding: 8px;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        min-width: 150px;
      `;

      // ãƒ˜ãƒƒãƒ€ãƒ¼
      const header = document.createElement('div');
      header.style.cssText = 'font-weight:600; margin-bottom:8px; font-size:12px; color:#374151;';
      header.textContent = 'è¬›å¸«ã‚’é¸æŠ:';
      dropdown.appendChild(header);

      // ç¾åœ¨ã®è¬›å¸«ã‚’å¼·èª¿
      const currentAssignment = lastAssignments.find(a => a.date === date && a.time === time && a.boothId === booth);

      // è¬›å¸«ãƒªã‚¹ãƒˆ
      for(const teacher of availableTeachers){
        const option = document.createElement('div');
        option.style.cssText = `
          padding: 6px 8px;
          cursor: pointer;
          border-radius: 3px;
          font-size: 13px;
          margin-bottom: 2px;
          ${teacher.teacherId === currentTeacherId ? 'background:#dbeafe; font-weight:600;' : 'background:#f9fafb;'}
        `;
        option.textContent = teacher.teacherName || teacher.teacherId;
        option.onmouseover = () => { if(teacher.teacherId !== currentTeacherId) option.style.background = '#e5e7eb'; };
        option.onmouseout = () => { if(teacher.teacherId !== currentTeacherId) option.style.background = '#f9fafb'; };
        option.onclick = () => {
          changeTeacher(date, time, booth, teacher.teacherId);
          dropdown.remove();
          currentDropdown = null;
        };
        dropdown.appendChild(option);
      }

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      cancelBtn.style.cssText = `
        width: 100%;
        margin-top: 8px;
        padding: 6px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      `;
      cancelBtn.onclick = () => {
        dropdown.remove();
        currentDropdown = null;
      };
      dropdown.appendChild(cancelBtn);

      // ã‚»ãƒ«ã®ä½ç½®ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’é…ç½®
      const cellId = `cell_${date}_${time}_${booth}`;
      const cell = document.getElementById(cellId);
      if(!cell){
        toast('ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
        return;
      }

      // ã‚»ãƒ«ã«ç›¸å¯¾ä½ç½®ã§ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’è¿½åŠ 
      cell.style.position = 'relative';
      cell.appendChild(dropdown);
      currentDropdown = dropdown;
    }

    function changeTeacher(date, time, booth, newTeacherId){
      // å‰²ã‚Šå½“ã¦ã‚’å¤‰æ›´
      const assignment = lastAssignments.find(a => a.date === date && a.time === time && a.boothId === booth);
      if(!assignment){
        toast('å‰²ã‚Šå½“ã¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
        return;
      }

      // æ–°ã—ã„è¬›å¸«æƒ…å ±ã‚’å–å¾—
      const newTeacher = teacherData.find(t => t.teacherId === newTeacherId && t.date === date && t.time === time);
      if(!newTeacher){
        toast('è¬›å¸«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
        return;
      }

      // å‰²ã‚Šå½“ã¦ã‚’æ›´æ–°
      assignment.teacherId = newTeacher.teacherId;
      assignment.teacherName = newTeacher.teacherName || '';

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»
      renderPreview();
      toast(`è¬›å¸«ã‚’ ${newTeacher.teacherName || newTeacherId} ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'ok');

      console.log(`âœ“ è¬›å¸«å¤‰æ›´: ${date} ${time} ${booth} -> ${newTeacher.teacherName}`);
    }

    // ================= Excel import: ãƒ–ãƒ¼ã‚¹è¡¨ =================
    const jpWeek = new Set(["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥","ç¥"]);
    const circledRegex = /[\u2460-\u2473]/; // â‘ ..â‘³
    const ymFromSheetName = /(\d{4})\.(\d{1,2})\./; // "... 2025.11.02-08"
    function detectYearMonthFromSheetName(name){
      const m = name.match(ymFromSheetName);
      return m ? { year: m[1], month: pad2(m[2]) } : null;
    }
    function detectYearMonthFromCells(rows){
      // æ¢ç´¢: "2025/11" or "2025.11" or "2025å¹´11æœˆ"
      const re = /(\d{4})[/.å¹´](\d{1,2})/;
      for (let r=0;r<Math.min(rows.length, 10); r++){
        const row = rows[r] || [];
        for (let c=0;c<row.length;c++){
          const v=row[c];
          if (typeof v === 'string'){
            const m = v.match(re); if (m) return { year: m[1], month: pad2(m[2]) };
          }
        }
      }
      return null;
    }
    function getOverrideYM(){
      return null; // å¹´æœˆã®æ‰‹å‹•æŒ‡å®šã¯å»ƒæ­¢
    }
    function normalizeTime(v){
      if (v == null) return null;
      if (typeof v === 'string'){
        const m = v.match(/^\s*(\d{1,2}):(\d{2})(?::(\d{2}))?\s*$/);
        if (!m) return null;
        return `${pad2(m[1])}:${pad2(m[2])}:${pad2(m[3] ?? '00')}`;
      }
      if (typeof v === 'number'){
        if (v < 0 || v > 1) return null;
        const total = Math.round(v * 24 * 3600);
        const hh = pad2(Math.floor(total / 3600) % 24);
        const mm = pad2(Math.floor((total % 3600) / 60));
        const ss = pad2(total % 60);
        return `${hh}:${mm}:${ss}`;
      }
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)){
        // ExcelJSã¯UTCæ™‚åˆ»ã§è¿”ã™ãŸã‚ã€getUTCHours()ã‚’ä½¿ç”¨
        return `${pad2(v.getUTCHours())}:${pad2(v.getUTCMinutes())}:${pad2(v.getUTCSeconds())}`;
      }
      return null;
    }
    function buildEffectiveTimes(rows, timeColIdx){
      const eff = new Array(rows.length).fill(null);
      let last = null;
      for (let r=0;r<rows.length;r++){
        const norm = normalizeTime(rows[r]?.[timeColIdx]);
        if (norm) last = norm;
        eff[r] = last;
      }
      return eff;
    }
    function collectDayColumns(rows, timeColIdx){
      const header0 = rows[0] || [];
      const header1 = rows[1] || [];
      const result = [];
      for (let c=0;c<header0.length;c++){
        if (c === timeColIdx) continue;
        const v0 = header0[c];
        const v1 = header1[c];
        const dayOk = (v0 != null) && /^\d{1,2}$/.test(String(v0).trim());
        const weekdayOk = (v1 != null) && jpWeek.has(String(v1).trim());
        if (dayOk && weekdayOk) result.push({ col: c, day: parseInt(String(v0).trim(), 10) });
      }
      return result;
    }
    function circledToBoothId(ch){
      // ä¸¸ä»˜ãæ•°å­—ï¼ˆâ‘ -â‘³ï¼‰ã‚’ B1, B2... ã«å¤‰æ›
      const code = ch.charCodeAt(0);
      if (code >= 0x2460 && code <= 0x2473) {
        const num = code - 0x2460 + 1;
        return `B${num}`;
      }
      return ch; // ä¸¸ä»˜ãæ•°å­—ã§ãªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™
    }
    function boothIdToCircled(boothId){
      // B1, B2... ã‚’ä¸¸ä»˜ãæ•°å­—ï¼ˆâ‘ â‘¡...ï¼‰ã«å¤‰æ›
      const match = boothId.match(/^B(\d+)$/);
      if (match) {
        const num = parseInt(match[1], 10);
        if (num >= 1 && num <= 20) {
          return String.fromCharCode(0x2460 + num - 1);
        }
      }
      return boothId; // B1å½¢å¼ã§ãªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™
    }

    // ExcelJSã®ã‚»ãƒ«å€¤ã‚’å®‰å…¨ã«å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getCellValue(cell){
      if (cell.value === undefined || cell.value === null) {
        return null;
      }
      // ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆ
      if (typeof cell.value === 'object' && cell.value.richText) {
        return cell.value.richText.map(part => part.text).join('');
      }
      // ãã®ä»–ï¼ˆæ–‡å­—åˆ—ã€æ•°å€¤ã€æ—¥ä»˜ãªã©ï¼‰
      return cell.value;
    }

    async function parseBoothExcel(input){
      const file = input.files?.[0];
      if (!file){ $('boothExcelStatus').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'; return; }
      try{
        console.log('ğŸ”µ parseBoothExcel: é–‹å§‹');
        const buf = await file.arrayBuffer();
        console.log('ğŸ”µ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', buf.byteLength, 'bytes');

        // ExcelJSã®å­˜åœ¨ç¢ºèª
        if (typeof ExcelJS === 'undefined') {
          throw new Error('ExcelJSãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        // ExcelJSã§ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã¿ï¼ˆæ›¸å¼å®Œå…¨ä¿æŒï¼‰
        const workbook = new ExcelJS.Workbook();
        console.log('ğŸ”µ ExcelJS.Workbookä½œæˆå®Œäº†');

        await workbook.xlsx.load(buf);
        console.log('ğŸ”µ workbook.xlsx.loadå®Œäº†');
        console.log(`ğŸ”µ å…¨ã‚·ãƒ¼ãƒˆæ•°: ${workbook.worksheets.length}`);

        // å…¨ã‚·ãƒ¼ãƒˆã‚’å‡¦ç†ã—ã¦çµ±åˆ
        let allSlots = [];
        const allCellPositions = {};
        let firstSheetInfo = null;

        for (let sheetIndex = 0; sheetIndex < workbook.worksheets.length; sheetIndex++) {
          const worksheet = workbook.worksheets[sheetIndex];
          const sheetName = worksheet.name;
          console.log(`\nğŸ”µ ã‚·ãƒ¼ãƒˆ${sheetIndex + 1}/${workbook.worksheets.length}: ${sheetName}`);

          // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›ï¼ˆSheetJSã® rows äº’æ›ï¼‰
          const rows = [];
          worksheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
            const rowData = [];
            row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
              // ã‚»ãƒ«ã®å€¤ã‚’å®‰å…¨ã«å–å¾—ï¼ˆãƒãƒ¼ã‚¸ã‚»ãƒ«ã€ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œï¼‰
              let cellValue;
              try {
                // æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚»ãƒ«ã®å ´åˆã¯ cell.value (Date object) ã‚’å„ªå…ˆ
                if (cell.value instanceof Date) {
                  cellValue = cell.value;
                } else if (cell.text !== undefined && cell.text !== null) {
                  cellValue = cell.text;
                } else {
                  cellValue = getCellValue(cell);
                }
              } catch (e) {
                // cell.textã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆï¼ˆãƒãƒ¼ã‚¸ã‚»ãƒ«ãªã©ï¼‰
                cellValue = getCellValue(cell);
              }
              rowData[colNumber - 1] = cellValue;
            });
            rows[rowNumber - 1] = rowData;
          });
          console.log(`  è¡Œãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†: ${rows.length}è¡Œ`);

          let ym = getOverrideYM() || detectYearMonthFromSheetName(sheetName) || detectYearMonthFromCells(rows);
          if (!ym) {
            console.warn(`  âš ï¸ å¹´/æœˆã®è‡ªå‹•æ¤œå‡ºã«å¤±æ•—: ${sheetName} - ã‚¹ã‚­ãƒƒãƒ—`);
            continue; // ã“ã®ã‚·ãƒ¼ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
          }
          console.log(`  å¹´æœˆ: ${ym.year}/${ym.month}`);

          const timeColIdx = 1; // Båˆ—
          const effTimes = buildEffectiveTimes(rows, timeColIdx);
          console.log(`  effTimeså–å¾—å®Œäº†: ${effTimes.filter(t => t).length}ä»¶`);

          const dayCols = collectDayColumns(rows, timeColIdx);
          console.log(`  dayColså–å¾—å®Œäº†: ${dayCols.length}ä»¶`);

          if (!dayCols.length) {
            console.warn(`  âš ï¸ æ—¥ä»˜/æ›œæ—¥ãƒ˜ãƒƒãƒ€è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—`);
            continue;
          }

          // ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã¨ã‚»ãƒ«ä½ç½®ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
          const slots = [];
          const cellPositions = {}; // key: "date_time_boothId" -> {row, col, teacherCol}

          let matchCount = 0;
          let totalChecked = 0;
          for (let r=0;r<rows.length;r++){
            const t = effTimes[r];
            if (!t) continue;
            for (const {col, day} of dayCols){
              const v = rows[r]?.[col];
              totalChecked++;
              if (v == null) continue;
              const m = String(v).match(circledRegex);
              if (!m) continue;

              matchCount++;
              const boothId = circledToBoothId(m[0]);
              const date = `${ym.year}/${ym.month}/${pad2(day)}`;
              slots.push({ date, time: t, boothId });
              // ãƒ–ãƒ¼ã‚¹ç•ªå·ã‚»ãƒ« (col) ã®å³éš£ (col+1) ãŒè¬›å¸«åè¨˜å…¥æ¬„
              // ExcelJSã¯1å§‹ã¾ã‚Šãªã®ã§ +1 ã™ã‚‹
              cellPositions[`${date}_${t}_${boothId}`] = {
                row: r + 1,
                col: col + 1,
                teacherCol: col + 2,
                sheetIndex: sheetIndex,
                sheetName: sheetName
              };
            }
          }
          console.log(`  ãƒ–ãƒ¼ã‚¹ç•ªå·æ¤œå‡º: ${matchCount}ä»¶ã®ãƒãƒƒãƒ / ${totalChecked}ã‚»ãƒ«ã‚’ç¢ºèª`);

          // æœ€åˆã®ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’ä¿å­˜ï¼ˆExcelä¿å­˜æ™‚ã«ä½¿ç”¨ï¼‰
          if (sheetIndex === 0) {
            firstSheetInfo = {
              sheetName,
              yearMonth: ym
            };
          }

          // ã“ã®ã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆã‚’çµ±åˆ
          allSlots = allSlots.concat(slots);
          Object.assign(allCellPositions, cellPositions);
        }

        if (allSlots.length === 0) {
          throw new Error('æœ‰åŠ¹ãªã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }

        // æ—¥ä»˜ãƒ»æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
        allSlots.sort((a,b)=> (a.date+a.time+a.boothId).localeCompare(b.date+b.time+b.boothId));

        // ExcelJSãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã¨ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’ä¿å­˜
        originalBoothWorkbook = workbook;
        boothSheetInfo = {
          ...firstSheetInfo,
          cellPositions: allCellPositions,
          totalSheets: workbook.worksheets.length
        };

        boothData = allSlots;
        console.log('\nğŸ”µ parseBoothExcel: å®Œäº† -', allSlots.length, 'ä»¶ã®ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ', workbook.worksheets.length, 'ã‚·ãƒ¼ãƒˆçµ±åˆï¼‰');
        $('boothExcelStatus').innerHTML = `<span class="ok">âœ“ èª­ã¿è¾¼ã¿å®Œäº†:</span> ${allSlots.length}ä»¶ï¼ˆ${workbook.worksheets.length}ã‚·ãƒ¼ãƒˆçµ±åˆã€æ›¸å¼ä¿æŒãƒ¢ãƒ¼ãƒ‰ï¼‰`;

        // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰
        buildPreferenceTable();
      }catch(e){
        console.error('âŒ parseBoothExcel ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', e.stack);
        $('boothExcelStatus').innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`;
      }
    }

    // ================= Excel import: å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«è¡¨ï¼‰ =================
    function isDateCell(v){
      if (v == null) return false;
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) return true;
      if (typeof v === 'string'){
        const s = v.trim();
        // å—ã‘å…¥ã‚Œ: YYYY/MM/DD, YYYY-MM-DD, MM/DD, M/D, MM-DD
        if (/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}(?:\s+\d{2}:\d{2}:\d{2})?$/.test(s)) return true;
        if (/^\d{1,2}[\/-]\d{1,2}(?:\([^\)]*\))?$/.test(s)) return true; // 11/03 ã‚„ 11/03(æœˆ)
      }
      return false;
    }
    function normalizeDateToYmd(v, ymFallback){
      let d=null;
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) {
        d=v; return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
      }
      if (typeof v === 'string'){
        const s=v.trim();
        if (/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}/.test(s)){
          d=new Date(s.replace(/-/g,'/'));
          if (!isNaN(d)) return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
        }
        const m=s.match(/^(\d{1,2})[\/-](\d{1,2})/);
        if (m && ymFallback){
          return `${ymFallback.year}/${ymFallback.month}/${pad2(m[2])}`;
        }
      }
      return null;
    }
    function findHeaderRowByDates(rows){
      // æœ€åˆã®10è¡Œã§ã€æ—¥ä»˜ã‚‰ã—ãã‚»ãƒ«ãŒ3ã¤ä»¥ä¸Šã‚ã‚‹è¡Œã‚’ãƒ˜ãƒƒãƒ€ã¨ã¿ãªã™
      let bestIdx = 0, bestCount = -1;
      for (let r=0;r<Math.min(rows.length, 10); r++){
        const row = rows[r] || [];
        let cnt=0;
        for (let c=0;c<row.length;c++) if (isDateCell(row[c])) cnt++;
        if (cnt > bestCount){ bestCount = cnt; bestIdx = r; }
      }
      return bestIdx;
    }
    function collectDateTeacherColumns(rows, ymFallback){
      const headerRowIdx = findHeaderRowByDates(rows);
      const header = rows[headerRowIdx] || [];
      const pairs = [];
      for (let c=0;c<header.length;c++){
        const v = header[c];
        if (!isDateCell(v)) continue;
        const ymd = normalizeDateToYmd(v, ymFallback);
        if (!ymd) continue;
        const teacherCol = c + 1; // å³éš£ã‚’è¬›å¸«åˆ—
        pairs.push({ dateCol:c, teacherCol, ymd });
      }
      return pairs;
    }
    function cleanTeacherName(s){
      if (s == null) return null;
      // ä¸¸ä»˜ãæ•°å­—ï¼ˆâ‘ -â‘³ï¼‰ã‚’é™¤å¤–
      let t = String(s).replace(/[\u2460-\u2473]/g, '');
      // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã«å¤‰æ›ã€ãƒˆãƒªãƒ ã€é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
      t = t.replace(/\u3000/g, ' ').trim().replace(/\s+/g,' ');
      return t.length ? t : null;
    }
    function idFromName(name){
      // simple stable hash -> Txxxxxx
      let h=5381; for (let i=0;i<name.length;i++){ h=((h<<5)+h)+name.charCodeAt(i); h|=0; }
      const hex = (h>>>0).toString(16).slice(-6).padStart(6,'0');
      return 'T' + hex.toUpperCase();
    }

    function formatTeacherNameForExcel(fullName, allTeacherNames){
      // ãƒ•ãƒ«ãƒãƒ¼ãƒ ã‚’ã€Œè‹—å­—+Tã€ã¾ãŸã¯ã€Œå+Tã€å½¢å¼ã«å¤‰æ›
      // è‹—å­—é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ã€Œå+Tã€ã‚’ä½¿ç”¨
      // ä¾‹: "è¥¿ã€€æ³°æˆ‘" -> "è¥¿T" ï¼ˆé‡è¤‡ãªã—ï¼‰
      // ä¾‹: "è¥¿ã€€æ³°æˆ‘", "è¥¿ã€€èŠ±å­" -> "æ³°æˆ‘T", "èŠ±å­T" ï¼ˆé‡è¤‡ã‚ã‚Šï¼‰

      const parts = fullName.replace(/\u3000/g, ' ').split(/\s+/);

      // ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã§ããªã„å ´åˆï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ å½¢å¼ã§ãªã„ï¼‰
      if (parts.length < 2) {
        return fullName + 'T';
      }

      const surname = parts[0];
      const givenName = parts[1];

      // åŒã˜è‹—å­—ã®è¬›å¸«ãŒä»–ã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const hasDuplicateSurname = allTeacherNames.some(name => {
        if (name === fullName) return false; // è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
        const otherParts = name.replace(/\u3000/g, ' ').split(/\s+/);
        return otherParts.length >= 1 && otherParts[0] === surname;
      });

      if (hasDuplicateSurname) {
        console.log(`  ğŸ“ è‹—å­—é‡è¤‡æ¤œå‡º: ${fullName} -> ${givenName}T`);
        return givenName + 'T'; // å+T
      } else {
        return surname + 'T'; // è‹—å­—+T
      }
    }
    // ================= Excel export: ãƒ–ãƒ¼ã‚¹è¡¨å½¢å¼ï¼ˆExcelJS - æ›¸å¼å®Œå…¨ä¿æŒï¼‰=================
    async function saveAsExcel(mode){
      try{
        if(lastAssignments.length === 0){
          excelStatus.innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼:</span> å‰²å½“ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„';
          return;
        }

        if(!originalBoothWorkbook){
          excelStatus.innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼:</span> å…ƒã®ãƒ–ãƒ¼ã‚¹è¡¨ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          return;
        }

        // å…¨è¬›å¸«åã®ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆé‡è¤‡æ’é™¤ï¼‰
        const allTeacherNames = [...new Set(lastAssignments
          .filter(a => a.teacherName)
          .map(a => a.teacherName))];
        console.log('å…¨è¬›å¸«åãƒªã‚¹ãƒˆ:', allTeacherNames);

        console.log('ExcelJSã§å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã«è¬›å¸«ã‚’è¨˜å…¥ä¸­...');

        // å¯¾è±¡ã‚·ãƒ¼ãƒˆã‚’å–å¾—
        const targetSheetName = boothSheetInfo.sheetName;
        const worksheet = originalBoothWorkbook.getWorksheet(targetSheetName);

        if(!worksheet){
          throw new Error(`ã‚·ãƒ¼ãƒˆ "${targetSheetName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        }

        // ã‚¹ãƒ†ãƒƒãƒ—1: å‰²å½“çµæœã‚’ã‚»ãƒ«ã«æ›¸ãè¾¼ã‚€ï¼ˆå€¤ã®ã¿ï¼‰
        console.log('ã‚¹ãƒ†ãƒƒãƒ—1: ã‚»ãƒ«å€¤ã‚’æ›¸ãè¾¼ã¿ä¸­...');
        let assignedCount = 0;
        const formattedCells = []; // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®šãŒå¿…è¦ãªã‚»ãƒ«ã‚’è¨˜éŒ²

        for(const assignment of lastAssignments){
          if(!assignment.teacherId) continue; // è¬›å¸«ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

          const key = `${assignment.date}_${assignment.time}_${assignment.boothId}`;
          const pos = boothSheetInfo.cellPositions[key];

          if(!pos) continue;

          // è¬›å¸«ã‚»ãƒ«ã‚’å–å¾—
          const teacherCell = worksheet.getCell(pos.row, pos.teacherCol);

          // è¬›å¸«åã‚’è¨˜å…¥ï¼ˆè‹—å­—+Tå½¢å¼ï¼‰
          const teacherName = formatTeacherNameForExcel(assignment.teacherName || assignment.teacherId, allTeacherNames);

          // æ—¢å­˜ã®ã‚»ãƒ«å€¤ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¸ä»˜ãæ•°å­—ãŒã‚ã‚‹å ´åˆã¯ä¿æŒï¼‰
          let existingValue = teacherCell.value || '';
          let finalTeacherValue = teacherName;

          if (typeof existingValue === 'string' && /[\u2460-\u2473]/.test(existingValue)) {
            finalTeacherValue = existingValue.trim() + '\n' + teacherName;
            console.log(`  æ—¢å­˜ã®ä¸¸ä»˜ãæ•°å­—ã‚’ä¿æŒ: ${existingValue.trim()} â†’ ${finalTeacherValue}`);
          }

          teacherCell.value = finalTeacherValue;
          formattedCells.push({ row: pos.row, col: pos.teacherCol, cellValue: finalTeacherValue });

          // ç”Ÿå¾’ã‚’è¨˜å…¥ï¼ˆè¬›å¸«åˆ—ã®å³ã®åˆ—ï¼‰
          if(assignment.students && assignment.students.length > 0){
            const studentCol = pos.teacherCol + 1; // è¬›å¸«åˆ—ã®å³
            const studentCell = worksheet.getCell(pos.row, studentCol);

            let studentValue = '';
            for(let i = 0; i < assignment.students.length; i++){
              const student = assignment.students[i];
              if(i > 0) studentValue += '\n';
              studentValue += student.studentName;
              if(student.subject) studentValue += `(${student.subject})`;
            }

            studentCell.value = studentValue;
            formattedCells.push({ row: pos.row, col: studentCol, cellValue: studentValue });
            console.log(`  ç”Ÿå¾’è¨˜å…¥: ${studentValue} -> ã‚»ãƒ«(${pos.row}, ${studentCol})`);
          }

          assignedCount++;
        }

        console.log(`${assignedCount}ä»¶ã®è¬›å¸«ã‚’è¨˜å…¥å®Œäº†`);
        console.log(`formattedCellsé…åˆ—ã®é•·ã•: ${formattedCells.length}`);

        // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã¨ç¸¦æ›¸ãè¨­å®šã‚’é©ç”¨
        console.log('ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ã‚©ãƒ³ãƒˆãƒ»ç¸¦æ›¸ãè¨­å®šã‚’é©ç”¨ä¸­...');
        let formatCount = 0;
        for(const {row, col, cellValue} of formattedCells){
          formatCount++;
          console.log(`  [${formatCount}] ã‚»ãƒ«(${row}, ${col}): "${cellValue}"`);

          // ã‚»ãƒ«ã‚’å†å–å¾—ï¼ˆé‡è¦: ã“ã“ã§æ–°ã—ãå–å¾—ã™ã‚‹ï¼‰
          const cell = worksheet.getCell(row, col);

          // è¨­å®šå‰ã®çŠ¶æ…‹ã‚’ç¢ºèª
          console.log(`    è¨­å®šå‰: font=${JSON.stringify(cell.font)}, alignment=${JSON.stringify(cell.alignment)}`);

          // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆç›´æ¥è¨­å®šã§ä¸Šæ›¸ãï¼‰
          // ç¸¦æ›¸ãç”¨ãƒ•ã‚©ãƒ³ãƒˆã¯ '@' ã‚’å…ˆé ­ã«ä»˜ã‘ã‚‹
          cell.font = {
            name: '@MS PGothic',  // ç¸¦æ›¸ãç”¨ãƒ•ã‚©ãƒ³ãƒˆï¼ˆ@ã‚’å…ˆé ­ã«ä»˜ã‘ã‚‹ï¼‰
            size: 8,
            family: 1,  // ã‚´ã‚·ãƒƒã‚¯ç³»
            charset: 128  // æ—¥æœ¬èª
          };

          // ç¸¦æ›¸ãè¨­å®šï¼ˆç›´æ¥è¨­å®šã§ä¸Šæ›¸ãï¼‰
          cell.alignment = {
            textRotation: 'vertical',  // ExcelJSã§ã¯æ–‡å­—åˆ—'vertical'ã‚’ä½¿ç”¨
            vertical: 'top',
            horizontal: 'center',
            wrapText: true
          };

          // è¨­å®šå¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
          console.log(`    è¨­å®šå¾Œ: font=${JSON.stringify(cell.font)}, alignment=${JSON.stringify(cell.alignment)}`);

          // ã‚»ãƒ«ã®å¹…ã‚’èª¿æ•´ï¼ˆç¸¦æ›¸ãç”¨ï¼‰
          const column = worksheet.getColumn(col);
          if (!column.width || column.width < 4) {
            column.width = 4;  // ç¸¦æ›¸ãã«é©ã—ãŸå¹…
          }
        }

        console.log(`${formattedCells.length}ä»¶ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®šå®Œäº†`);

        const filename = mode === 'teacher'
          ? makeTsPrefix() + '_è¬›å¸«é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsx'
          : makeTsPrefix() + '_ç”Ÿå¾’é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsx';

        console.log('ExcelJSã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­:', filename);

        // ExcelJSã§ãƒã‚¤ãƒŠãƒªã‚’ç”Ÿæˆ
        const buffer = await originalBoothWorkbook.xlsx.writeBuffer();

        // ä¿å­˜ç›´å‰ã®æ¤œè¨¼: ãƒãƒƒãƒ•ã‚¡ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèª
        console.log('\nğŸ” ä¿å­˜ç›´å‰ã®æ¤œè¨¼: ãƒãƒƒãƒ•ã‚¡ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç¢ºèª');
        const verifyWorkbook = new ExcelJS.Workbook();
        await verifyWorkbook.xlsx.load(buffer);
        const verifyWorksheet = verifyWorkbook.getWorksheet(targetSheetName);

        // æœ€åˆã®3ä»¶ã®ã‚»ãƒ«ã‚’ç¢ºèª
        let verifyCount = 0;
        for(const {row, col, cellValue} of formattedCells){
          if(verifyCount >= 3) break;
          verifyCount++;
          const verifyCell = verifyWorksheet.getCell(row, col);
          console.log(`  ã‚»ãƒ«(${row}, ${col}): "${verifyCell.value}"`);
          console.log(`    font: ${JSON.stringify(verifyCell.font)}`);
          console.log(`    alignment: ${JSON.stringify(verifyCell.alignment)}`);

          const fontOK = verifyCell.font?.name === '@MS PGothic' && verifyCell.font?.size === 8;
          const alignmentOK = verifyCell.alignment?.textRotation === 'vertical';
          if (fontOK && alignmentOK) {
            console.log(`    âœ… æ¤œè¨¼OK`);
          } else {
            console.log(`    âŒ æ¤œè¨¼NG`);
            if (!fontOK) console.log(`       ãƒ•ã‚©ãƒ³ãƒˆ: ${verifyCell.font?.name}, ã‚µã‚¤ã‚º: ${verifyCell.font?.size}`);
            if (!alignmentOK) console.log(`       ç¸¦æ›¸ã: ${verifyCell.alignment?.textRotation}`);
          }
        }
        console.log('');

        // Blobã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);

        console.log('âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†:', filename);
        excelStatus.innerHTML = `<span class="ok">âœ“</span> ${filename} ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆæ›¸å¼å®Œå…¨ä¿æŒãƒ»ExcelJSï¼‰`;
      }catch(e){
        console.error(e);
        excelStatus.innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`;
      }
    }

    // ================= å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«æå‡ºã‚·ãƒ•ãƒˆï¼‰ã®èª­ã¿è¾¼ã¿ =================
    async function parseTeacherExcel(input){
      const file = input.files?.[0];
      if (!file){ $('teacherExcelStatus').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'; return; }
      try{
        console.log('ğŸŸ¢ parseTeacherExcel: é–‹å§‹');
        const buf = await file.arrayBuffer();
        console.log('ğŸŸ¢ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', buf.byteLength, 'bytes');

        // ExcelJSã§ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã¿
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buf);
        console.log('ğŸŸ¢ workbook.xlsx.loadå®Œäº†');
        console.log(`ğŸŸ¢ å…¨ã‚·ãƒ¼ãƒˆæ•°: ${workbook.worksheets.length}`);

        // å…¨ã‚·ãƒ¼ãƒˆã‚’å‡¦ç†ã—ã¦çµ±åˆ
        let allShifts = [];
        const seen = new Set();

        for (let sheetIndex = 0; sheetIndex < workbook.worksheets.length; sheetIndex++) {
          const worksheet = workbook.worksheets[sheetIndex];
          const sheetName = worksheet.name;
          console.log(`\nğŸŸ¢ ã‚·ãƒ¼ãƒˆ${sheetIndex + 1}/${workbook.worksheets.length}: ${sheetName}`);

          // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›
          const rows = [];
          worksheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
            const rowData = [];
            row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
              // ã‚»ãƒ«ã®å€¤ã‚’å®‰å…¨ã«å–å¾—ï¼ˆãƒãƒ¼ã‚¸ã‚»ãƒ«ã€ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œï¼‰
              let cellValue;
              try {
                // æ—¥ä»˜ã‚»ãƒ«ã®å ´åˆã¯ cell.value (Date object) ã‚’å„ªå…ˆ
                if (cell.value instanceof Date) {
                  cellValue = cell.value;
                } else if (cell.text !== undefined && cell.text !== null) {
                  cellValue = cell.text;
                } else {
                  cellValue = getCellValue(cell);
                }
              } catch (e) {
                // cell.textã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆï¼ˆãƒãƒ¼ã‚¸ã‚»ãƒ«ãªã©ï¼‰
                cellValue = getCellValue(cell);
              }
              rowData[colNumber - 1] = cellValue;
            });
            rows[rowNumber - 1] = rowData;
          });
          console.log(`  è¡Œãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†: ${rows.length}è¡Œ`);

          const ym = getOverrideYM() || detectYearMonthFromSheetName(sheetName) || detectYearMonthFromCells(rows);
          if (!ym) {
            console.warn(`  âš ï¸ å¹´/æœˆã®è‡ªå‹•æ¤œå‡ºã«å¤±æ•—: ${sheetName} - ã‚¹ã‚­ãƒƒãƒ—`);
            continue;
          }
          console.log(`  å¹´æœˆ: ${ym.year}/${ym.month}`);

          const pairs = collectDateTeacherColumns(rows, ym);
          if (!pairs.length) {
            console.warn(`  âš ï¸ æ—¥ä»˜åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—`);
            continue;
          }
          console.log(`  æ—¥ä»˜åˆ—: ${pairs.length}ä»¶`);

          const times = buildEffectiveTimes(rows, 0); // Aåˆ—ã®æ™‚åˆ»ã‚’ä¸‹æ–¹å‘ã«ç¶™æ‰¿
          console.log(`  æ™‚åˆ»: ${times.filter(t => t).length}ä»¶`);

          const shifts = [];
          for (let r=0;r<rows.length;r++){
            const time = times[r]; if (!time) continue;
            for (const {ymd, teacherCol} of pairs){
              const name = cleanTeacherName(rows[r]?.[teacherCol]);
              if (!name) continue;
              const tid = idFromName(name);
              const key = `${ymd}_${time}_${tid}`;
              if (seen.has(key)) continue; seen.add(key);
              shifts.push({ date: ymd, time, teacherId: tid, teacherName: name, constraints: {} });
            }
          }
          console.log(`  è¬›å¸«å¯ç”¨æ : ${shifts.length}ä»¶`);

          // ã“ã®ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
          allShifts = allShifts.concat(shifts);
        }

        if (allShifts.length === 0) {
          throw new Error('æœ‰åŠ¹ãªè¬›å¸«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }

        allShifts.sort((a,b)=> (a.date+a.time+a.teacherId).localeCompare(b.date+b.time+b.teacherId));
        teacherData = allShifts;
        console.log('\nğŸŸ¢ parseTeacherExcel: å®Œäº† -', allShifts.length, 'ä»¶ï¼ˆ', workbook.worksheets.length, 'ã‚·ãƒ¼ãƒˆçµ±åˆï¼‰');
        $('teacherExcelStatus').innerHTML = `<span class="ok">âœ“ èª­ã¿è¾¼ã¿å®Œäº†:</span> ${allShifts.length}ä»¶ï¼ˆ${workbook.worksheets.length}ã‚·ãƒ¼ãƒˆçµ±åˆï¼‰`;

        // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰
        buildPreferenceTable();
      }catch(e){
        console.error('âŒ parseTeacherExcel ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', e.stack);
        $('teacherExcelStatus').innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`;
      }
    }

    // ================= ç”Ÿå¾’ãƒ»è¬›å¸«æƒ…å ±ã®èª­ã¿è¾¼ã¿ =================
    async function parseStudentDemandExcel(input){
      const file = input.files?.[0];
      if (!file){ $('studentExcelStatus').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'; return; }
      try{
        console.log('ğŸŸ¢ parseStudentDemandExcel: é–‹å§‹');
        const buf = await file.arrayBuffer();
        console.log('ğŸŸ¢ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', buf.byteLength, 'bytes');

        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buf);
        console.log('ğŸŸ¢ workbook.xlsx.loadå®Œäº†');
        console.log('ğŸŸ¢ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆæ•°:', workbook.worksheets.length);

        // ã‚·ãƒ¼ãƒˆåã‚’ç¢ºèª
        let studentSheet = null;
        let teacherSubjectSheet = null;

        for (const sheet of workbook.worksheets) {
          console.log(`  ã‚·ãƒ¼ãƒˆ: ${sheet.name}`);
          if (sheet.name.includes('ç”Ÿå¾’ã‚³ãƒæ•°') || sheet.name.includes('ç”Ÿå¾’') && sheet.name.includes('ã‚³ãƒ')) {
            studentSheet = sheet;
          } else if (sheet.name.includes('æŒ‡å°å¯èƒ½') || sheet.name.includes('æ•™ç§‘ä¸€è¦§')) {
            teacherSubjectSheet = sheet;
          }
        }

        // ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’ä½¿ç”¨
        if (!studentSheet && workbook.worksheets.length > 0) {
          studentSheet = workbook.worksheets[workbook.worksheets.length - 1]; // æœ€å¾Œã®ã‚·ãƒ¼ãƒˆ
        }
        if (!teacherSubjectSheet && workbook.worksheets.length > 1) {
          teacherSubjectSheet = workbook.worksheets[0]; // æœ€åˆã®ã‚·ãƒ¼ãƒˆ
        }

        console.log('ğŸŸ¢ ç”Ÿå¾’ã‚³ãƒæ•°è¡¨ã‚·ãƒ¼ãƒˆ:', studentSheet?.name || 'ãªã—');
        console.log('ğŸŸ¢ æŒ‡å°å¯èƒ½æ•™ç§‘ä¸€è¦§ã‚·ãƒ¼ãƒˆ:', teacherSubjectSheet?.name || 'ãªã—');

        // ========== ã‚·ãƒ¼ãƒˆ1: æŒ‡å°å¯èƒ½æ•™ç§‘ä¸€è¦§ã®å‡¦ç† ==========
        if (teacherSubjectSheet) {
          console.log('\nğŸ“š æŒ‡å°å¯èƒ½æ•™ç§‘ä¸€è¦§ã®è§£æé–‹å§‹');
          teacherSubjectMap = parseTeacherSubjects(teacherSubjectSheet);
          console.log(`âœ“ è¬›å¸«-ç§‘ç›®ãƒãƒƒãƒ”ãƒ³ã‚°å®Œäº†: ${Object.keys(teacherSubjectMap).length}åã®è¬›å¸«`);
        }

        // ========== ã‚·ãƒ¼ãƒˆ2: ç”Ÿå¾’ã‚³ãƒæ•°è¡¨ã®å‡¦ç† ==========
        const demands = [];
        if (studentSheet) {
          console.log('\nğŸ“ ç”Ÿå¾’ã‚³ãƒæ•°è¡¨ã®è§£æé–‹å§‹');

          // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›
          const rows = [];
          studentSheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
            const rowData = [];
            row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
              // ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é©åˆ‡ã«æ–‡å­—åˆ—åŒ–
              rowData[colNumber - 1] = getCellValue(cell);
            });
            rows[rowNumber - 1] = rowData;
          });
          console.log('ğŸŸ¢ è¡Œãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†:', rows.length, 'è¡Œ');

          // ç§‘ç›®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆåˆ—ç•ªå· -> ç§‘ç›®åï¼‰
          const subjectMap = {
            3: 'è‹±èª',      // åˆ—D (0-indexed: 3)
            4: 'è‹±æ¤œ',      // åˆ—E
            5: 'æ•°å­¦',      // åˆ—F
            6: 'ç®—æ•°',      // åˆ—G
            7: 'å›½èª',      // åˆ—H
            8: 'ç†ç§‘',      // åˆ—I
            9: 'ç¤¾ä¼š',      // åˆ—J
            10: 'å¤æ–‡',     // åˆ—K
            11: 'ç‰©ç†',     // åˆ—L
            12: 'åŒ–å­¦',     // åˆ—M
            13: 'ç”Ÿç‰©',     // åˆ—N
            15: 'åœ°ç†',     // åˆ—P
            16: 'æ”¿æ²»çµŒæ¸ˆ', // åˆ—Q
            17: 'ä¸–ç•Œå²',   // åˆ—R
            18: 'æ—¥æœ¬å²'    // åˆ—S
          };

          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¡Œ0ï¼‰ã€ãƒ‡ãƒ¼ã‚¿è¡Œã¯è¡Œ1ã‹ã‚‰
          for (let rowIdx = 1; rowIdx < rows.length; rowIdx++) {
            const row = rows[rowIdx];

            // ç©ºè¡Œã¾ãŸã¯èª¬æ˜è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!row || !row[0] || !row[1] || !row[2]) continue;

            // èª¬æ˜è¡Œï¼ˆãƒãƒ¼ã‚¸ã‚»ãƒ«ã§é•·ã„ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
            const studentName = String(row[2] || '').trim();
            if (studentName.includes('ã€è¨˜å…¥ä¾‹ã€‘') || studentName.length > 50) continue;

            const grade = String(row[0] || '').trim();
            const schoolName = String(row[1] || '').trim();
            const preferredTeachers = parseCommaSeparated(row[20]) || []; // åˆ—U (0-indexed: 20)
            const ngTeachers = parseCommaSeparated(row[21]) || [];         // åˆ—V
            const ngStudents = parseCommaSeparated(row[22]) || [];         // åˆ—W
            const preferredTimes = parseCommaSeparated(row[23]) || [];     // åˆ—X (ä¾‹: æœˆ17,æ°´19)
            const ngDays = parseCommaSeparated(row[24]) || [];             // åˆ—Y (ä¾‹: ç«,åœŸ)
            const note = String(row[25] || '').trim();               // åˆ—Z

            console.log(`\nğŸ“š ç”Ÿå¾’: ${studentName}`);

            // å„ç§‘ç›®ã®ã‚³ãƒæ•°ã‚’å–å¾—ã—ã¦éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            for (const [colIdx, subjectName] of Object.entries(subjectMap)) {
              const count = parseInt(row[colIdx]) || 0;
              if (count === 0) continue;

              console.log(`  ${subjectName}: ${count}ã‚³ãƒ`);

              // å¿…è¦ã‚³ãƒæ•°åˆ†ã ã‘éœ€è¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
              for (let i = 0; i < count; i++) {
                demands.push({
                  studentId: studentName,       // ç”Ÿå¾’åã‚’IDã¨ã—ã¦ä½¿ç”¨
                  studentName: studentName,
                  subject: subjectName,
                  grade: grade,
                  schoolName: schoolName,
                  preferredTeachers: preferredTeachers,
                  ngTeachers: ngTeachers,
                  ngStudents: ngStudents,
                  preferredTimes: preferredTimes,  // ä¾‹: ['æœˆ17', 'æ°´19']
                  ngDays: ngDays,                  // ä¾‹: ['ç«', 'åœŸ']
                  note: note,
                  priority: calculatePriority(grade, note),  // å„ªå…ˆåº¦è¨ˆç®—
                  classIndex: i,  // ã“ã®ã‚³ãƒãŒä½•å›ç›®ã‹ï¼ˆ0å§‹ã¾ã‚Šï¼‰
                  totalClasses: count  // å…¨ä½“ã§ä½•ã‚³ãƒå¿…è¦ã‹
                });
              }
            }
          }
        } // end of if (studentSheet)

        studentDemandData = demands;
        const teacherCount = Object.keys(teacherSubjectMap).length;
        const summaryParts = [];
        if (demands.length > 0) summaryParts.push(`${demands.length}ä»¶ã®éœ€è¦ãƒ‡ãƒ¼ã‚¿`);
        if (teacherCount > 0) summaryParts.push(`${teacherCount}åã®è¬›å¸«ç§‘ç›®ãƒãƒƒãƒ—`);

        console.log('ğŸŸ¢ parseStudentDemandExcel: å®Œäº† -', summaryParts.join(', '));
        const statusText = summaryParts.length > 0 ? summaryParts.join(', ') : 'èª­ã¿è¾¼ã¿å®Œäº†';
        $('studentExcelStatus').innerHTML = `<span class="ok">âœ“ èª­ã¿è¾¼ã¿å®Œäº†:</span> ${statusText}`;
      }catch(e){
        console.error('âŒ parseStudentDemandExcel ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', e.stack);
        $('studentExcelStatus').innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`;
      }
    }

    // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
    function parseCommaSeparated(value){
      if (!value) return [];
      return String(value).split(',').map(s => s.trim()).filter(s => s);
    }

    // å„ªå…ˆåº¦ã‚’è¨ˆç®—ï¼ˆé«˜ã„æ–¹ãŒå„ªå…ˆï¼‰
    // å„ªå…ˆåº¦è¨ˆç®—ã¯ä½¿ç”¨ã—ãªã„ï¼ˆå…¨ç”Ÿå¾’ã‚’å¹³ç­‰ã«æ‰±ã†ï¼‰
    function calculatePriority(grade, note){
      return 5; // å›ºå®šå€¤
    }

    // æŒ‡å°å¯èƒ½æ•™ç§‘ä¸€è¦§ã‚’ãƒ‘ãƒ¼ã‚¹
    function parseTeacherSubjects(worksheet){
      console.log('ğŸ“– parseTeacherSubjects: é–‹å§‹');

      // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—å½¢å¼ã«å¤‰æ›
      const rows = [];
      worksheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
        const rowData = [];
        row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
          rowData[colNumber - 1] = getCellValue(cell);
        });
        rows[rowNumber - 1] = rowData;
      });

      // è¬›å¸«åã¯åˆ—Bï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ï¼‰ã€è¡Œ4ä»¥é™
      // ç§‘ç›®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯è¡Œ3ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2ï¼‰
      const subjectHeaders = rows[2] || []; // è¡Œ3ã®ç§‘ç›®ãƒ˜ãƒƒãƒ€ãƒ¼

      const teacherMap = {};

      // è¬›å¸«ãƒ‡ãƒ¼ã‚¿ã¯è¡Œ4ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹3ï¼‰ã‹ã‚‰
      for (let rowIdx = 3; rowIdx < rows.length; rowIdx++) {
        const row = rows[rowIdx];
        if (!row || !row[1]) continue; // è¬›å¸«åãŒç©ºã®å ´åˆã‚¹ã‚­ãƒƒãƒ—

        const teacherName = String(row[1]).trim();
        if (!teacherName || teacherName === 'è¬›å¸«å') continue;

        // teacherIdã‚’ç”Ÿæˆ
        const teacherId = idFromName(teacherName);

        // æŒ‡å°å¯èƒ½ç§‘ç›®ã‚’åé›†
        const subjects = [];
        for (let colIdx = 2; colIdx < row.length; colIdx++) {
          const cellValue = row[colIdx];
          if (cellValue === 'â—¯' || cellValue === 'â—‹') {
            const subjectName = subjectHeaders[colIdx];
            if (subjectName) {
              // ç§‘ç›®åã‚’æ­£è¦åŒ–
              const normalizedSubject = normalizeSubjectName(String(subjectName).trim());
              if (normalizedSubject && !subjects.includes(normalizedSubject)) {
                subjects.push(normalizedSubject);
              }
            }
          }
        }

        if (subjects.length > 0) {
          teacherMap[teacherId] = subjects;
          teacherMap[teacherName] = subjects; // è¬›å¸«åã§ã‚‚æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«
          teacherNameMap[teacherId] = teacherName; // è¬›å¸«åã‚‚ä¿å­˜
          console.log(`  ${teacherName} (${teacherId}): ${subjects.join(', ')}`);
        }
      }

      console.log('âœ“ parseTeacherSubjects: å®Œäº†');
      return teacherMap;
    }

    // ç§‘ç›®åã‚’æ­£è¦åŒ–ï¼ˆç•¥ç§°ã‚’çµ±ä¸€ï¼‰
    function normalizeSubjectName(subject){
      const mapping = {
        'å›½': 'å›½èª',
        'ç®—': 'ç®—æ•°',
        'æ•°': 'æ•°å­¦',
        'è‹±': 'è‹±èª',
        'ç†': 'ç†ç§‘',
        'ç¤¾': 'ç¤¾ä¼š',
        'å¤': 'å¤æ–‡',
        'ç‰©': 'ç‰©ç†',
        'åŒ–': 'åŒ–å­¦',
        'ç”Ÿ': 'ç”Ÿç‰©',
        'åœ°': 'åœ°ç†',
        'æ”¿': 'æ”¿æ²»çµŒæ¸ˆ',
        'ä¸–': 'ä¸–ç•Œå²',
        'æ—¥': 'æ—¥æœ¬å²',
        'ç¾': 'ç¾ä»£æ–‡',
        'â… A': 'æ•°å­¦â… A',
        'â…¡B': 'æ•°å­¦â…¡B',
        'â…¢': 'æ•°å­¦â…¢',
        'C': 'æ•°å­¦C',
        'å€«': 'å€«ç†'
      };

      return mapping[subject] || subject;
    }

    // ================= å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š =================
    function buildPreferenceTable(){
      console.log('buildPreferenceTable called');
      console.log('teacherData.length:', teacherData.length);
      console.log('boothData.length:', boothData.length);

      if(teacherData.length === 0 || boothData.length === 0){
        return;
      }

      const tbody = $('preferenceTableBody');

      // è¬›å¸«ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡æ’é™¤ï¼‰
      const teachers = {};
      for(const t of teacherData){
        teachers[t.teacherId] = t.teacherName;
      }

      console.log('è¬›å¸«æ•°:', Object.keys(teachers).length);

      // ãƒ–ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡æ’é™¤ã€ä¸¸ä»˜ãæ•°å­—é †ã«ã‚½ãƒ¼ãƒˆï¼‰
      const booths = [...new Set(boothData.map(b => b.boothId))].sort();

      console.log('ãƒ–ãƒ¼ã‚¹æ•°:', booths.length);
      console.log('ãƒ–ãƒ¼ã‚¹ãƒªã‚¹ãƒˆ:', booths);

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰
      tbody.innerHTML = '';
      for(const [teacherId, teacherName] of Object.entries(teachers)){
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #f3f4f6';

        const tdName = document.createElement('td');
        tdName.style.padding = '4px 8px';
        tdName.textContent = teacherName;

        const tdBooth = document.createElement('td');
        tdBooth.style.padding = '4px 8px';

        const select = document.createElement('select');
        select.style.padding = '4px';
        select.style.border = '1px solid #e5e7eb';
        select.style.borderRadius = '4px';
        select.dataset.teacherId = teacherId;

        // ã€ŒæŒ‡å®šãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const optNone = document.createElement('option');
        optNone.value = '';
        optNone.textContent = 'æŒ‡å®šãªã—';
        select.appendChild(optNone);

        // ã€Œé™¤å¤–ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const optExclude = document.createElement('option');
        optExclude.value = 'EXCLUDE';
        optExclude.textContent = 'é™¤å¤–ï¼ˆå‰²ã‚Šå½“ã¦ã—ãªã„ï¼‰';
        optExclude.style.color = '#dc2626';
        optExclude.style.fontWeight = '600';
        select.appendChild(optExclude);

        // ãƒ–ãƒ¼ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆB1å½¢å¼ã‚’ä¸¸ä»˜ãæ•°å­—ã«å¤‰æ›ã—ã¦è¡¨ç¤ºï¼‰
        for(const boothId of booths){
          const opt = document.createElement('option');
          opt.value = boothId;
          opt.textContent = boothIdToCircled(boothId); // B1 â†’ â‘ 
          select.appendChild(opt);
        }

        // æ—¢å­˜ã®è¨­å®šã‚’åæ˜ 
        if(teacherPreferences[teacherId]){
          select.value = teacherPreferences[teacherId];
        }

        // å¤‰æ›´æ™‚ã«teacherPreferencesã‚’æ›´æ–°
        select.onchange = (e) => {
          const tid = e.target.dataset.teacherId;
          if(e.target.value){
            teacherPreferences[tid] = e.target.value;
            console.log('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š:', tid, '->', e.target.value);
          } else {
            delete teacherPreferences[tid];
            console.log('å„ªå…ˆãƒ–ãƒ¼ã‚¹è§£é™¤:', tid);
          }
        };

        tdBooth.appendChild(select);
        tr.appendChild(tdName);
        tr.appendChild(tdBooth);
        tbody.appendChild(tr);
      }

      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹ç¯‰å®Œäº†');
    }

    function togglePreferenceSettings(){
      const container = $('preferenceContainer');
      const btn = $('hidePreferenceBtn');

      if(container.style.display === 'none'){
        container.style.display = 'block';
        btn.textContent = 'è¨­å®šã‚’éè¡¨ç¤º';
        toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'ok');
      } else {
        container.style.display = 'none';
        btn.textContent = 'è¨­å®šã‚’è¡¨ç¤º';
        toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ', 'ok');
      }
    }

    function savePreferenceSettings(){
      try{
        localStorage.setItem('teacherPreferences', JSON.stringify(teacherPreferences));
        toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'ok');
      }catch(e){
        console.error(e);
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'err');
      }
    }

    function loadPreferenceSettings(){
      try{
        const saved = localStorage.getItem('teacherPreferences');
        if(saved){
          teacherPreferences = JSON.parse(saved);
          toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'ok');
          // UIãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
          if($('preferenceContainer').style.display !== 'none'){
            buildPreferenceTable(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æ§‹ç¯‰
          }
        } else {
          toast('ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warn');
        }
      }catch(e){
        console.error(e);
        toast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'err');
      }
    }
  })();

  // ================= ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ =================
  let draggedCell = null;

  function handleDragStart(e){
    draggedCell = e.target;
    e.target.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target.innerHTML);
  }

  function handleDragOver(e){
    if (e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
  }

  function handleDragEnter(e){
    if(e.target.tagName === 'TD' && e.target.dataset.date){
      e.target.style.background = '#dbeafe';
    }
  }

  function handleDragLeave(e){
    if(e.target.tagName === 'TD' && e.target.dataset.date){
      // å…ƒã®èƒŒæ™¯è‰²ã«æˆ»ã™
      const isEmpty = !e.target.innerHTML.trim() || e.target.innerHTML === '';
      e.target.style.background = isEmpty ? '' : '';
    }
  }

  function handleDrop(e){
    if (e.stopPropagation) {
      e.stopPropagation();
    }

    e.target.style.background = '';

    if (draggedCell === e.target) {
      return false;
    }

    // ãƒ‰ãƒ©ãƒƒã‚°å…ƒã¨ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®æƒ…å ±ã‚’å–å¾—
    const fromDate = draggedCell.dataset.date;
    const fromTime = draggedCell.dataset.time;
    const fromBooth = draggedCell.dataset.booth;

    const toDate = e.target.dataset.date;
    const toTime = e.target.dataset.time;
    const toBooth = e.target.dataset.booth;

    if(!toDate || !toTime || !toBooth){
      console.warn('ç„¡åŠ¹ãªãƒ‰ãƒ­ãƒƒãƒ—å…ˆã§ã™');
      draggedCell.style.opacity = '';
      return false;
    }

    // lastAssignmentsé…åˆ—ã‚’æ›´æ–°
    const $ = id => document.getElementById(id);
    const scriptScope = window; // ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å–å¾—

    // IIFEã®ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€ä»£æ›¿æ–¹æ³•ã‚’ä½¿ç”¨
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»ã™ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã™
    console.log(`ç§»å‹•: ${fromDate} ${fromTime} ${fromBooth} â†’ ${toDate} ${toTime} ${toBooth}`);

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦ã€IIFEå†…ã®lastAssignmentsã‚’æ›´æ–°
    const event = new CustomEvent('updateAssignment', {
      detail: { fromDate, fromTime, fromBooth, toDate, toTime, toBooth }
    });
    document.dispatchEvent(event);

    draggedCell.style.opacity = '';
    return false;
  }
  </script>
</body>
</html>