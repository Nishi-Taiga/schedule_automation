<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ™‚é–“å‰² è‡ªå‹•å‰²å½“ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Meiryo, sans-serif; padding: 24px; line-height: 1.6; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    h2 { font-size: 1.1rem; margin: 18px 0 8px; }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin: 12px 0; }
    .row { margin: 8px 0; }
    textarea { width: 100%; min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; }
    button { padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: #f9fafb; }
    button + button { margin-left: 8px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .small { font-size: 12px; color: #6b7280; }
    .ok { color: #16a34a; font-weight: 600; }
    .warn { color: #b45309; font-weight: 600; }
    .err { color: #dc2626; font-weight: 600; }
    .nowrap { white-space: nowrap; }
    #previewTable { width: 100%; }
    #previewTable th, #previewTable td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: left; }
    #previewTable th { background: #f3f4f6; font-weight: 600; }
    #previewTable .empty { background: #fef3c7; }
    #previewTable .assigned { background: #d1fae5; }
  </style>
</head>
<body>
  <h1>æ™‚é–“å‰² è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ </h1>

  <div class="card">
    <div class="row">
      <div class="small">ãƒ–ãƒ¼ã‚¹è¡¨ã¨å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«è¡¨ï¼‰ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€è¬›å¸«ã‚’è‡ªå‹•é…ç½®ã—ã¾ã™ã€‚</div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘  ãƒ–ãƒ¼ã‚¹è¡¨ï¼ˆ.xlsxï¼‰ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="row">
        <input type="file" id="boothExcelFile" accept=".xlsx,.xls" />
        <span id="boothExcelStatus" class="small"></span>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘¡ å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«è¡¨ .xlsxï¼‰ã‚’èª­ã¿è¾¼ã‚€</h2>
      <div class="row">
        <input type="file" id="teacherExcelFile" accept=".xlsx,.xls" />
        <span id="teacherExcelStatus" class="small"></span>
      </div>
    </div>

    <div class="row" style="margin-top:20px;">
      <h2>â‘¡-2 è¬›å¸«ã®å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
      <div class="small">èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€è¬›å¸«ã”ã¨ã«å„ªå…ˆçš„ã«é…ç½®ã™ã‚‹ãƒ–ãƒ¼ã‚¹ã‚’è¨­å®šã§ãã¾ã™</div>
      <div class="row" style="margin-top:8px;">
        <button id="showPreferenceBtn">å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’è¡¨ç¤º</button>
        <button id="savePreferenceBtn">è¨­å®šã‚’ä¿å­˜</button>
        <button id="loadPreferenceBtn">è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
      </div>
      <div id="preferenceContainer" style="display:none; margin-top:12px; max-height:300px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px; padding:12px;">
        <table id="preferenceTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:4px 8px; border-bottom:1px solid #e5e7eb;">è¬›å¸«å</th>
              <th style="text-align:left; padding:4px 8px; border-bottom:1px solid #e5e7eb;">å„ªå…ˆãƒ–ãƒ¼ã‚¹</th>
            </tr>
          </thead>
          <tbody id="preferenceTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="row" style="margin-top:24px;">
      <button id="runBtn" style="font-size:16px; padding:12px 24px; font-weight:600;">â‘¢ è¬›å¸«ã‚’å‰²ã‚Šå½“ã¦ã‚‹</button>
      <span id="status" class="small"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <h2>â‘£ çµæœã‚’ä¿å­˜</h2>
      <div class="small">è¬›å¸«ãŒé…ç½®ã•ã‚ŒãŸãƒ–ãƒ¼ã‚¹è¡¨ã‚’Excelãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜ã—ã¾ã™</div>
    </div>
    <div class="row">
      <button id="saveTeacherExcelBtn" style="font-size:16px; padding:12px 24px; font-weight:600; background:#10b981; color:white; border:none;">è¬›å¸«é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsxã‚’ä¿å­˜</button>
      <span id="excelStatus" class="small"></span>
    </div>
  </div>

  <div class="card">
    <div class="row nowrap"><strong>å‰²å½“çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong></div>
    <div class="row">
      <button id="togglePreviewBtn">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
    </div>
    <div id="previewContainer" style="display:none; margin-top:12px; overflow-x:auto;">
      <table id="previewTable" style="border-collapse:collapse; font-size:12px; min-width:100%;">
      </table>
    </div>
  </div>

  <div class="card" style="display:none;" id="advancedCard">
    <div class="row">
      <button id="toggleAdvancedBtn">è©³ç´°è¨­å®šãƒ»ãã®ä»–ã®å‡ºåŠ›ã‚’è¡¨ç¤º</button>
    </div>
    <div id="advancedContent" style="display:none; margin-top:12px;">
      <div class="row">
        <strong>æ¤œçŸ¥ãƒ¬ãƒãƒ¼ãƒˆ</strong>
        <div class="small">æœªå‰²å½“ã‚„è­¦å‘Šã®ä¸€è¦§</div>
      </div>
      <textarea id="reportOut" placeholder="è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»æœªå‰²å½“ãªã©ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™" style="min-height:100px;"></textarea>
      <div class="row">
        <button id="copyReportBtn">ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="saveReportBtn">ãƒ¬ãƒãƒ¼ãƒˆ(CSV)ä¿å­˜</button>
      </div>

      <div class="row" style="margin-top:16px;">
        <strong>CSVå‡ºåŠ›</strong>
        <div class="small">è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆdate,time,boothId,teacherId,teacherName,studentId,subjectï¼‰</div>
      </div>
      <textarea id="assignmentsOut" placeholder="å®Ÿè¡Œå¾Œã«ã“ã“ã¸å‡ºåŠ›" style="min-height:100px;"></textarea>
      <div class="row">
        <button id="copyCsvBtn">CSVã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="saveCsvBtn">CSVã§ä¿å­˜</button>
      </div>

      <div class="row" style="margin-top:16px;">
        <button id="saveLogBtn">å®Ÿè¡Œãƒ­ã‚°(JSON)ä¿å­˜</button>
        <button id="saveStudentExcelBtn">ç”Ÿå¾’é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsxï¼ˆç”Ÿå¾’æƒ…å ±å«ã‚€ï¼‰</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const $ = id => document.getElementById(id);

    const assignmentsOut = $('assignmentsOut');
    const reportOut = $('reportOut');
    const status = $('status');
    const excelStatus = $('excelStatus');

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¿
    $('boothExcelFile').onchange = () => parseBoothExcel($('boothExcelFile'));
    $('teacherExcelFile').onchange = () => parseTeacherExcel($('teacherExcelFile'));

    $('runBtn').onclick = run;
    $('saveTeacherExcelBtn').onclick = () => saveAsExcel('teacher');
    $('togglePreviewBtn').onclick = togglePreview;
    $('toggleAdvancedBtn').onclick = toggleAdvanced;

    // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š
    $('showPreferenceBtn').onclick = showPreferenceSettings;
    $('savePreferenceBtn').onclick = savePreferenceSettings;
    $('loadPreferenceBtn').onclick = loadPreferenceSettings;

    // è©³ç´°è¨­å®š
    $('copyCsvBtn').onclick = () => copyToClipboard(assignmentsOut.value);
    $('saveCsvBtn').onclick = () => downloadText(assignmentsOut.value, makeTsPrefix() + '_assignments.csv', 'text/csv');
    $('saveLogBtn').onclick = () => downloadText(JSON.stringify(lastLog, null, 2), makeTsPrefix() + '_run_log.json', 'application/json');
    $('saveStudentExcelBtn').onclick = () => saveAsExcel('student');
    $('copyReportBtn').onclick = () => copyToClipboard(reportOut.value);
    $('saveReportBtn').onclick = () => downloadText(reportOut.value, makeTsPrefix() + '_report.csv', 'text/csv');

    function toggleAdvanced(){
      const content = $('advancedContent');
      if(content.style.display === 'none'){
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        toast('CSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'ok');
      }).catch(() => toast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'err'));
    }

    function downloadText(content, filename, mime) {
      const blob = new Blob([content], { type: mime || 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function toast(msg, cls) { status.textContent = msg; status.className = 'small ' + (cls || ''); }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function makeTsPrefix(){ const d=new Date(); return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`; }

    // ---- Core ----
    let lastLog = { startedAt: null, warnings: [], decisions: [] };
    let lastAssignments = []; // å‰²å½“çµæœã‚’ä¿å­˜
    let boothData = []; // ãƒ–ãƒ¼ã‚¹è¡¨ã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿
    let teacherData = []; // å…ƒã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿
    let originalBoothWorkbook = null; // å…ƒã®ãƒ–ãƒ¼ã‚¹è¡¨Excelãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯
    let boothSheetInfo = {}; // ãƒ–ãƒ¼ã‚¹è¡¨ã®ã‚·ãƒ¼ãƒˆæƒ…å ±ï¼ˆè¡Œãƒ»åˆ—ã®ä½ç½®ï¼‰
    let teacherPreferences = {}; // è¬›å¸«ã®å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š { teacherId: 'B1' }

    function key(dt){ return dt.date + ' ' + dt.time; }
    function sameTime(a,b){ return a.date===b.date && a.time===b.time; }

    function groupBy(arr, f){
      const m = new Map();
      for(const x of arr){
        const k = f(x);
        const g = m.get(k); if(g) g.push(x); else m.set(k, [x]);
      }
      return m;
    }

    function run(){
      lastLog = { startedAt: new Date().toISOString(), warnings: [], decisions: [] };
      lastAssignments = [];
      assignmentsOut.value = '';
      reportOut.value = '';
      try{
        if(boothData.length === 0){
          throw new Error('ãƒ–ãƒ¼ã‚¹è¡¨ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        }
        if(teacherData.length === 0){
          throw new Error('å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«è¡¨ï¼‰ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
        }

        console.log('=== å‰²ã‚Šå½“ã¦é–‹å§‹ ===');
        console.log('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š:', teacherPreferences);

        const slots = boothData;
        const teachers = teacherData;
        const demands = []; // ç”Ÿå¾’éœ€è¦ã¯ç°¡ç•¥ç‰ˆã§ã¯ä½¿ç”¨ã—ãªã„

        // index by time
        const slotsByTime = groupBy(slots, s => key(s));
        const teachersByTime = groupBy(teachers, t => key(t));
        const demandByTime = groupBy(demands, d => key(d));

        // track usage
        const usedTeacherAt = new Set(); // key(time + teacherId)
        const teacherDailyCount = new Map(); // key(date + teacherId) -> count
        const teacherDailyBooth = new Map(); // key(date + teacherId) -> boothId (1æ—¥å†…ã§ãƒ–ãƒ¼ã‚¹å›ºå®š)

        const lines = [ 'date,time,boothId,teacherId,teacherName,studentId,subject' ];

        // Iterate over time slots in chronological order
        const times = Array.from(new Set([...slots.map(key)])).sort();
        for(const tkey of times){
          const sList = slotsByTime.get(tkey) || [];
          const thList = (teachersByTime.get(tkey) || []).slice();
          const ddList = (demandByTime.get(tkey) || []).slice();

          // Sort teachers by simple availability score (fewer assigned today first)
          thList.sort((a,b) => (teacherDailyCount.get(a.date+' '+a.teacherId)||0) - (teacherDailyCount.get(b.date+' '+b.teacherId)||0));

          // Sort demands by priority desc
          ddList.sort((a,b) => (b.priority||0) - (a.priority||0));

          // Build NG map for quick check
          const ngTeachersMap = new Map();
          for(const d of ddList){
            const ng = new Set(d.ngTeachers || []);
            ngTeachersMap.set(d.studentId, ng);
          }

          // Try to satisfy demands first per booth
          for(const slot of sList){
            let assignedTeacher = null;
            let assignedDemand = null;

            // find demand preferring preferredTeacher first
            let candidates = ddList;
            for(const demand of candidates){
              // skip if NG teacher list prohibits preferred teacher and we will try others
              const preferred = demand.preferredTeacherId || null;
              const ngSet = ngTeachersMap.get(demand.studentId) || new Set();

              // Attempt preferred first
              if (preferred && !ngSet.has(preferred)){
                const th = thList.find(x => x.teacherId === preferred && !usedTeacherAt.has(tkey+' '+x.teacherId));
                if (th){ assignedTeacher = th; assignedDemand = demand; }
              }

              if (!assignedTeacher){
                // pick any available teacher not in NG
                const th2 = thList.find(x => !usedTeacherAt.has(tkey+' '+x.teacherId) && !ngSet.has(x.teacherId));
                if (th2){ assignedTeacher = th2; assignedDemand = demand; }
              }

              if (assignedTeacher) break;
            }

            // If no demand or none matched, assign teacher-only if available
            if (!assignedTeacher){
              // å„ªå…ˆåº¦1: ãã®æ—¥æ—¢ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãƒ–ãƒ¼ã‚¹ãŒã‚ã‚Œã°ã€ãã®ãƒ–ãƒ¼ã‚¹ã‚’ä½¿ã†
              const existingBoothTeacher = thList.find(x => {
                const dailyKey = slot.date + ' ' + x.teacherId;
                const assignedBooth = teacherDailyBooth.get(dailyKey);
                return !usedTeacherAt.has(tkey+' '+x.teacherId) &&
                       assignedBooth === slot.boothId;
              });

              if (existingBoothTeacher) {
                assignedTeacher = existingBoothTeacher;
                console.log(`âœ“ 1æ—¥å†…ãƒ–ãƒ¼ã‚¹å›ºå®š: ${existingBoothTeacher.teacherName} -> ${slot.boothId} (${slot.date} ${slot.time})`);
              }

              // å„ªå…ˆåº¦2: å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒã‚ã‚‹è¬›å¸«
              if (!assignedTeacher) {
                // ãƒ‡ãƒãƒƒã‚°: ã“ã®æ™‚é–“å¸¯ã®è¬›å¸«ä¸€è¦§ã¨å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’è¡¨ç¤º
                console.log(`ğŸ” æ™‚é–“å¸¯ ${tkey}, ãƒ–ãƒ¼ã‚¹ ${slot.boothId} ã®å‰²ã‚Šå½“ã¦å€™è£œ:`);
                thList.forEach(x => {
                  const prefBooth = teacherPreferences[x.teacherId];
                  const isAvailable = !usedTeacherAt.has(tkey+' '+x.teacherId);
                  console.log(`  - ${x.teacherName} (ID: ${x.teacherId}): å„ªå…ˆãƒ–ãƒ¼ã‚¹=${prefBooth || 'ãªã—'}, ç©ºã=${isAvailable}`);
                });

                assignedTeacher = thList.find(x => {
                  const prefBooth = teacherPreferences[x.teacherId];
                  const isAvailable = !usedTeacherAt.has(tkey+' '+x.teacherId);
                  const matchesPref = prefBooth === slot.boothId;

                  if (matchesPref && isAvailable) {
                    console.log(`âœ“ å„ªå…ˆãƒ–ãƒ¼ã‚¹é©ç”¨: ${x.teacherName} -> ${slot.boothId} (è¨­å®š: ${prefBooth})`);
                  }

                  return isAvailable && matchesPref;
                });

                if (!assignedTeacher) {
                  console.log(`  â†’ å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã«ã‚ˆã‚‹å‰²ã‚Šå½“ã¦ãªã—`);
                }
              }

              // å„ªå…ˆåº¦3: ã¾ã ãã®æ—¥ã«ãƒ–ãƒ¼ã‚¹ãŒæ±ºã¾ã£ã¦ã„ãªã„è¬›å¸«ã§ã€å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
              if (!assignedTeacher) {
                assignedTeacher = thList.find(x => {
                  const dailyKey = slot.date + ' ' + x.teacherId;
                  const hasNoBooth = !teacherDailyBooth.has(dailyKey);
                  const prefBooth = teacherPreferences[x.teacherId];
                  const isAvailable = !usedTeacherAt.has(tkey+' '+x.teacherId);

                  // å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
                  if (hasNoBooth && isAvailable && prefBooth) {
                    return prefBooth === slot.boothId;
                  }

                  return false;
                });
              }

              // å„ªå…ˆåº¦4: ç©ºã„ã¦ã„ã‚‹è¬›å¸«ï¼ˆé€šå¸¸å‰²ã‚Šå½“ã¦ï¼‰
              if (!assignedTeacher) {
                assignedTeacher = thList.find(x => !usedTeacherAt.has(tkey+' '+x.teacherId));
              }
            }

            if (assignedTeacher){
              usedTeacherAt.add(tkey+' '+assignedTeacher.teacherId);
              const dailyKey = assignedTeacher.date + ' ' + assignedTeacher.teacherId;
              teacherDailyCount.set(dailyKey, (teacherDailyCount.get(dailyKey)||0) + 1);

              // 1æ—¥å†…ã®ãƒ–ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦ã‚’è¨˜éŒ²
              if (!teacherDailyBooth.has(dailyKey)) {
                teacherDailyBooth.set(dailyKey, slot.boothId);
                console.log(`ğŸ“Œ åˆå›ãƒ–ãƒ¼ã‚¹æ±ºå®š: ${assignedTeacher.teacherName} -> ${slot.boothId} (${assignedTeacher.date})`);
              }

              if (assignedDemand){
                // remove selected demand from pool
                const i = ddList.indexOf(assignedDemand);
                if (i >= 0) ddList.splice(i,1);
              }

              const assignmentRecord = {
                date: slot.date,
                time: slot.time,
                boothId: slot.boothId,
                teacherId: assignedTeacher.teacherId,
                teacherName: assignedTeacher.teacherName||'',
                studentId: assignedDemand?.studentId||'',
                subject: assignedDemand?.subject||''
              };
              lastAssignments.push(assignmentRecord);
              lines.push([slot.date, slot.time, slot.boothId, assignedTeacher.teacherId, (assignedTeacher.teacherName||''), (assignedDemand?.studentId||''), (assignedDemand?.subject||'')].join(','));
              lastLog.decisions.push({ tkey, boothId: slot.boothId, teacherId: assignedTeacher.teacherId, studentId: assignedDemand?.studentId || null });
            } else {
              // No teacher available
              const assignmentRecord = {
                date: slot.date,
                time: slot.time,
                boothId: slot.boothId,
                teacherId: '',
                teacherName: '',
                studentId: ddList[0]?.studentId||'',
                subject: ddList[0]?.subject||''
              };
              lastAssignments.push(assignmentRecord);
              lines.push([slot.date, slot.time, slot.boothId, '', '', (ddList[0]?.studentId||''), (ddList[0]?.subject||'')].join(','));
              lastLog.warnings.push({ tkey, boothId: slot.boothId, reason: 'è¬›å¸«ä¸è¶³' });
            }
          }
        }

        console.log('=== å‰²ã‚Šå½“ã¦å®Œäº† ===');
        console.log('1æ—¥å†…ãƒ–ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦:', teacherDailyBooth);

        assignmentsOut.value = lines.join('\n');

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        generateReport(slots, lastAssignments, demands);

        // è©³ç´°è¨­å®šã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        $('advancedCard').style.display = 'block';

        toast('å‰²å½“ãŒå®Œäº†ã—ã¾ã—ãŸ: ' + (lines.length-1) + 'ä»¶', 'ok');
      }catch(e){
        console.error(e);
        toast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'err');
      }
    }

    function generateReport(slots, assignments, demands){
      const reportLines = ['type,date,time,boothId,teacherId,teacherName,studentId,subject,reason'];

      // æœªå‰²å½“ã®è¬›å¸«ã‚’ãƒã‚§ãƒƒã‚¯
      const assignedSlots = new Set(assignments.filter(a=>a.teacherId).map(a=>`${a.date}_${a.time}_${a.boothId}`));
      for(const slot of slots){
        const sk = `${slot.date}_${slot.time}_${slot.boothId}`;
        if(!assignedSlots.has(sk)){
          const a = assignments.find(x=>x.date===slot.date && x.time===slot.time && x.boothId===slot.boothId);
          reportLines.push(['æœªå‰²å½“è¬›å¸«',slot.date,slot.time,slot.boothId,'','',a?.studentId||'',a?.subject||'','è¬›å¸«ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“'].join(','));
        }
      }

      // æœªå‰²å½“ã®ç”Ÿå¾’éœ€è¦ã‚’ãƒã‚§ãƒƒã‚¯
      const assignedDemands = new Set(assignments.filter(a=>a.studentId).map(a=>`${a.date}_${a.time}_${a.studentId}`));
      for(const demand of demands){
        const dk = `${demand.date}_${demand.time}_${demand.studentId}`;
        if(!assignedDemands.has(dk)){
          reportLines.push(['æœªå‰²å½“ç”Ÿå¾’',demand.date,demand.time,'','','',demand.studentId,demand.subject||'','ç”Ÿå¾’ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“'].join(','));
        }
      }

      // è­¦å‘Šãƒ­ã‚°ã‚’ãƒ¬ãƒãƒ¼ãƒˆã«è¿½åŠ 
      for(const warn of lastLog.warnings){
        const parts = warn.tkey.split(' ');
        reportLines.push(['è­¦å‘Š',parts[0],parts[1],warn.boothId,'','','','',warn.reason].join(','));
      }

      reportOut.value = reportLines.join('\n');
    }

    function togglePreview(){
      const container = $('previewContainer');
      if(container.style.display === 'none'){
        container.style.display = 'block';
        renderPreview();
      } else {
        container.style.display = 'none';
      }
    }

    function renderPreview(){
      if(lastAssignments.length === 0){
        $('previewTable').innerHTML = '<tr><td>å‰²å½“çµæœãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      const dates = [...new Set(lastAssignments.map(a=>a.date))].sort();
      const booths = [...new Set(lastAssignments.map(a=>a.boothId))].sort((a,b)=>{
        const na = parseInt(a.replace(/\D/g,'')) || 0;
        const nb = parseInt(b.replace(/\D/g,'')) || 0;
        return na - nb;
      });
      const times = [...new Set(lastAssignments.map(a=>a.time))].sort();

      // ãƒ–ãƒ¼ã‚¹è¡¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æƒãˆã‚‹: æ—¥ä»˜è¡Œã€æ›œæ—¥è¡Œã€æ™‚é–“åˆ—ã€ãƒ–ãƒ¼ã‚¹ç•ªå·ï¼‹è¬›å¸«åã®2åˆ—æ§‹é€ 
      let html = '<thead>';

      // è¡Œ0: æ—¥ä»˜ï¼ˆå„æ—¥2åˆ—Ã—ãƒ–ãƒ¼ã‚¹æ•°åˆ†ã‚’çµåˆï¼‰
      html += '<tr><th style="border:1px solid #d1d5db; background:#f3f4f6;"></th>'; // å·¦ä¸Šç©ºç™½
      for(const date of dates){
        const day = new Date(date).getDate();
        html += `<th colspan="${booths.length * 2}" style="border:1px solid #d1d5db; background:#f3f4f6; text-align:center;">${day}</th>`;
      }
      html += '</tr>';

      // è¡Œ1: æ›œæ—¥ï¼ˆå„æ—¥2åˆ—Ã—ãƒ–ãƒ¼ã‚¹æ•°åˆ†ã‚’çµåˆï¼‰
      html += '<tr><th style="border:1px solid #d1d5db; background:#f3f4f6;"></th>';
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      for(const date of dates){
        const d = new Date(date);
        const weekday = weekdays[d.getDay()];
        html += `<th colspan="${booths.length * 2}" style="border:1px solid #d1d5db; background:#f3f4f6; text-align:center;">${weekday}</th>`;
      }
      html += '</tr>';
      html += '</thead><tbody>';

      // æ™‚é–“è¡Œ
      for(const time of times){
        html += `<tr><td style="font-weight:600; border:1px solid #d1d5db; padding:6px 8px; background:#f9fafb;">${time}</td>`;
        for(const date of dates){
          for(const booth of booths){
            const a = lastAssignments.find(x=>x.date===date && x.time===time && x.boothId===booth);
            const cls = (a && a.teacherId) ? 'assigned' : 'empty';

            // ãƒ–ãƒ¼ã‚¹ç•ªå·ã‚»ãƒ«ï¼ˆä¸¸æ•°å­—ã«å¤‰æ›ï¼‰
            const boothNum = booth.replace('B','');
            const circledNum = String.fromCodePoint(0x245F + parseInt(boothNum)); // â‘ â‘¡â‘¢...
            html += `<td style="border:1px solid #d1d5db; padding:4px; text-align:center; font-weight:600; width:40px; background:#f9fafb;">${circledNum}</td>`;

            // è¬›å¸«åã‚»ãƒ«
            let text = '';
            if(a){
              text = a.teacherName || a.teacherId || '';
              if(a.studentId) text += '<br/><small>' + a.studentId + '</small>';
              if(a.subject) text += '<br/><small>(' + a.subject + ')</small>';
            }
            html += `<td class="${cls}" style="border:1px solid #d1d5db; padding:4px; min-width:80px;">${text}</td>`;
          }
        }
        html += '</tr>';
      }
      html += '</tbody>';

      $('previewTable').innerHTML = html;
    }

    // ================= Excel import: ãƒ–ãƒ¼ã‚¹è¡¨ =================
    const jpWeek = new Set(["æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ","æ—¥","ç¥"]);
    const circledRegex = /[\u2460-\u2473]/; // â‘ ..â‘³
    const ymFromSheetName = /(\d{4})\.(\d{1,2})\./; // "... 2025.11.02-08"
    function detectYearMonthFromSheetName(name){
      const m = name.match(ymFromSheetName);
      return m ? { year: m[1], month: pad2(m[2]) } : null;
    }
    function detectYearMonthFromCells(rows){
      // æ¢ç´¢: "2025/11" or "2025.11" or "2025å¹´11æœˆ"
      const re = /(\d{4})[/.å¹´](\d{1,2})/;
      for (let r=0;r<Math.min(rows.length, 10); r++){
        const row = rows[r] || [];
        for (let c=0;c<row.length;c++){
          const v=row[c];
          if (typeof v === 'string'){
            const m = v.match(re); if (m) return { year: m[1], month: pad2(m[2]) };
          }
        }
      }
      return null;
    }
    function getOverrideYM(){
      return null; // å¹´æœˆã®æ‰‹å‹•æŒ‡å®šã¯å»ƒæ­¢
    }
    function normalizeTime(v){
      if (v == null) return null;
      if (typeof v === 'string'){
        const m = v.match(/^\s*(\d{1,2}):(\d{2})(?::(\d{2}))?\s*$/);
        if (!m) return null;
        return `${pad2(m[1])}:${pad2(m[2])}:${pad2(m[3] ?? '00')}`;
      }
      if (typeof v === 'number'){
        if (v < 0 || v > 1) return null;
        const total = Math.round(v * 24 * 3600);
        const hh = pad2(Math.floor(total / 3600) % 24);
        const mm = pad2(Math.floor((total % 3600) / 60));
        const ss = pad2(total % 60);
        return `${hh}:${mm}:${ss}`;
      }
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)){
        return `${pad2(v.getHours())}:${pad2(v.getMinutes())}:${pad2(v.getSeconds())}`;
      }
      return null;
    }
    function buildEffectiveTimes(rows, timeColIdx){
      const eff = new Array(rows.length).fill(null);
      let last = null;
      for (let r=0;r<rows.length;r++){
        const norm = normalizeTime(rows[r]?.[timeColIdx]);
        if (norm) last = norm;
        eff[r] = last;
      }
      return eff;
    }
    function collectDayColumns(rows, timeColIdx){
      const header0 = rows[0] || [];
      const header1 = rows[1] || [];
      const result = [];
      for (let c=0;c<header0.length;c++){
        if (c === timeColIdx) continue;
        const v0 = header0[c];
        const v1 = header1[c];
        const dayOk = (v0 != null) && /^\d{1,2}$/.test(String(v0).trim());
        const weekdayOk = (v1 != null) && jpWeek.has(String(v1).trim());
        if (dayOk && weekdayOk) result.push({ col: c, day: parseInt(String(v0).trim(), 10) });
      }
      return result;
    }
    function circledToBoothId(ch){
      // â‘ (U+2460)=1 ... â‘³(U+2473)=20
      const code = ch.codePointAt(0);
      const base = 0x2460; // 1
      const n = (code - base) + 1;
      if (n >= 1 && n <= 20) return 'B' + n;
      return 'B?';
    }
    async function parseBoothExcel(input){
      const file = input.files?.[0];
      if (!file){ $('boothExcelStatus').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'; return; }
      try{
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { cellText:false, cellDates:true });
        const sheetName = wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true });
        let ym = getOverrideYM() || detectYearMonthFromSheetName(sheetName) || detectYearMonthFromCells(rows);
        if (!ym) throw new Error('å¹´/æœˆã®è‡ªå‹•æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        const timeColIdx = 1; // Båˆ—
        const effTimes = buildEffectiveTimes(rows, timeColIdx);
        const dayCols = collectDayColumns(rows, timeColIdx);
        if (!dayCols.length) throw new Error('æ—¥ä»˜/æ›œæ—¥ãƒ˜ãƒƒãƒ€è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (è¡Œ0=æ—¥, è¡Œ1=æ›œæ—¥)');

        // ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã¨ã‚»ãƒ«ä½ç½®ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
        const slots = [];
        const cellPositions = {}; // key: "date_time_boothId" -> {row, col, teacherCol}

        for (let r=0;r<rows.length;r++){
          const t = effTimes[r];
          if (!t) continue;
          for (const {col, day} of dayCols){
            const v = rows[r]?.[col];
            if (v == null) continue;
            const m = String(v).match(circledRegex);
            if (!m) continue;
            const boothId = circledToBoothId(m[0]);
            const date = `${ym.year}/${ym.month}/${pad2(day)}`;
            slots.push({ date, time: t, boothId });
            // ãƒ–ãƒ¼ã‚¹ç•ªå·ã‚»ãƒ« (col) ã®å³éš£ (col+1) ãŒè¬›å¸«åè¨˜å…¥æ¬„
            cellPositions[`${date}_${t}_${boothId}`] = { row: r, col, teacherCol: col + 1 };
          }
        }

        slots.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));

        // å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã¨ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’ä¿å­˜
        originalBoothWorkbook = wb;
        boothSheetInfo = {
          sheetName,
          cellPositions,
          yearMonth: ym
        };

        boothData = slots;
        $('boothExcelStatus').innerHTML = `<span class="ok">âœ“ èª­ã¿è¾¼ã¿å®Œäº†:</span> ${slots.length}ä»¶`;
      }catch(e){
        console.error(e); $('boothExcelStatus').innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`;
      }
    }

    // ================= Excel import: å…ƒã‚·ãƒ¼ãƒˆï¼ˆè¬›å¸«è¡¨ï¼‰ =================
    function isDateCell(v){
      if (v == null) return false;
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) return true;
      if (typeof v === 'string'){
        const s = v.trim();
        // å—ã‘å…¥ã‚Œ: YYYY/MM/DD, YYYY-MM-DD, MM/DD, M/D, MM-DD
        if (/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}(?:\s+\d{2}:\d{2}:\d{2})?$/.test(s)) return true;
        if (/^\d{1,2}[\/-]\d{1,2}(?:\([^\)]*\))?$/.test(s)) return true; // 11/03 ã‚„ 11/03(æœˆ)
      }
      return false;
    }
    function normalizeDateToYmd(v, ymFallback){
      let d=null;
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) {
        d=v; return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
      }
      if (typeof v === 'string'){
        const s=v.trim();
        if (/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}/.test(s)){
          d=new Date(s.replace(/-/g,'/'));
          if (!isNaN(d)) return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
        }
        const m=s.match(/^(\d{1,2})[\/-](\d{1,2})/);
        if (m && ymFallback){
          return `${ymFallback.year}/${ymFallback.month}/${pad2(m[2])}`;
        }
      }
      return null;
    }
    function findHeaderRowByDates(rows){
      // æœ€åˆã®10è¡Œã§ã€æ—¥ä»˜ã‚‰ã—ãã‚»ãƒ«ãŒ3ã¤ä»¥ä¸Šã‚ã‚‹è¡Œã‚’ãƒ˜ãƒƒãƒ€ã¨ã¿ãªã™
      let bestIdx = 0, bestCount = -1;
      for (let r=0;r<Math.min(rows.length, 10); r++){
        const row = rows[r] || [];
        let cnt=0;
        for (let c=0;c<row.length;c++) if (isDateCell(row[c])) cnt++;
        if (cnt > bestCount){ bestCount = cnt; bestIdx = r; }
      }
      return bestIdx;
    }
    function collectDateTeacherColumns(rows, ymFallback){
      const headerRowIdx = findHeaderRowByDates(rows);
      const header = rows[headerRowIdx] || [];
      const pairs = [];
      for (let c=0;c<header.length;c++){
        const v = header[c];
        if (!isDateCell(v)) continue;
        const ymd = normalizeDateToYmd(v, ymFallback);
        if (!ymd) continue;
        const teacherCol = c + 1; // å³éš£ã‚’è¬›å¸«åˆ—
        pairs.push({ dateCol:c, teacherCol, ymd });
      }
      return pairs;
    }
    function cleanTeacherName(s){
      if (s == null) return null;
      const t = String(s).replace(/\u3000/g, ' ').trim().replace(/\s+/g,' ');
      return t.length ? t : null;
    }
    function idFromName(name){
      // simple stable hash -> Txxxxxx
      let h=5381; for (let i=0;i<name.length;i++){ h=((h<<5)+h)+name.charCodeAt(i); h|=0; }
      const hex = (h>>>0).toString(16).slice(-6).padStart(6,'0');
      return 'T' + hex.toUpperCase();
    }

    function formatTeacherNameForExcel(fullName){
      // ãƒ•ãƒ«ãƒãƒ¼ãƒ ã‚’ã€Œè‹—å­—+Tã€å½¢å¼ã«å¤‰æ›
      // ä¾‹: "è¥¿ã€€æ³°æˆ‘" -> "è¥¿T"
      // å…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
      const parts = fullName.replace(/\u3000/g, ' ').split(/\s+/);
      if (parts.length > 0 && parts[0]) {
        return parts[0] + 'T';
      }
      return fullName + 'T'; // ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã¯ãã®ã¾ã¾+T
    }
    // ================= Excel export: ãƒ–ãƒ¼ã‚¹è¡¨å½¢å¼ =================
    function saveAsExcel(mode){
      try{
        if(lastAssignments.length === 0){
          excelStatus.innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼:</span> å‰²å½“ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„';
          return;
        }

        if(!originalBoothWorkbook){
          excelStatus.innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼:</span> å…ƒã®ãƒ–ãƒ¼ã‚¹è¡¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          return;
        }

        // å…ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯å…¨ä½“ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
        const wb = {
          SheetNames: [...originalBoothWorkbook.SheetNames],
          Sheets: {}
        };

        // ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        for(const sheetName of wb.SheetNames){
          const originalSheet = originalBoothWorkbook.Sheets[sheetName];
          const newSheet = {};

          // ã‚·ãƒ¼ãƒˆã®å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ!refã‚„!mergesãªã©ã‚‚å«ã‚€ï¼‰
          for(const key in originalSheet){
            if(originalSheet.hasOwnProperty(key)){
              if(typeof originalSheet[key] === 'object' && originalSheet[key] !== null){
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
                newSheet[key] = JSON.parse(JSON.stringify(originalSheet[key]));
              } else {
                newSheet[key] = originalSheet[key];
              }
            }
          }

          wb.Sheets[sheetName] = newSheet;
        }

        // å¯¾è±¡ã‚·ãƒ¼ãƒˆã«å‰²å½“çµæœã‚’ä¸Šæ›¸ã
        const targetSheetName = boothSheetInfo.sheetName;
        const targetSheet = wb.Sheets[targetSheetName];

        // å‰²å½“çµæœã§ä¸Šæ›¸ã
        for(const assignment of lastAssignments){
          if(!assignment.teacherId) continue; // è¬›å¸«ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

          const key = `${assignment.date}_${assignment.time}_${assignment.boothId}`;
          const pos = boothSheetInfo.cellPositions[key];

          if(!pos) continue;

          // è¬›å¸«åã¯ãƒ–ãƒ¼ã‚¹ç•ªå·ã‚»ãƒ«ã®å³éš£ï¼ˆteacherColï¼‰ã«æ›¸ãè¾¼ã‚€
          const cellAddr = XLSX.utils.encode_cell({r: pos.row, c: pos.teacherCol});

          let cellValue = '';
          if(mode === 'teacher'){
            // è¬›å¸«é…ç½®ã®ã¿ï¼ˆè‹—å­—+Tå½¢å¼ï¼‰
            cellValue = formatTeacherNameForExcel(assignment.teacherName || assignment.teacherId);
          } else if(mode === 'student'){
            // è¬›å¸« + ç”Ÿå¾’
            const teacher = formatTeacherNameForExcel(assignment.teacherName || assignment.teacherId);
            const student = assignment.studentId ? `\n${assignment.studentId}` : '';
            const subject = assignment.subject ? `(${assignment.subject})` : '';
            cellValue = teacher + student + subject;
          }

          // å…ƒã®ã‚»ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«æƒ…å ±ã‚’ä¿æŒã—ã¤ã¤å€¤ã‚’æ›´æ–°
          const originalCell = targetSheet[cellAddr];
          if(originalCell){
            targetSheet[cellAddr] = { ...originalCell, v: cellValue, t: 's' };
          } else {
            targetSheet[cellAddr] = { t: 's', v: cellValue };
          }
        }

        const filename = mode === 'teacher'
          ? makeTsPrefix() + '_è¬›å¸«é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsx'
          : makeTsPrefix() + '_ç”Ÿå¾’é…ç½®æ¸ˆã¿ãƒ–ãƒ¼ã‚¹è¡¨.xlsx';

        XLSX.writeFile(wb, filename);
        excelStatus.innerHTML = `<span class="ok">âœ“</span> ${filename} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`;
      }catch(e){
        console.error(e);
        excelStatus.innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`;
      }
    }

    async function parseTeacherExcel(input){
      const file = input.files?.[0];
      if (!file){ $('teacherExcelStatus').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'; return; }
      try{
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { cellText:false, cellDates:true });
        const sheetName = wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header:1, raw:true });
        const ym = getOverrideYM() || detectYearMonthFromSheetName(sheetName) || detectYearMonthFromCells(rows);
        const pairs = collectDateTeacherColumns(rows, ym);
        if (!pairs.length) throw new Error('æ—¥ä»˜åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä¸Šã® å¹´/æœˆ ã‚’æŒ‡å®šã®ä¸Šã€ãƒ˜ãƒƒãƒ€è¡Œã« 11/03 ç­‰ãŒã‚ã‚‹ã“ã¨ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
        const times = buildEffectiveTimes(rows, 0); // Aåˆ—ã®æ™‚åˆ»ã‚’ä¸‹æ–¹å‘ã«ç¶™æ‰¿

        const shifts = [];
        const seen = new Set();
        for (let r=0;r<rows.length;r++){
          const time = times[r]; if (!time) continue;
          for (const {ymd, teacherCol} of pairs){
            const name = cleanTeacherName(rows[r]?.[teacherCol]);
            if (!name) continue;
            const tid = idFromName(name);
            const key = `${ymd}_${time}_${tid}`;
            if (seen.has(key)) continue; seen.add(key);
            shifts.push({ date: ymd, time, teacherId: tid, teacherName: name, constraints: {} });
          }
        }
        shifts.sort((a,b)=> (a.date+a.time+a.teacherId).localeCompare(b.date+b.time+b.teacherId));
        teacherData = shifts;
        $('teacherExcelStatus').innerHTML = `<span class="ok">âœ“ èª­ã¿è¾¼ã¿å®Œäº†:</span> ${shifts.length}ä»¶`;
      }catch(e){ console.error(e); $('teacherExcelStatus').innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼:</span> ${e.message}`; }
    }

    // ================= å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š =================
    function showPreferenceSettings(){
      console.log('showPreferenceSettings called');
      console.log('teacherData.length:', teacherData.length);
      console.log('boothData.length:', boothData.length);

      if(teacherData.length === 0 || boothData.length === 0){
        toast('å…ˆã«ãƒ–ãƒ¼ã‚¹è¡¨ã¨å…ƒã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'warn');
        return;
      }

      const container = $('preferenceContainer');
      const tbody = $('preferenceTableBody');

      // è¬›å¸«ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡æ’é™¤ï¼‰
      const teachers = {};
      for(const t of teacherData){
        teachers[t.teacherId] = t.teacherName;
      }

      console.log('è¬›å¸«æ•°:', Object.keys(teachers).length);

      // ãƒ–ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆé‡è¤‡æ’é™¤ï¼‰
      const booths = [...new Set(boothData.map(b => b.boothId))].sort((a,b) => {
        const na = parseInt(a.replace(/\D/g,'')) || 0;
        const nb = parseInt(b.replace(/\D/g,'')) || 0;
        return na - nb;
      });

      console.log('ãƒ–ãƒ¼ã‚¹æ•°:', booths.length);
      console.log('ãƒ–ãƒ¼ã‚¹ãƒªã‚¹ãƒˆ:', booths);

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰
      tbody.innerHTML = '';
      for(const [teacherId, teacherName] of Object.entries(teachers)){
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #f3f4f6';

        const tdName = document.createElement('td');
        tdName.style.padding = '4px 8px';
        tdName.textContent = teacherName;

        const tdBooth = document.createElement('td');
        tdBooth.style.padding = '4px 8px';

        const select = document.createElement('select');
        select.style.padding = '4px';
        select.style.border = '1px solid #e5e7eb';
        select.style.borderRadius = '4px';
        select.dataset.teacherId = teacherId;

        // ã€ŒæŒ‡å®šãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const optNone = document.createElement('option');
        optNone.value = '';
        optNone.textContent = 'æŒ‡å®šãªã—';
        select.appendChild(optNone);

        // ãƒ–ãƒ¼ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¸¸ä»˜ãæ•°å­—ã§è¡¨ç¤ºï¼‰
        for(const boothId of booths){
          const opt = document.createElement('option');
          opt.value = boothId;
          // B1â†’â‘ , B2â†’â‘¡ã®ã‚ˆã†ã«ä¸¸ä»˜ãæ•°å­—ã«å¤‰æ›
          const boothNum = parseInt(boothId.replace(/\D/g,'')) || 0;
          const circledNum = String.fromCodePoint(0x245F + boothNum);
          opt.textContent = circledNum;
          select.appendChild(opt);
        }

        // æ—¢å­˜ã®è¨­å®šã‚’åæ˜ 
        if(teacherPreferences[teacherId]){
          select.value = teacherPreferences[teacherId];
        }

        // å¤‰æ›´æ™‚ã«teacherPreferencesã‚’æ›´æ–°
        select.onchange = (e) => {
          const tid = e.target.dataset.teacherId;
          if(e.target.value){
            teacherPreferences[tid] = e.target.value;
            console.log('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®š:', tid, '->', e.target.value);
          } else {
            delete teacherPreferences[tid];
            console.log('å„ªå…ˆãƒ–ãƒ¼ã‚¹è§£é™¤:', tid);
          }
        };

        tdBooth.appendChild(select);
        tr.appendChild(tdName);
        tr.appendChild(tdBooth);
        tbody.appendChild(tr);
      }

      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹ç¯‰å®Œäº†');

      // ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
      if(container.style.display === 'none'){
        container.style.display = 'block';
        toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆ' + Object.keys(teachers).length + 'äººï¼‰', 'ok');
      } else {
        container.style.display = 'none';
        toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ', 'ok');
      }
    }

    function savePreferenceSettings(){
      try{
        localStorage.setItem('teacherPreferences', JSON.stringify(teacherPreferences));
        toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'ok');
      }catch(e){
        console.error(e);
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'err');
      }
    }

    function loadPreferenceSettings(){
      try{
        const saved = localStorage.getItem('teacherPreferences');
        if(saved){
          teacherPreferences = JSON.parse(saved);
          toast('å„ªå…ˆãƒ–ãƒ¼ã‚¹è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'ok');
          // UIãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
          if($('preferenceContainer').style.display !== 'none'){
            showPreferenceSettings(); // å†è¡¨ç¤º
            showPreferenceSettings(); // ãƒˆã‚°ãƒ«ã§é–‹ã„ãŸã¾ã¾ã«ã™ã‚‹
          }
        } else {
          toast('ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warn');
        }
      }catch(e){
        console.error(e);
        toast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'err');
      }
    }
  })();
  </script>
</body>
</html>
