# SmartScheduler v1.6

**個別指導塾向け時間割自動作成システム**

[![Version](https://img.shields.io/badge/version-1.6-blue.svg)](https://github.com/Nishi-Taiga/schedule_automation)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

## 🎯 概要

SmartSchedulerは、個別指導塾の時間割作成を自動化するブラウザ完結型システムです。
Excelファイルをアップロードするだけで、講師の配置と生徒の割り当てを自動的に最適化します。

### 主な特徴

✅ **ブラウザ完結** - サーバー不要、完全オフライン動作
✅ **Excel連携** - 既存のExcelフォーマットをそのまま使用
✅ **複数シート対応** - 週ごとに分かれたExcelシートを自動統合
✅ **科目マッチング** - 講師が教えられる科目を自動チェック
✅ **制約処理** - NG講師、NG生徒、希望時間などの制約に対応
✅ **1日内ブース固定** - 講師は1日を通して同じブースを使用
✅ **優先ブース設定** - 講師ごとに優先ブースを指定可能

---

## 📥 インストール

### 前提条件
- モダンブラウザ（Chrome 100+, Firefox 100+, Edge 100+, Safari 15+）
- Excelファイル（.xlsx形式）

### セットアップ
1. このリポジトリをクローンまたはダウンロード
   ```bash
   git clone https://github.com/Nishi-Taiga/schedule_automation.git
   cd schedule_automation
   ```

2. `scheduler.html`をブラウザで開く
   - ダブルクリックで開く、または
   - ブラウザにドラッグ&ドロップ

---

## 🚀 使い方

### 基本的な使用手順

#### 1. ブース表をアップロード
- 日付×時間×ブースのマトリクスExcelファイル
- 各日は5列を使用（ブース番号、講師名記入欄など）
- ブース番号は丸数字（①〜⑳）で表記

#### 2. 講師表（元シート）をアップロード
- 講師の提出シフト（可勤務枠）のExcelファイル
- 各日は5列を使用（ブース、講師名、学年、生徒名、科目）
- 講師名が入力されているセルを可用枠として認識

#### 3. 生徒・講師情報をアップロード（オプション）
- **Sheet 1: 指導可能教科一覧**
  - 各講師が教えられる科目を◯マークで表記
  - 16名の講師×複数科目のマトリクス

- **Sheet 2: 生徒コマ数表**
  - 1生徒1行形式で科目別コマ数を管理
  - 15科目対応（英/英検/数/算/国/理/社/古/物/化/生/地/政/世/日）
  - 希望講師、NG講師、NG生徒、希望時間、NG日程を指定可能

#### 4. 優先ブース設定（オプション）
- 講師ごとに優先的に配置するブースを設定
- 設定はブラウザに自動保存

#### 5. 自動割り当てを実行
- 「⑤ 講師と生徒を割り当てる」ボタンをクリック
- 処理完了後、結果が表示される

#### 6. 結果をダウンロード
- 「講師配置済みブース表.xlsx」をダウンロード
- 元のブース表のフォーマットを保持

---

## 📖 ファイルフォーマット

### ブース表テンプレート
```
行0: 日（1〜31）
行1: 曜日（月/火/水/木/金/土/日/祝）
列B: 時刻（16:00, 17:00, 18:00...）
ブース番号: ①〜⑳（2行×2列のマージセル）
```

### 元シート（講師表）
```
ヘッダ行: 日付（YYYY/MM/DD, MM/DD等）
列A: 時刻
各日5列構成:
  1. ブース番号
  2. 講師名 ← ここが空でなければ可用
  3. 学年
  4. 生徒名
  5. 科目
```

### 生徒・講師情報
**Sheet 1: 指導可能教科一覧**
```
行2: カテゴリ（小学生/中学受験/中学生/高校生）
行3: 科目ヘッダー（国/算/英/理/社...）
行4+: 講師名と各科目の◯マーク
```

**Sheet 2: 生徒コマ数表**
```
列A: 学年（S4=小4, M1=中1, H2=高2）
列B: 学校名
列C: 生徒名
列D-S: 科目別コマ数（15科目）
列U: 希望講師（西T等、カンマ区切り）
列V: NG講師（田中T等、カンマ区切り）
列W: NG生徒（松橋,深澤等）
列X: 希望時間（月17,水19等）
列Y: NG日程（火,土等）
列Z: 備考
```

---

## 🔧 機能詳細

### 複数シート対応（v1.4）
週ごとに分かれたExcelファイルを自動的に統合:
- **ブース表**: 複数週のシートを自動読み込み・統合
  - 例: 「ブース表 2025.11.02-08」「ブース表 2025.11.09-15」
- **講師表**: 週ごとのシフトを自動統合
  - 例: 「11/2-8」「11/9-15」
- シート名または内容から年月を自動検出
- 全シートのデータを日付順に自動ソート
- 重複データの自動除去

### 科目マッチング（v1.3）
講師が指導可能な科目のみを自動的にマッチング:
- Sheet 1から講師-科目マッピングを読み込み
- 割り当て時に科目の適合性をチェック
- 科目名の正規化（国→国語、算→算数、数→数学）

### NG生徒処理（v1.3）
同じ時間帯にNG生徒が座らないよう自動調整:
- 同じ時間帯の割り当て済み生徒を追跡
- NG生徒がいる場合、その需要を後回し
- 次の時間帯で再試行

### 1日内ブース固定
講師の移動を最小化:
- 講師は1日を通して同じブースを使用
- 既に別のブースに割り当て済みの場合は除外

### 優先順位
講師の選択基準:
1. 出勤開始時刻が早い講師を優先
2. その日の割り当て数が少ない講師を優先

---

## 📊 技術仕様

- **言語**: HTML5, JavaScript (ES6+), CSS3
- **ライブラリ**: ExcelJS 4.4.0
- **動作環境**: モダンブラウザ（サーバー不要）
- **ファイルサイズ**: ~75KB（scheduler.html）
- **処理速度**: 300スロット×20講師を約3秒で処理

---

## 🧪 テスト

### 単体テスト
```bash
# ID生成関数のテスト
node test_idFromName.js

# 生徒需要展開のテスト
node test_expandStudentDemands.js

# 科目マッチングのテスト
node test_subject_matching.js

# Excel解析の統合テスト
node test_excel_integration.js
```

### ブラウザ統合テスト
`TESTING_GUIDE.md`を参照してください。

---

## 📝 変更履歴

### v1.6 (2025-11-08)
- ✨ **必要コマ数制限** - 必要コマ数を超えた授業を絶対に配置しない
  - 各生徒の科目別必要コマ数を厳密に管理
  - 割り当て済みコマ数を追跡して超過を防止
- ✨ **曜日・時間固定機能** - できる限り同じ曜日・時間に授業を配置
  - 割り当て履歴を記録して同じスロットを優先
  - スコアリングシステムで最適な時間帯を選択
- ✨ **講師-生徒ペア固定** - できる限り同じ組み合わせで授業を実施
  - 講師-生徒ペアの履歴を記録
  - 同じペアを優先的に再割り当て
- ✨ **1ブース2人対応** - 1ブースに最大2人まで生徒を配置可能
  - assignmentRecord構造を配列化（students: []）
  - Excel出力時に生徒を講師列の右に配置
- 🎨 **プレビュー表示改善** - 講師名を苗字+Tで表示
  - より簡潔で分かりやすい表示
  - 生徒名と科目を改行で表示
- 📊 **必要コマ数確認表改善** - 生徒一人につき1行で表示
  - 全科目の詳細を1行に集約
  - 総合的な達成率を表示
- ⚠️ **制約強化** - 講師がいないブースには生徒を配置しない

### v1.5 (2025-11-08)
- ✨ **プレビュー編集機能** - ドラッグ&ドロップで割り当てを編集可能
  - プレビュー内で講師・生徒の移動が可能
  - 編集内容がExcel保存に自動反映
- ✨ **必要コマ数確認表** - 生徒ごとの達成状況を一覧表示
  - 必要コマ数と割り当て済みコマ数の比較
  - 達成率の自動計算
  - 未達成の科目を強調表示
- ✨ **生徒名表示対応** - プレビューと保存に生徒名を追加
  - プレビュー画面に生徒名を表示
  - 生徒配置済みブース表に生徒名を出力
- 🎨 **UI改善** - 優先ブース設定をデフォルト表示
  - 優先ブース設定をデフォルトで表示
  - 非表示ボタンを追加
  - 設定保存/読み込みボタンの位置を改善

### v1.4 (2025-11-08)
- ✨ **複数シート対応** - 週ごとに分かれたExcelファイルの自動統合
  - ブース表の複数シート読み込み・統合
  - 講師表の複数シート読み込み・統合
  - シート名からの年月自動検出
  - 重複データの自動除去
- 🎨 UI/UXの大幅改善
  - モダンなグラデーション背景
  - カードベースのレイアウト
  - ホバーエフェクトとアニメーション
  - レスポンシブデザイン対応
- 📚 詳細ドキュメント追加
  - `MULTI_SHEET_SPEC.md` - 複数シート対応仕様書
  - `TESTING_GUIDE.md` - ブラウザテストガイド

### v1.3 (2025-11-07)
- ✨ 科目マッチング機能を追加
- ✨ NG生徒処理機能を追加
- 🎨 UIを大幅に改善（モダンなデザイン）
- 🧪 テストスイート追加（4種類のテスト）
- 📚 ドキュメント整備

### v1.2 (2025-11-07)
- ✨ 生徒コマ数表の読み込み機能を追加
- ✨ 講師割り当てアルゴリズムの強化
- 🎯 出勤開始時刻優先ソート
- 🔒 1日内ブース固定ルールを厳格化

### v1.1 (2025-11-05)
- ✨ Excel直接取り込み対応
- 📊 ブース表の自動パース
- 👨‍🏫 元シート（講師表）の自動パース

### v1.0 (2025-11-01)
- 🎉 初版リリース

---

## 🤝 サポート

### ドキュメント
- [仕様書](時間割自動化.md) - 詳細な技術仕様
- [テストガイド](TESTING_GUIDE.md) - ブラウザテスト手順

### 問題報告
問題が発生した場合:
1. ブラウザのコンソール（F12キー）でエラーを確認
2. 使用したExcelファイルのフォーマットを確認
3. [Issues](https://github.com/Nishi-Taiga/schedule_automation/issues)で報告

### FAQ

**Q: インターネット接続は必要ですか？**
A: 初回読み込み時にExcelJSライブラリをCDNから取得するため、インターネット接続が必要です。その後はオフラインで動作します。

**Q: データはサーバーに送信されますか？**
A: いいえ。すべての処理はブラウザ内で完結し、データは一切外部に送信されません。

**Q: 生徒情報は必須ですか？**
A: いいえ。生徒情報がない場合は講師のみを割り当てます。

**Q: 複数の週をまとめて処理できますか？**
A: はい、v1.4から複数シート対応により、週ごとに分かれたExcelファイルを自動的に統合して処理できます。全シートのデータが自動的に読み込まれ、日付順にソートされます。

---

## 📄 ライセンス

MIT License - 詳細は[LICENSE](LICENSE)を参照

---

## 👥 貢献者

- [@Nishi-Taiga](https://github.com/Nishi-Taiga) - 開発・メンテナンス

---

## 🙏 謝辞

- [ExcelJS](https://github.com/exceljs/exceljs) - Excelファイルの読み書きライブラリ
- すべての貢献者とユーザーの皆様

---

**Built with ❤️ for 個別指導塾**
